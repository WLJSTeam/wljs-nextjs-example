function ___$insertStyle(e){if(e&&"undefined"!=typeof window){var t=document.createElement("style");return t.setAttribute("type","text/css"),t.innerHTML=e,document.head.appendChild(t),e}}function colorToString(e,t){var r=e.__state.conversionName.toString(),o=Math.round(e.r),n=Math.round(e.g),a=Math.round(e.b),i=e.a,s=Math.round(e.h),l=e.s.toFixed(1),c=e.v.toFixed(1);if(t||"THREE_CHAR_HEX"===r||"SIX_CHAR_HEX"===r){for(var d=e.hex.toString(16);d.length<6;)d="0"+d;return"#"+d}return"CSS_RGB"===r?"rgb("+o+","+n+","+a+")":"CSS_RGBA"===r?"rgba("+o+","+n+","+a+","+i+")":"HEX"===r?"0x"+e.hex.toString(16):"RGB_ARRAY"===r?"["+o+","+n+","+a+"]":"RGBA_ARRAY"===r?"["+o+","+n+","+a+","+i+"]":"RGB_OBJ"===r?"{r:"+o+",g:"+n+",b:"+a+"}":"RGBA_OBJ"===r?"{r:"+o+",g:"+n+",b:"+a+",a:"+i+"}":"HSV_OBJ"===r?"{h:"+s+",s:"+l+",v:"+c+"}":"HSVA_OBJ"===r?"{h:"+s+",s:"+l+",v:"+c+",a:"+i+"}":"unknown format"}var ARR_EACH=Array.prototype.forEach,ARR_SLICE=Array.prototype.slice,Common={BREAK:{},extend:function(e){return this.each(ARR_SLICE.call(arguments,1),function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(r){this.isUndefined(t[r])||(e[r]=t[r])}.bind(this))},this),e},defaults:function(e){return this.each(ARR_SLICE.call(arguments,1),function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(r){this.isUndefined(e[r])&&(e[r]=t[r])}.bind(this))},this),e},compose:function(){var e=ARR_SLICE.call(arguments);return function(){for(var t=ARR_SLICE.call(arguments),r=e.length-1;r>=0;r--)t=[e[r].apply(this,t)];return t[0]}},each:function(e,t,r){if(e)if(ARR_EACH&&e.forEach&&e.forEach===ARR_EACH)e.forEach(t,r);else if(e.length===e.length+0){var o,n=void 0;for(n=0,o=e.length;n<o;n++)if(n in e&&t.call(r,e[n],n)===this.BREAK)return}else for(var a in e)if(t.call(r,e[a],a)===this.BREAK)return},defer:function(e){setTimeout(e,0)},debounce:function(e,t,r){var o=void 0;return function(){var n=this,a=arguments;var i=r||!o;clearTimeout(o),o=setTimeout(function(){o=null,r||e.apply(n,a)},t),i&&e.apply(n,a)}},toArray:function(e){return e.toArray?e.toArray():ARR_SLICE.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){return isNaN(e)}),isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return e instanceof Function}},INTERPRETATIONS=[{litmus:Common.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:colorToString},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:colorToString},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:colorToString},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:colorToString}}},{litmus:Common.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:Common.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:Common.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(Common.isNumber(e.r)&&Common.isNumber(e.g)&&Common.isNumber(e.b)&&Common.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(Common.isNumber(e.r)&&Common.isNumber(e.g)&&Common.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(Common.isNumber(e.h)&&Common.isNumber(e.s)&&Common.isNumber(e.v)&&Common.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(Common.isNumber(e.h)&&Common.isNumber(e.s)&&Common.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],result=void 0,toReturn=void 0,interpret=function(){toReturn=!1;var e=arguments.length>1?Common.toArray(arguments):arguments[0];return Common.each(INTERPRETATIONS,function(t){if(t.litmus(e))return Common.each(t.conversions,function(t,r){if(result=t.read(e),!1===toReturn&&!1!==result)return toReturn=result,result.conversionName=r,result.conversion=t,Common.BREAK}),Common.BREAK}),toReturn},tmpComponent=void 0,ColorMath={hsv_to_rgb:function(e,t,r){var o=Math.floor(e/60)%6,n=e/60-Math.floor(e/60),a=r*(1-t),i=r*(1-n*t),s=r*(1-(1-n)*t),l=[[r,s,a],[i,r,a],[a,r,s],[a,i,r],[s,a,r],[r,a,i]][o];return{r:255*l[0],g:255*l[1],b:255*l[2]}},rgb_to_hsv:function(e,t,r){var o=Math.min(e,t,r),n=Math.max(e,t,r),a=n-o,i=void 0;return 0===n?{h:NaN,s:0,v:0}:(i=e===n?(t-r)/a:t===n?2+(r-e)/a:4+(e-t)/a,(i/=6)<0&&(i+=1),{h:360*i,s:a/n,v:n/255})},rgb_to_hex:function(e,t,r){var o=this.hex_with_component(0,2,e);return o=this.hex_with_component(o,1,t),o=this.hex_with_component(o,0,r)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(e,t,r){return r<<(tmpComponent=8*t)|e&~(255<<tmpComponent)}},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),get=function e(t,r,o){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,o)}if("value"in n)return n.value;var i=n.get;return void 0!==i?i.call(o):void 0},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},Color=function(){function e(){if(classCallCheck(this,e),this.__state=interpret.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return createClass(e,[{key:"toString",value:function(){return colorToString(this)}},{key:"toHexString",value:function(){return colorToString(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),e}();function defineRGBComponent(e,t,r){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space||Color.recalculateRGB(this,t,r),this.__state[t]},set:function(e){"RGB"!==this.__state.space&&(Color.recalculateRGB(this,t,r),this.__state.space="RGB"),this.__state[t]=e}})}function defineHSVComponent(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space||Color.recalculateHSV(this),this.__state[t]},set:function(e){"HSV"!==this.__state.space&&(Color.recalculateHSV(this),this.__state.space="HSV"),this.__state[t]=e}})}Color.recalculateRGB=function(e,t,r){if("HEX"===e.__state.space)e.__state[t]=ColorMath.component_from_hex(e.__state.hex,r);else{if("HSV"!==e.__state.space)throw new Error("Corrupted color state");Common.extend(e.__state,ColorMath.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}},Color.recalculateHSV=function(e){var t=ColorMath.rgb_to_hsv(e.r,e.g,e.b);Common.extend(e.__state,{s:t.s,v:t.v}),Common.isNaN(t.h)?Common.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=t.h},Color.COMPONENTS=["r","g","b","h","s","v","hex","a"],defineRGBComponent(Color.prototype,"r",2),defineRGBComponent(Color.prototype,"g",1),defineRGBComponent(Color.prototype,"b",0),defineHSVComponent(Color.prototype,"h"),defineHSVComponent(Color.prototype,"s"),defineHSVComponent(Color.prototype,"v"),Object.defineProperty(Color.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(Color.prototype,"hex",{get:function(){return"HEX"!==this.__state.space&&(this.__state.hex=ColorMath.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var Controller=function(){function e(t,r){classCallCheck(this,e),this.initialValue=t[r],this.domElement=document.createElement("div"),this.object=t,this.property=r,this.__onChange=void 0,this.__onFinishChange=void 0}return createClass(e,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),e}(),EVENT_MAP={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},EVENT_MAP_INV={};Common.each(EVENT_MAP,function(e,t){Common.each(e,function(e){EVENT_MAP_INV[e]=t})});var CSS_VALUE_PIXELS=/(\d+(\.\d+)?)px/;function cssValueToPixels(e){if("0"===e||Common.isUndefined(e))return 0;var t=e.match(CSS_VALUE_PIXELS);return Common.isNull(t)?0:parseFloat(t[1])}var dom={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,r){var o=r,n=t;Common.isUndefined(n)&&(n=!0),Common.isUndefined(o)&&(o=!0),e.style.position="absolute",n&&(e.style.left=0,e.style.right=0),o&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,r,o){var n=r||{},a=EVENT_MAP_INV[t];if(!a)throw new Error("Event type "+t+" not supported.");var i=document.createEvent(a);switch(a){case"MouseEvents":var s=n.x||n.clientX||0,l=n.y||n.clientY||0;i.initMouseEvent(t,n.bubbles||!1,n.cancelable||!0,window,n.clickCount||1,0,0,s,l,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var c=i.initKeyboardEvent||i.initKeyEvent;Common.defaults(n,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),c(t,n.bubbles||!1,n.cancelable,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);break;default:i.initEvent(t,n.bubbles||!1,n.cancelable||!0)}Common.defaults(i,o),e.dispatchEvent(i)},bind:function(e,t,r,o){var n=o||!1;return e.addEventListener?e.addEventListener(t,r,n):e.attachEvent&&e.attachEvent("on"+t,r),dom},unbind:function(e,t,r,o){var n=o||!1;return e.removeEventListener?e.removeEventListener(t,r,n):e.detachEvent&&e.detachEvent("on"+t,r),dom},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var r=e.className.split(/ +/);-1===r.indexOf(t)&&(r.push(t),e.className=r.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return dom},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var r=e.className.split(/ +/),o=r.indexOf(t);-1!==o&&(r.splice(o,1),e.className=r.join(" "))}else e.className=void 0;return dom},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return cssValueToPixels(t["border-left-width"])+cssValueToPixels(t["border-right-width"])+cssValueToPixels(t["padding-left"])+cssValueToPixels(t["padding-right"])+cssValueToPixels(t.width)},getHeight:function(e){var t=getComputedStyle(e);return cssValueToPixels(t["border-top-width"])+cssValueToPixels(t["border-bottom-width"])+cssValueToPixels(t["padding-top"])+cssValueToPixels(t["padding-bottom"])+cssValueToPixels(t.height)},getOffset:function(e){var t=e,r={left:0,top:0};if(t.offsetParent)do{r.left+=t.offsetLeft,r.top+=t.offsetTop,t=t.offsetParent}while(t);return r},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},BooleanController=function(e){function t(e,r){classCallCheck(this,t);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r)),n=o;return o.__prev=o.getValue(),o.__checkbox=document.createElement("input"),o.__checkbox.setAttribute("type","checkbox"),dom.bind(o.__checkbox,"change",function(){n.setValue(!n.__prev)},!1),o.domElement.appendChild(o.__checkbox),o.updateDisplay(),o}return inherits(t,Controller),createClass(t,[{key:"setValue",value:function(e){var r=get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),r}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(),OptionController=function(e){function t(e,r,o){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r)),a=o,i=n;if(n.__select=document.createElement("select"),Common.isArray(a)){var s={};Common.each(a,function(e){s[e]=e}),a=s}return Common.each(a,function(e,t){var r=document.createElement("option");r.innerHTML=t,r.setAttribute("value",e),i.__select.appendChild(r)}),n.updateDisplay(),dom.bind(n.__select,"change",function(){var e=this.options[this.selectedIndex].value;i.setValue(e)}),n.domElement.appendChild(n.__select),n}return inherits(t,Controller),createClass(t,[{key:"setValue",value:function(e){var r=get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),r}},{key:"updateDisplay",value:function(){return dom.isActive(this.__select)?this:(this.__select.value=this.getValue(),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this))}}]),t}(),StringController=function(e){function t(e,r){classCallCheck(this,t);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r)),n=o;function a(){n.setValue(n.__input.value)}return o.__input=document.createElement("input"),o.__input.setAttribute("type","text"),dom.bind(o.__input,"keyup",a),dom.bind(o.__input,"change",a),dom.bind(o.__input,"blur",function(){n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())}),dom.bind(o.__input,"keydown",function(e){13===e.keyCode&&this.blur()}),o.updateDisplay(),o.domElement.appendChild(o.__input),o}return inherits(t,Controller),createClass(t,[{key:"updateDisplay",value:function(){return dom.isActive(this.__input)||(this.__input.value=this.getValue()),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}();function numDecimals(e){var t=e.toString();return t.indexOf(".")>-1?t.length-t.indexOf(".")-1:0}var NumberController=function(e){function t(e,r,o){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r)),a=o||{};return n.__min=a.min,n.__max=a.max,n.__step=a.step,Common.isUndefined(n.__step)?0===n.initialValue?n.__impliedStep=1:n.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(n.initialValue))/Math.LN10))/10:n.__impliedStep=n.__step,n.__precision=numDecimals(n.__impliedStep),n}return inherits(t,Controller),createClass(t,[{key:"setValue",value:function(e){var r=e;return void 0!==this.__min&&r<this.__min?r=this.__min:void 0!==this.__max&&r>this.__max&&(r=this.__max),void 0!==this.__step&&r%this.__step!==0&&(r=Math.round(r/this.__step)*this.__step),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,r)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=numDecimals(e),this}}]),t}();function roundToDecimal(e,t){var r=Math.pow(10,t);return Math.round(e*r)/r}var NumberControllerBox=function(e){function t(e,r,o){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,o));n.__truncationSuspended=!1;var a=n,i=void 0;function s(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function l(e){var t=i-e.clientY;a.setValue(a.getValue()+t*a.__impliedStep),i=e.clientY}function c(){dom.unbind(window,"mousemove",l),dom.unbind(window,"mouseup",c),s()}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),dom.bind(n.__input,"change",function(){var e=parseFloat(a.__input.value);Common.isNaN(e)||a.setValue(e)}),dom.bind(n.__input,"blur",function(){s()}),dom.bind(n.__input,"mousedown",function(e){dom.bind(window,"mousemove",l),dom.bind(window,"mouseup",c),i=e.clientY}),dom.bind(n.__input,"keydown",function(e){13===e.keyCode&&(a.__truncationSuspended=!0,this.blur(),a.__truncationSuspended=!1,s())}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return inherits(t,NumberController),createClass(t,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():roundToDecimal(this.getValue(),this.__precision),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}();function map(e,t,r,o,n){return o+(e-t)/(r-t)*(n-o)}var NumberControllerSlider=function(e){function t(e,r,o,n,a){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,{min:o,max:n,step:a})),s=i;function l(e){e.preventDefault();var t=s.__background.getBoundingClientRect();return s.setValue(map(e.clientX,t.left,t.right,s.__min,s.__max)),!1}function c(){dom.unbind(window,"mousemove",l),dom.unbind(window,"mouseup",c),s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}function d(e){var t=e.touches[0].clientX,r=s.__background.getBoundingClientRect();s.setValue(map(t,r.left,r.right,s.__min,s.__max))}function u(){dom.unbind(window,"touchmove",d),dom.unbind(window,"touchend",u),s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}return i.__background=document.createElement("div"),i.__foreground=document.createElement("div"),dom.bind(i.__background,"mousedown",function(e){document.activeElement.blur(),dom.bind(window,"mousemove",l),dom.bind(window,"mouseup",c),l(e)}),dom.bind(i.__background,"touchstart",function(e){if(1!==e.touches.length)return;dom.bind(window,"touchmove",d),dom.bind(window,"touchend",u),d(e)}),dom.addClass(i.__background,"slider"),dom.addClass(i.__foreground,"slider-fg"),i.updateDisplay(),i.__background.appendChild(i.__foreground),i.domElement.appendChild(i.__background),i}return inherits(t,NumberController),createClass(t,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(),FunctionController=function(e){function t(e,r,o){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r)),a=n;return n.__button=document.createElement("div"),n.__button.innerHTML=void 0===o?"Fire":o,dom.bind(n.__button,"click",function(e){return e.preventDefault(),a.fire(),!1}),dom.addClass(n.__button,"button"),n.domElement.appendChild(n.__button),n}return inherits(t,Controller),createClass(t,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),t}(),ColorController=function(e){function t(e,r){classCallCheck(this,t);var o=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));o.__color=new Color(o.getValue()),o.__temp=new Color(0);var n=o;o.domElement=document.createElement("div"),dom.makeSelectable(o.domElement,!1),o.__selector=document.createElement("div"),o.__selector.className="selector",o.__saturation_field=document.createElement("div"),o.__saturation_field.className="saturation-field",o.__field_knob=document.createElement("div"),o.__field_knob.className="field-knob",o.__field_knob_border="2px solid ",o.__hue_knob=document.createElement("div"),o.__hue_knob.className="hue-knob",o.__hue_field=document.createElement("div"),o.__hue_field.className="hue-field",o.__input=document.createElement("input"),o.__input.type="text",o.__input_textShadow="0 1px 1px ",dom.bind(o.__input,"keydown",function(e){13===e.keyCode&&d.call(this)}),dom.bind(o.__input,"blur",d),dom.bind(o.__selector,"mousedown",function(){dom.addClass(this,"drag").bind(window,"mouseup",function(){dom.removeClass(n.__selector,"drag")})}),dom.bind(o.__selector,"touchstart",function(){dom.addClass(this,"drag").bind(window,"touchend",function(){dom.removeClass(n.__selector,"drag")})});var a=document.createElement("div");function i(e){p(e),dom.bind(window,"mousemove",p),dom.bind(window,"touchmove",p),dom.bind(window,"mouseup",l),dom.bind(window,"touchend",l)}function s(e){m(e),dom.bind(window,"mousemove",m),dom.bind(window,"touchmove",m),dom.bind(window,"mouseup",c),dom.bind(window,"touchend",c)}function l(){dom.unbind(window,"mousemove",p),dom.unbind(window,"touchmove",p),dom.unbind(window,"mouseup",l),dom.unbind(window,"touchend",l),u()}function c(){dom.unbind(window,"mousemove",m),dom.unbind(window,"touchmove",m),dom.unbind(window,"mouseup",c),dom.unbind(window,"touchend",c),u()}function d(){var e=interpret(this.value);!1!==e?(n.__color.__state=e,n.setValue(n.__color.toOriginal())):this.value=n.__color.toString()}function u(){n.__onFinishChange&&n.__onFinishChange.call(n,n.__color.toOriginal())}function p(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=n.__saturation_field.getBoundingClientRect(),r=e.touches&&e.touches[0]||e,o=r.clientX,a=r.clientY,i=(o-t.left)/(t.right-t.left),s=1-(a-t.top)/(t.bottom-t.top);return s>1?s=1:s<0&&(s=0),i>1?i=1:i<0&&(i=0),n.__color.v=s,n.__color.s=i,n.setValue(n.__color.toOriginal()),!1}function m(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=n.__hue_field.getBoundingClientRect(),r=1-((e.touches&&e.touches[0]||e).clientY-t.top)/(t.bottom-t.top);return r>1?r=1:r<0&&(r=0),n.__color.h=360*r,n.setValue(n.__color.toOriginal()),!1}return Common.extend(o.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),Common.extend(o.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:o.__field_knob_border+(o.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),Common.extend(o.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),Common.extend(o.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),Common.extend(a.style,{width:"100%",height:"100%",background:"none"}),linearGradient(a,"top","rgba(0,0,0,0)","#000"),Common.extend(o.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),hueGradient(o.__hue_field),Common.extend(o.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:o.__input_textShadow+"rgba(0,0,0,0.7)"}),dom.bind(o.__saturation_field,"mousedown",i),dom.bind(o.__saturation_field,"touchstart",i),dom.bind(o.__field_knob,"mousedown",i),dom.bind(o.__field_knob,"touchstart",i),dom.bind(o.__hue_field,"mousedown",s),dom.bind(o.__hue_field,"touchstart",s),o.__saturation_field.appendChild(a),o.__selector.appendChild(o.__field_knob),o.__selector.appendChild(o.__saturation_field),o.__selector.appendChild(o.__hue_field),o.__hue_field.appendChild(o.__hue_knob),o.domElement.appendChild(o.__input),o.domElement.appendChild(o.__selector),o.updateDisplay(),o}return inherits(t,Controller),createClass(t,[{key:"updateDisplay",value:function(){var e=interpret(this.getValue());if(!1!==e){var t=!1;Common.each(Color.COMPONENTS,function(r){if(!Common.isUndefined(e[r])&&!Common.isUndefined(this.__color.__state[r])&&e[r]!==this.__color.__state[r])return t=!0,{}},this),t&&Common.extend(this.__color.__state,e)}Common.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=this.__color.v<.5||this.__color.s>.5?255:0,o=255-r;Common.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,linearGradient(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),Common.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+o+","+o+","+o+",.7)"})}}]),t}(),vendors=["-moz-","-o-","-webkit-","-ms-",""];function linearGradient(e,t,r,o){e.style.background="",Common.each(vendors,function(n){e.style.cssText+="background: "+n+"linear-gradient("+t+", "+r+" 0%, "+o+" 100%); "})}function hueGradient(e){e.style.background="",e.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",e.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",e.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var css={load:function(e,t){var r=t||document,o=r.createElement("link");o.type="text/css",o.rel="stylesheet",o.href=e,r.getElementsByTagName("head")[0].appendChild(o)},inject:function(e,t){var r=t||document,o=document.createElement("style");o.type="text/css",o.innerHTML=e;var n=r.getElementsByTagName("head")[0];try{n.appendChild(o)}catch(e){}}},saveDialogContents='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>',ControllerFactory=function(e,t){var r=e[t];return Common.isArray(arguments[2])||Common.isObject(arguments[2])?new OptionController(e,t,arguments[2]):Common.isNumber(r)?Common.isNumber(arguments[2])&&Common.isNumber(arguments[3])?Common.isNumber(arguments[4])?new NumberControllerSlider(e,t,arguments[2],arguments[3],arguments[4]):new NumberControllerSlider(e,t,arguments[2],arguments[3]):Common.isNumber(arguments[4])?new NumberControllerBox(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new NumberControllerBox(e,t,{min:arguments[2],max:arguments[3]}):Common.isString(r)?new StringController(e,t):Common.isFunction(r)?new FunctionController(e,t,""):Common.isBoolean(r)?new BooleanController(e,t):null};function requestAnimationFrame(e){setTimeout(e,1e3/60)}var requestAnimationFrame$1=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||requestAnimationFrame,CenteredDiv=function(){function e(){classCallCheck(this,e),this.backgroundElement=document.createElement("div"),Common.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),dom.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),Common.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var t=this;dom.bind(this.backgroundElement,"click",function(){t.hide()})}return createClass(e,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),Common.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var e=this,t=function t(){e.domElement.style.display="none",e.backgroundElement.style.display="none",dom.unbind(e.domElement,"webkitTransitionEnd",t),dom.unbind(e.domElement,"transitionend",t),dom.unbind(e.domElement,"oTransitionEnd",t)};dom.bind(this.domElement,"webkitTransitionEnd",t),dom.bind(this.domElement,"transitionend",t),dom.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-dom.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-dom.getHeight(this.domElement)/2+"px"}}]),e}(),styleSheet=___$insertStyle(".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n");css.inject(styleSheet);var CSS_NAMESPACE="dg",HIDE_KEY_CODE=72,CLOSE_BUTTON_HEIGHT=20,DEFAULT_DEFAULT_PRESET_NAME="Default",SUPPORTS_LOCAL_STORAGE=function(){try{return!!window.localStorage}catch(e){return!1}}(),SAVE_DIALOGUE=void 0,autoPlaceVirgin=!0,autoPlaceContainer=void 0,hide=!1,hideableGuis=[],GUI=function e(t){var r=this,o=t||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),dom.addClass(this.domElement,CSS_NAMESPACE),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],o=Common.defaults(o,{closeOnTop:!1,autoPlace:!0,width:e.DEFAULT_WIDTH}),o=Common.defaults(o,{resizable:o.autoPlace,hideable:o.autoPlace}),Common.isUndefined(o.load)?o.load={preset:DEFAULT_DEFAULT_PRESET_NAME}:o.preset&&(o.load.preset=o.preset),Common.isUndefined(o.parent)&&o.hideable&&hideableGuis.push(this),o.resizable=Common.isUndefined(o.parent)&&o.resizable,o.autoPlace&&Common.isUndefined(o.scrollable)&&(o.scrollable=!0);var n,a=SUPPORTS_LOCAL_STORAGE&&"true"===localStorage.getItem(getLocalStorageHash(this,"isLocal")),i=void 0,s=void 0;if(Object.defineProperties(this,{parent:{get:function(){return o.parent}},scrollable:{get:function(){return o.scrollable}},autoPlace:{get:function(){return o.autoPlace}},closeOnTop:{get:function(){return o.closeOnTop}},preset:{get:function(){return r.parent?r.getRoot().preset:o.load.preset},set:function(e){r.parent?r.getRoot().preset=e:o.load.preset=e,setPresetSelectIndex(this),r.revert()}},width:{get:function(){return o.width},set:function(e){o.width=e,setWidth(r,e)}},name:{get:function(){return o.name},set:function(e){o.name=e,s&&(s.innerHTML=o.name)}},closed:{get:function(){return o.closed},set:function(t){o.closed=t,o.closed?dom.addClass(r.__ul,e.CLASS_CLOSED):dom.removeClass(r.__ul,e.CLASS_CLOSED),this.onResize(),r.__closeButton&&(r.__closeButton.innerHTML=t?e.TEXT_OPEN:e.TEXT_CLOSED)}},load:{get:function(){return o.load}},useLocalStorage:{get:function(){return a},set:function(e){SUPPORTS_LOCAL_STORAGE&&(a=e,e?dom.bind(window,"unload",i):dom.unbind(window,"unload",i),localStorage.setItem(getLocalStorageHash(r,"isLocal"),e))}}}),Common.isUndefined(o.parent)){if(this.closed=o.closed||!1,dom.addClass(this.domElement,e.CLASS_MAIN),dom.makeSelectable(this.domElement,!1),SUPPORTS_LOCAL_STORAGE&&a){r.useLocalStorage=!0;var l=localStorage.getItem(getLocalStorageHash(this,"gui"));l&&(o.load=JSON.parse(l))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=e.TEXT_CLOSED,dom.addClass(this.__closeButton,e.CLASS_CLOSE_BUTTON),o.closeOnTop?(dom.addClass(this.__closeButton,e.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(dom.addClass(this.__closeButton,e.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),dom.bind(this.__closeButton,"click",function(){r.closed=!r.closed})}else{void 0===o.closed&&(o.closed=!0);var c=document.createTextNode(o.name);dom.addClass(c,"controller-name"),s=addRow(r,c);dom.addClass(this.__ul,e.CLASS_CLOSED),dom.addClass(s,"title"),dom.bind(s,"click",function(e){return e.preventDefault(),r.closed=!r.closed,!1}),o.closed||(this.closed=!1)}o.autoPlace&&(Common.isUndefined(o.parent)&&(autoPlaceVirgin&&(autoPlaceContainer=document.createElement("div"),dom.addClass(autoPlaceContainer,CSS_NAMESPACE),dom.addClass(autoPlaceContainer,e.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(autoPlaceContainer),autoPlaceVirgin=!1),autoPlaceContainer.appendChild(this.domElement),dom.addClass(this.domElement,e.CLASS_AUTO_PLACE)),this.parent||setWidth(r,o.width)),this.__resizeHandler=function(){r.onResizeDebounced()},dom.bind(window,"resize",this.__resizeHandler),dom.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),dom.bind(this.__ul,"transitionend",this.__resizeHandler),dom.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),o.resizable&&addResizeHandle(this),i=function(){SUPPORTS_LOCAL_STORAGE&&"true"===localStorage.getItem(getLocalStorageHash(r,"isLocal"))&&localStorage.setItem(getLocalStorageHash(r,"gui"),JSON.stringify(r.getSaveObject()))},this.saveToLocalStorageIfPossible=i,o.parent||((n=r.getRoot()).width+=1,Common.defer(function(){n.width-=1}))};function addRow(e,t,r){var o=document.createElement("li");return t&&o.appendChild(t),r?e.__ul.insertBefore(o,r):e.__ul.appendChild(o),e.onResize(),o}function removeListeners(e){dom.unbind(window,"resize",e.__resizeHandler),e.saveToLocalStorageIfPossible&&dom.unbind(window,"unload",e.saveToLocalStorageIfPossible)}function markPresetModified(e,t){var r=e.__preset_select[e.__preset_select.selectedIndex];r.innerHTML=t?r.value+"*":r.value}function augmentController(e,t,r){if(r.__li=t,r.__gui=e,Common.extend(r,{options:function(t){if(arguments.length>1){var o=r.__li.nextElementSibling;return r.remove(),_add(e,r.object,r.property,{before:o,factoryArgs:[Common.toArray(arguments)]})}if(Common.isArray(t)||Common.isObject(t)){var n=r.__li.nextElementSibling;return r.remove(),_add(e,r.object,r.property,{before:n,factoryArgs:[t]})}},name:function(e){return r.__li.firstElementChild.firstElementChild.innerHTML=e,r},listen:function(){return r.__gui.listen(r),r},remove:function(){return r.__gui.remove(r),r}}),r instanceof NumberControllerSlider){var o=new NumberControllerBox(r.object,r.property,{min:r.__min,max:r.__max,step:r.__step});Common.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(e){var t=r[e],n=o[e];r[e]=o[e]=function(){var e=Array.prototype.slice.call(arguments);return n.apply(o,e),t.apply(r,e)}}),dom.addClass(t,"has-slider"),r.domElement.insertBefore(o.domElement,r.domElement.firstElementChild)}else if(r instanceof NumberControllerBox){var n=function(t){if(Common.isNumber(r.__min)&&Common.isNumber(r.__max)){var o=r.__li.firstElementChild.firstElementChild.innerHTML,n=r.__gui.__listening.indexOf(r)>-1;r.remove();var a=_add(e,r.object,r.property,{before:r.__li.nextElementSibling,factoryArgs:[r.__min,r.__max,r.__step]});return a.name(o),n&&a.listen(),a}return t};r.min=Common.compose(n,r.min),r.max=Common.compose(n,r.max)}else r instanceof BooleanController?(dom.bind(t,"click",function(){dom.fakeEvent(r.__checkbox,"click")}),dom.bind(r.__checkbox,"click",function(e){e.stopPropagation()})):r instanceof FunctionController?(dom.bind(t,"click",function(){dom.fakeEvent(r.__button,"click")}),dom.bind(t,"mouseover",function(){dom.addClass(r.__button,"hover")}),dom.bind(t,"mouseout",function(){dom.removeClass(r.__button,"hover")})):r instanceof ColorController&&(dom.addClass(t,"color"),r.updateDisplay=Common.compose(function(e){return t.style.borderLeftColor=r.__color.toString(),e},r.updateDisplay),r.updateDisplay());r.setValue=Common.compose(function(t){return e.getRoot().__preset_select&&r.isModified()&&markPresetModified(e.getRoot(),!0),t},r.setValue)}function recallSavedValue(e,t){var r=e.getRoot(),o=r.__rememberedObjects.indexOf(t.object);if(-1!==o){var n=r.__rememberedObjectIndecesToControllers[o];if(void 0===n&&(n={},r.__rememberedObjectIndecesToControllers[o]=n),n[t.property]=t,r.load&&r.load.remembered){var a=r.load.remembered,i=void 0;if(a[e.preset])i=a[e.preset];else{if(!a[DEFAULT_DEFAULT_PRESET_NAME])return;i=a[DEFAULT_DEFAULT_PRESET_NAME]}if(i[o]&&void 0!==i[o][t.property]){var s=i[o][t.property];t.initialValue=s,t.setValue(s)}}}}function _add(e,t,r,o){if(void 0===t[r])throw new Error('Object "'+t+'" has no property "'+r+'"');var n=void 0;if(o.color)n=new ColorController(t,r);else{var a=[t,r].concat(o.factoryArgs);n=ControllerFactory.apply(e,a)}o.before instanceof Controller&&(o.before=o.before.__li),recallSavedValue(e,n),dom.addClass(n.domElement,"c");var i=document.createElement("span");dom.addClass(i,"property-name"),i.innerHTML=n.property;var s=document.createElement("div");s.appendChild(i),s.appendChild(n.domElement);var l=addRow(e,s,o.before);return dom.addClass(l,GUI.CLASS_CONTROLLER_ROW),n instanceof ColorController?dom.addClass(l,"color"):dom.addClass(l,_typeof(n.getValue())),augmentController(e,l,n),e.__controllers.push(n),n}function getLocalStorageHash(e,t){return document.location.href+"."+t}function addPresetOption(e,t,r){var o=document.createElement("option");o.innerHTML=t,o.value=t,e.__preset_select.appendChild(o),r&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function showHideExplain(e,t){t.style.display=e.useLocalStorage?"block":"none"}function addSaveMenu(e){var t=e.__save_row=document.createElement("li");dom.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),dom.addClass(t,"save-row");var r=document.createElement("span");r.innerHTML="&nbsp;",dom.addClass(r,"button gears");var o=document.createElement("span");o.innerHTML="Save",dom.addClass(o,"button"),dom.addClass(o,"save");var n=document.createElement("span");n.innerHTML="New",dom.addClass(n,"button"),dom.addClass(n,"save-as");var a=document.createElement("span");a.innerHTML="Revert",dom.addClass(a,"button"),dom.addClass(a,"revert");var i=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?Common.each(e.load.remembered,function(t,r){addPresetOption(e,r,r===e.preset)}):addPresetOption(e,DEFAULT_DEFAULT_PRESET_NAME,!1),dom.bind(i,"change",function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value}),t.appendChild(i),t.appendChild(r),t.appendChild(o),t.appendChild(n),t.appendChild(a),SUPPORTS_LOCAL_STORAGE){var s=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block","true"===localStorage.getItem(getLocalStorageHash(e,"isLocal"))&&l.setAttribute("checked","checked"),showHideExplain(e,s),dom.bind(l,"change",function(){e.useLocalStorage=!e.useLocalStorage,showHideExplain(e,s)})}var c=document.getElementById("dg-new-constructor");dom.bind(c,"keydown",function(e){!e.metaKey||67!==e.which&&67!==e.keyCode||SAVE_DIALOGUE.hide()}),dom.bind(r,"click",function(){c.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),SAVE_DIALOGUE.show(),c.focus(),c.select()}),dom.bind(o,"click",function(){e.save()}),dom.bind(n,"click",function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)}),dom.bind(a,"click",function(){e.revert()})}function addResizeHandle(e){var t=void 0;function r(r){return r.preventDefault(),e.width+=t-r.clientX,e.onResize(),t=r.clientX,!1}function o(){dom.removeClass(e.__closeButton,GUI.CLASS_DRAG),dom.unbind(window,"mousemove",r),dom.unbind(window,"mouseup",o)}function n(n){return n.preventDefault(),t=n.clientX,dom.addClass(e.__closeButton,GUI.CLASS_DRAG),dom.bind(window,"mousemove",r),dom.bind(window,"mouseup",o),!1}e.__resize_handle=document.createElement("div"),Common.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),dom.bind(e.__resize_handle,"mousedown",n),dom.bind(e.__closeButton,"mousedown",n),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function setWidth(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function getCurrentPreset(e,t){var r={};return Common.each(e.__rememberedObjects,function(o,n){var a={},i=e.__rememberedObjectIndecesToControllers[n];Common.each(i,function(e,r){a[r]=t?e.initialValue:e.getValue()}),r[n]=a}),r}function setPresetSelectIndex(e){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].value===e.preset&&(e.__preset_select.selectedIndex=t)}function updateDisplays(e){0!==e.length&&requestAnimationFrame$1.call(window,function(){updateDisplays(e)}),Common.each(e,function(e){e.updateDisplay()})}GUI.toggleHide=function(){hide=!hide,Common.each(hideableGuis,function(e){e.domElement.style.display=hide?"none":""})},GUI.CLASS_AUTO_PLACE="a",GUI.CLASS_AUTO_PLACE_CONTAINER="ac",GUI.CLASS_MAIN="main",GUI.CLASS_CONTROLLER_ROW="cr",GUI.CLASS_TOO_TALL="taller-than-window",GUI.CLASS_CLOSED="closed",GUI.CLASS_CLOSE_BUTTON="close-button",GUI.CLASS_CLOSE_TOP="close-top",GUI.CLASS_CLOSE_BOTTOM="close-bottom",GUI.CLASS_DRAG="drag",GUI.DEFAULT_WIDTH=245,GUI.TEXT_CLOSED="Close Controls",GUI.TEXT_OPEN="Open Controls",GUI._keydownHandler=function(e){"text"===document.activeElement.type||e.which!==HIDE_KEY_CODE&&e.keyCode!==HIDE_KEY_CODE||GUI.toggleHide()},dom.bind(window,"keydown",GUI._keydownHandler,!1),Common.extend(GUI.prototype,{add:function(e,t){return _add(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return _add(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;Common.defer(function(){t.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&autoPlaceContainer.removeChild(this.domElement);var e=this;Common.each(this.__folders,function(t){e.removeFolder(t)}),dom.unbind(window,"keydown",GUI._keydownHandler,!1),removeListeners(this)},addFolder:function(e){if(void 0!==this.__folders[e])throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var r=new GUI(t);this.__folders[e]=r;var o=addRow(this,r.domElement);return dom.addClass(o,"folder"),r},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],removeListeners(e);var t=this;Common.each(e.__folders,function(t){e.removeFolder(t)}),Common.defer(function(){t.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=dom.getOffset(e.__ul).top,r=0;Common.each(e.__ul.childNodes,function(t){e.autoPlace&&t===e.__save_row||(r+=dom.getHeight(t))}),window.innerHeight-t-CLOSE_BUTTON_HEIGHT<r?(dom.addClass(e.domElement,GUI.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-CLOSE_BUTTON_HEIGHT+"px"):(dom.removeClass(e.domElement,GUI.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&Common.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:Common.debounce(function(){this.onResize()},50),remember:function(){if(Common.isUndefined(SAVE_DIALOGUE)&&((SAVE_DIALOGUE=new CenteredDiv).domElement.innerHTML=saveDialogContents),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;Common.each(Array.prototype.slice.call(arguments),function(t){0===e.__rememberedObjects.length&&addSaveMenu(e),-1===e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)}),this.autoPlace&&setWidth(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=getCurrentPreset(this)),e.folders={},Common.each(this.__folders,function(t,r){e.folders[r]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=getCurrentPreset(this),markPresetModified(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[DEFAULT_DEFAULT_PRESET_NAME]=getCurrentPreset(this,!0)),this.load.remembered[e]=getCurrentPreset(this),this.preset=e,addPresetOption(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){Common.each(this.__controllers,function(t){this.getRoot().load.remembered?recallSavedValue(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())},this),Common.each(this.__folders,function(e){e.revert(e)}),e||markPresetModified(this.getRoot(),!1)},listen:function(e){var t=0===this.__listening.length;this.__listening.push(e),t&&updateDisplays(this.__listening)},updateDisplay:function(){Common.each(this.__controllers,function(e){e.updateDisplay()}),Common.each(this.__folders,function(e){e.updateDisplay()})}});var GUI$1=GUI,node={};Object.defineProperty(node,"__esModule",{value:!0});var default_1=node.default=void 0;const t1=6/29,t2=3*t1*t1,lrgb2rgb=e=>Math.round(255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055))||0,lab2xyz=e=>e>t1?e*e*e:t2*(e-4/29);var _default=({luminance:e,a:t,b:r})=>{const o=(e+16)/116,n=.96422*lab2xyz(o+t/500),a=Number(lab2xyz(o)),i=.82521*lab2xyz(o-r/200);return{red:lrgb2rgb(3.1338561*n-1.6168667*a-.4906146*i),green:lrgb2rgb(-.9787684*n+1.9161415*a+.033454*i),blue:lrgb2rgb(.0719453*n-.2289914*a+1.4052427*i)}};function arrdims(e){return 0===e.length?0:void 0===e[0].length?1:void 0===e[0][0].length?2:void 0===e[0][0][0].length?3:void 0}default_1=node.default=_default,core.PlotInteractivity=()=>"PlotInteractivity",core["Charting`DateTicksFunction"]=()=>"DateTicksFunction",core["Charting`ScaledTicks"]=(e,t)=>({type:"ScaledTicks",args:e}),core["Charting`ScaledFrameTicks"]=(e,t)=>({type:"ScaledFrameTicks",args:e}),core.DateListPlot=()=>{},core["Graphics`DPR"]=()=>window.devicePixelRatio,core["Graphics`CaptureImage64"]=async(e,t)=>{const r=t.element,o=new Deferred,n=r.getBoundingClientRect();return electronAPI.requestScreenshot({x:Math.round(n.x),y:Math.round(n.y),width:Math.round(n.width),height:Math.round(n.height)},e=>{o.resolve(e.slice(22))}),o.promise};let d3=!1,interpolatePath=!1,g2d={name:"WebObjects/Graphics"};const g2dComplex={};async function processLabel(e,t,r,o,n){let a=e,i=!1,s=[0,0];if(console.warn(a),"None"!=a){if(Array.isArray(a))if("HoldForm"==a[0]){if(Array.isArray(a[1])&&"List"==a[1][0]){const e=await interpretate(a[1][2],r);a=["HoldForm",a[1][1]],Array.isArray(e)&&(s=e)}"string"==typeof a[1]&&"'"==a[1].charAt(0)?(i=!1,a=a[1]):i=!0}else if("List"==a[0]){const e=await interpretate(a[2],r);a=a[1],"HoldForm"==a[0]&&("string"==typeof a[1]&&"'"==a[1].charAt(0)?(i=!1,a=a[1]):i=!0),Array.isArray(e)&&(s=e)}if(!i)try{return void o(await interpretate(a,r),s)}catch(e){console.warn("Err:",e),i=!0}if(i){console.warn("x-label: fallback to EditorView");n(await interpretate(["Inset",a,["JSObject",[r.xAxis.invert(0),r.yAxis.invert(0)]]],{...r,context:g2d,svg:t}),s)}}}g2dComplex.name="GraphicsComplex 2D",g2d.Pane=async(e,t)=>{throw e},interpretate.contextExpand(g2d),["FaceForm","ImageSizeAction","ImageSizeRaw","Selectable","ViewMatrix","CurrentValue","FontColor","Tiny","VertexColors","Antialiasing","Small","Plot","ListCurvePathPlot","ListLinePlot","ListPlot","Automatic","Controls","All","TickLabels","FrameTicksStyle","AlignmentPoint","AspectRatio","Axes","AxesLabel","AxesOrigin","AxesStyle","Background","BaselinePosition","BaseStyle","ColorOutput","ContentSelectable","CoordinatesToolOptions","DisplayFunction","Epilog","FormatType","Frame","FrameLabel","FrameStyle","FrameTicks","FrameTicksStyle","GridLines","GridLinesStyle","ImageMargins","ImagePadding","ImageSize","Full","LabelStyle","Method","PlotLabel","PlotRange","PlotRangeClipping","PlotRangePadding","PlotRegion","PreserveImageOptions","Prolog","RotateLabel","Ticks","TicksStyle","TransitionDuration"].map(e=>{g2d[e]=()=>e,g2d[e].update=()=>e}),g2d.Spacer=()=>{},core.GoldenRatio=()=>1.618,g2d["Graphics`Canvas"]=async(e,t)=>{let r={k:1,x:0,y:0};t.onZoom.push(e=>{r=e});const o={xAxis:t.xAxis,yAxis:t.yAxis};return t.xAxis=e=>0,t.yAxis=e=>0,t.xAxis.invert=e=>{const n=(e-r.x-t.panZoomEntites.left)/r.k;return o.xAxis.invert(n)},t.yAxis.invert=e=>{const n=(e-r.y-t.panZoomEntites.top)/r.k;return o.yAxis.invert(n)},t.panZoomEntites.canvas},g2d.HoldForm=async(e,t)=>await interpretate(e[0],t),g2d.HoldForm.update=async(e,t)=>await interpretate(e[0],t),g2d.SVGGroup=async(e,t)=>{const r=t.svg.append("g");r.attr("opacity",t.opacity);const o={...t};return o.svg=r,o.offset={x:0,y:0},o.color="rgb(68, 68, 68)",o.stroke=void 0,o.opacity=1,o.fontsize=10,o.fontfamily="sans-serif",o.strokeWidth=1.5,o.pointSize=.023,o.arrowHead=1,delete o.opacityRefs,delete o.colorRefs,t.local.group=r,await interpretate(e[0],o),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),r},g2d.SVGGroup.virtual=!0,g2d.SVGGroup.update=async(e,t)=>{},g2d.SVGGroup.updateOpacity=(e,t)=>{t.local.group.attr("opacity",t.opacity)},g2d.SVGGroup.destroy=(e,t)=>{t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.group.remove()},g2d.Scale=async(e,t)=>{const r=await interpretate(e[1],t),o=t.svg.append("g");let n;e.length>2&&(n=await interpretate(e[2],t)),t.local.group=o,await interpretate(e[0],{...t,svg:o});let a,i=o.node().getBBox();return n?(i.x=t.xAxis(n[0]),i.y=t.yAxis(n[1])):(i.x=i.x+i.width/2,i.y=i.y+i.height/2),t.local.aligment=n,"number"==typeof r?a=`translate(${i.x}, ${i.y}) scale(${r}) translate(${-i.x}, ${-i.y})`:Array.isArray(r)&&(a=`translate(${i.x}, ${i.y}) scale(${r[0]}, ${r[1]}) translate(${-i.x}, ${-i.y})`),t.local.scale=a,a&&o.attr("transform",a),o},g2d.Scale.update=async(e,t)=>{let r=await interpretate(e[1],t);r instanceof NumericArrayObject&&(r=r.normal());let o=t.local.aligment;let n,a;n=t.local.group.node().getBBox(),o?(n.x=t.xAxis(o[0]),n.y=t.yAxis(o[1])):(n.x=n.x+n.width/2,n.y=n.y+n.height/2),"number"==typeof r?a=`translate(${n.x}, ${n.y}) scale(${r}) translate(${-n.x}, ${-n.y})`:Array.isArray(r)&&(a=`translate(${n.x}, ${n.y}) scale(${r[0]}, ${r[1]}) translate(${-n.x}, ${-n.y})`);var i=d3.interpolateString(t.local.scale,a);return t.local.group.maybeTransitionTween(t.transitionType,t.transitionDuration,"transform",function(e,t,r){return i}),t.local.scale=a,t.local.group},g2d.Scale.virtual=!0,g2d.Scale.destroy=(e,t)=>{console.log("nothing to destroy")},g2d.NamespaceBox=async(e,t)=>await interpretate(e[1],t),g2d.DynamicModuleBox=async(e,t)=>await interpretate(e[1],t),g2d.TagBox=async(e,t)=>await interpretate(e[0],t),g2d.DynamicModule=async(e,t)=>await interpretate(e[1],t),g2d["Charting`DelayedClickEffect"]=async(e,t)=>await interpretate(e[0],t),g2d.ColorProfileData=()=>{},g2d.ParametricPlot=()=>{},g2d.TransitionDuration=()=>"TransitionDuration",g2d.TransitionType=()=>"TransitionType";var assignTransition=e=>{if("transitiontype"in e)switch(e.transitiontype){case"Linear":e.transitionType=d3.easeLinear;break;case"CubicInOut":e.transitionType=d3.easeCubicInOut;break;default:e.transitionType=!1}e.transitionduration&&(e.transitionDuration=e.transitionduration)};const makeEditorView=async(e,t={global:{}})=>{const r=String(interpretate.hash(e));let o,n;if(r in ObjectHashMap)o=ObjectHashMap[r];else{o=new ObjectStorage(r);try{n=await o.get()}catch(t){console.warn("Creating FE object by id "+r),await server.kernel.io.fetch("CoffeeLiqueur`Extensions`Graphics`Private`MakeExpressionBox",[JSON.stringify(e),r]),n=await o.get()}}n||(n=await o.get()),console.log("g2d: creating an object"),console.log("frontend executable");const a=t,i=new ExecutableObject("g2d-embeded-"+uuidv4(),a,n,!0);return i.assignScope(a),o.assign(i),await i.execute(),i};let assignProto;function niceNumber(e){if("string"==typeof e)return e;if("number"!=typeof e||!isFinite(e))return String(e);if(Number.isInteger(e))return String(e);const t=trimFixed(e.toFixed(2)),r=[];for(let t=0;t<=4;t++){const o=exponentialToSuperscript(e.toExponential(t));r.push(o)}const o=shortest(r);return o.length<t.length?o:t}function trimFixed(e){return/^-?0(?:\.0+)?$/.test(e)?"0":e=(e=e.replace(/(\.\d*?[1-9])0+$/,"$1")).replace(/\.0+$/,"")}function exponentialToSuperscript(e){const t=/^(-?\d+(?:\.\d+)?)[eE]([+\-]?\d+)$/.exec(e);if(!t)return e;let r=t[1],o=t[2];r=r.replace(/(\.\d*?[1-9])0+$/,"$1").replace(/\.0+$/,""),/^-?0(?:\.0+)?$/.test(r)&&(r="0");let n=o.startsWith("-")?"-":o.startsWith("+")?"+":"",a=o.replace(/^[+\-]?0+/,"");""===a&&(a="0");return`${r}10${toSuperscript(n+a)}`}g2d.Offset=async(e,t)=>{if(e.length<2){const r=await interpretate(e[0],t);return[t.xAxis.invert(r[0])-t.xAxis.invert(0),t.yAxis.invert(r[1])-t.yAxis.invert(0)]}const r=await interpretate(e[1],t),o={x:r[0],y:r[1]},n=await interpretate(e[0],{...t,offset:o});if(Array.isArray(n)){return[t.xAxis.invert(n[0])-t.xAxis.invert(0)+o.x,t.xAxis.invert(n[1])+o.y-t.xAxis.invert(0)]}return n},g2d.Offset.update=g2d.Offset,g2d.Dashing=async(e,t)=>{const r=await interpretate(e[0],t);Array.isArray(r)&&0==r[0]?t.dasharray=[2,2]:t.dasharray=[2,0,0,0,2]},g2d.AbsoluteDashing=async(e,t)=>{const r=await interpretate(e[0],t);t.dasharray=r},assignProto=()=>{d3.selection.prototype.maybeTransition=function(e,t){return e?this.transition().ease(e).duration(t):this},d3.selection.prototype.maybeTransitionTween=function(e,t,r,o){return e?this.transition().ease(e).duration(t).attrTween(r,o):this.attr(r,o.apply(this.node(),this.data())(1))},assignProto=()=>{}};const SUP={0:"",1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"","+":"","-":""};function toSuperscript(e){return[...e].map(e=>SUP[e]??e).join("")}function shortest(e){return e.reduce((e,t)=>t.length<e.length?t:e)}g2d.Complex=async(e,t)=>{console.warn("Complex numbers are only supported as decoration");const r=await interpretate(e[0],t),o=await interpretate(e[1],t);return 0==r?1==o?"i":-1==o?"-i":o<0?"- i "+niceNumber(Math.abs(o)):"i "+niceNumber(o):1==o?niceNumber(r)+" + i":-1==o?niceNumber(r)+" - i":o<0?niceNumber(r)+" - i"+niceNumber(Math.abs(o)):niceNumber(r)+" + i"+niceNumber(o)},g2d.Graphics=async(args,env)=>{await interpretate.shared.d3.load(),d3||(d3=interpretate.shared.d3.d3),interpolatePath||(interpolatePath=interpretate.shared.d3["d3-interpolate-path"].interpolatePath),g2d.interpolatePath=interpolatePath,g2d.d3=d3,assignProto();let options=await core._getRulesReversed(args,{...env,context:g2d,hold:!0});if(0==Object.keys(options).length&&args.length>1)if("List"===args[1][0]){const e=args[1].slice(1);options="List"===e[0][0]?await core._getRulesReversed(e[0].slice(1),{...env,context:g2d,hold:!0}):await core._getRulesReversed(e,{...env,context:g2d,hold:!0})}else options=await core._getRulesReversed(await interpretate(args[1],{...env,context:g2d,hold:!0}),{...env,context:g2d,hold:!0});console.log(options);let label=options.PlotLabel;var container=env.element;let ImageSize=await interpretate(options.ImageSize,{...env,context:g2d});"number"==typeof ImageSize?ImageSize<1&&(ImageSize=1e4*ImageSize/2):"string"==typeof ImageSize&&(ImageSize=core.DefaultWidth),ImageSize||(ImageSize=env.imageSize?Array.isArray(env.imageSize)?env.imageSize:[env.imageSize,.618034*env.imageSize]:core.DefaultWidth);let rawImage=!1;if(options.ImageSizeRaw){const e=await interpretate(options.ImageSizeRaw,env);Array.isArray(e)?"number"==typeof e[0]&&"number"==typeof e[1]&&(ImageSize=e.map(e=>e/window.devicePixelRatio),rawImage=!0):"number"==typeof e&&(ImageSize=[e/window.devicePixelRatio,.618034*e/window.devicePixelRatio],rawImage=!0)}let tinyGraph=!1;ImageSize instanceof Array?ImageSize[0]<100&&!options.PaddingIsImportant&&(tinyGraph=!0):ImageSize<100&&!options.PaddingIsImportant&&(tinyGraph=!0);let axis=[!1,!1],invertedTicks=!1,ticklengths=[5,5,5,5],tickLabels=[!0,!1,!0,!1],ticks,framed=!1,axesstyle,ticksstyle;if(console.log(options),options.Frame&&!tinyGraph&&(options.Frame=await interpretate(options.Frame,env),!0===options.Frame?framed=!0:(!0===options.Frame[0][0]&&(framed=!0),!0===options.Frame[0]&&(framed=!0),options.Frame[1]&&!0===options.Frame[1][0]&&(axis=[!0,!1]))),options.Axes&&!tinyGraph&&(options.Axes=await interpretate(options.Axes,env),!0===options.Axes?axis=[!0,!0]:Array.isArray(options.Axes)&&(axis=options.Axes)),framed&&(invertedTicks=!0,axis=[!0,!0,!0,!0]),options.Ticks){options.Ticks=await interpretate(options.Ticks,{...env,context:g2d}),Array.isArray(ticks)||(ticks=[!0,!1,!0,!1]);const e=e=>Array.isArray(e)&&"number"==typeof e[0],t=t=>Array.isArray(t)&&Array.isArray(t[0])&&e(t[0]),r=e=>Array.isArray(e)?0!==e.length&&e:e,o=e=>Array.isArray(e)&&0===e.length?[!1,!1]:t(e)||Array.isArray(e)||"function"==typeof e||e&&"object"==typeof e&&e.type||!0===e||!1===e||"string"==typeof e||"number"==typeof e?[e,e]:[!1,!1];if(Array.isArray(options.Ticks)&&2===options.Ticks.length){const[e,o]=options.Ticks,n=r(e),a=r(o),i=(t(n),n),s=(t(a),a);ticks[0]=i,ticks[1]=s,ticks[2]=i,ticks[3]=s}else if(Array.isArray(options.Ticks)&&1===options.Ticks.length){const e=options.Ticks[0],[t,r]=o(e);ticks=[t,r,t,r]}else if(Array.isArray(options.Ticks)&&options.Ticks.length>=3){const e=options.Ticks,t=(e,t)=>{Array.isArray(t)?ticks[e]=0!==t.length&&t:!1===t||null===t?ticks[e]=!1:void 0!==t&&(ticks[e]=t)};t(0,e[0]),t(1,e[1]),t(2,e[2]),t(3,e[3])}else!0===options.Ticks?ticks=[!0,!0,!0,!0]:!1===options.Ticks?ticks=[!1,!1,!1,!1]:("function"==typeof options.Ticks||options.Ticks&&"object"==typeof options.Ticks&&options.Ticks.type)&&(ticks=[options.Ticks,options.Ticks,options.Ticks,options.Ticks]);Array.isArray(options.Ticks)&&(options.Ticks[1]?.type&&!options.Ticks[0]?.type&&(ticks=[!0,options.Ticks[1],!0,!1]),options.Ticks[0]?.type&&!options.Ticks[1]?.type&&(ticks=[options.Ticks[0],!0,!1,!1]),options.Ticks[1]?.type&&options.Ticks[0]?.type&&(ticks=[options.Ticks[0],options.Ticks[1],!1,!1]))}if(options.FrameTicks&&framed&&!tinyGraph&&(options.FrameTicks=await interpretate(options.FrameTicks,{...env,context:g2d}),ticks=[!0,!0,!0,!0],Array.isArray(options.FrameTicks)&&(Array.isArray(options.FrameTicks[0])&&(Array.isArray(options.FrameTicks[0][0])?(Number.isInteger(options.FrameTicks[0][0][0])||"string"==typeof options.FrameTicks[0][0]||Array.isArray(options.FrameTicks[0][0][0]))&&(ticks[1]=options.FrameTicks[0][0],ticks[3]=options.FrameTicks[0][1]):(ticks[1]=options.FrameTicks[0][0],ticks[3]=options.FrameTicks[0][1])),Array.isArray(options.FrameTicks[1])&&(Array.isArray(options.FrameTicks[1][0])?((Number.isInteger(options.FrameTicks[1][0][0])||"string"==typeof options.FrameTicks[1][0]||Array.isArray(options.FrameTicks[1][0][0]))&&(ticks[0]=options.FrameTicks[1][0],ticks[2]=options.FrameTicks[1][1]),0==options.FrameTicks[1][0].length&&(ticks[0]=!1),0==options.FrameTicks[1][1].length&&(ticks[2]=!1)):(ticks[0]=options.FrameTicks[1][0],ticks[2]=options.FrameTicks[1][1])))),options.FrameTicks&&!tinyGraph&&options.FrameTicks[2]&&options.FrameTicks[2][1]){let e=options.FrameTicks[2][1];Array.isArray(e)&&(e=e[1],Array.isArray(e)&&"Charting`getDateTicks"==e[0]&&(framed=!1,axis=[!0,!1]))}if(options.TickDirection){const e=await interpretate(options.TickDirection,env);"Inward"===e&&(invertedTicks=!0),"Outward"===e&&(invertedTicks=!1)}options.TickLengths&&(options.TickLengths=await interpretate(options.TickLengths,env),Array.isArray(options.TickLengths)||(ticklengths=[options.TickLengths,options.TickLengths,options.TickLengths,options.TickLengths])),options.TickLabels&&!tinyGraph&&(options.TickLabels=await interpretate(options.TickLabels,env),tickLabels=Array.isArray(options.TickLabels)?options.TickLabels.flat():[!1,!1,!1,!1]);let margin={top:0,right:0,bottom:10,left:40},padding={top:0,right:0,bottom:15,left:0};axis[2]&&(margin.top=margin.bottom,margin.left=margin.right),options.AxesLabel&&(padding.bottom=10,margin.top=30,margin.right=50,padding.right=50),framed&&(padding.left=40,padding.left=30,margin.left=30,margin.right=40,margin.top=30,padding.bottom=10,margin.bottom=35),options.ImagePadding&&(console.log("padding: "),console.log(options.ImagePadding),options.ImagePadding=await interpretate(options.ImagePadding,env),console.log(options.ImagePadding),"None"===options.ImagePadding?(margin.top=0,margin.bottom=0,margin.left=0,margin.right=0):Number.isInteger(options.ImagePadding)?(margin.top=options.ImagePadding,margin.bottom=options.ImagePadding,margin.left=options.ImagePadding,margin.right=options.ImagePadding):Array.isArray(options.ImagePadding)?(Array.isArray(options.ImagePadding[0])&&(Number.isInteger(options.ImagePadding[0][0])&&(margin.left=options.ImagePadding[0][0]),Number.isInteger(options.ImagePadding[0][1])&&(margin.right=options.ImagePadding[0][1])),Array.isArray(options.ImagePadding[1])&&(Number.isInteger(options.ImagePadding[1][0])&&(margin.bottom=options.ImagePadding[1][0]),Number.isInteger(options.ImagePadding[1][1])&&(margin.top=options.ImagePadding[1][1]))):"All"===options.ImagePadding||(!1===options.ImagePadding?(margin.top=0,margin.bottom=0,margin.left=0,margin.right=0):console.error("given ImagePadding is not supported!"))),options.Axes||options.Frame||options.ImagePadding||options.AxesLabel||(console.warn("Axes are absent, removing padding..."),margin.top=0,margin.bottom=0,margin.left=0,margin.right=0,padding.top=0,padding.bottom=0,padding.left=0,padding.right=0),tinyGraph&&(console.warn("too small, removing padding..."),margin.top=0,margin.bottom=0,margin.left=0,margin.right=0,padding.top=0,padding.bottom=0,padding.left=0,padding.right=0);let aspectratio=await interpretate(options.AspectRatio,env)||env.aspectRatio||1;"number"!=typeof aspectratio&&(aspectratio=1),ImageSize instanceof Array||(aspectratio=(aspectratio*(ImageSize-margin.left-margin.right)+margin.top+margin.bottom)/ImageSize,ImageSize=[ImageSize,ImageSize*aspectratio]);let width=ImageSize[0]-margin.left-margin.right,height=ImageSize[1]-margin.top-margin.bottom,svg;if(rawImage&&(width=ImageSize[0],height=ImageSize[1]),(width<0||height<0)&&(margin.top=0,margin.bottom=0,margin.left=0,margin.right=0,padding={top:0,right:0,bottom:0,left:0},width=ImageSize[0],height=ImageSize[1]),svg=d3.select(container).append("svg"),"Background"in options&&(options.Background=await interpretate(options.Background,{...env,context:g2d}),options.Background&&(svg.node().style.backgroundColor=options.Background,console.log("Background color:"+options.Background))),"ViewBox"in options){let e=await interpretate(options.ViewBox,env);e instanceof Array||(e=[0,0,e,e*aspectratio]),svg.attr("viewBox",e),env.viewBox=e}else svg.attr("width",width+margin.left+margin.right+padding.left).attr("height",height+margin.top+margin.bottom+padding.bottom),env.svgWidth=width+margin.left+margin.right+padding.left,env.svgHeight=height+margin.top+margin.bottom+padding.bottom,env.clipWidth=width,env.clipHeight=height;let svgDefs=svg.append("svg:defs"),clipOffset=0,clipMargin=2,clipRangeZoom=1,clipRangeOffset=[0,0];framed&&(clipOffset=7,clipMargin=0),svg.attr("tabindex","0");const listenerSVG=svg;svg=svg.append("g").attr("transform","translate("+(margin.left+padding.left)+","+margin.top+")");const clipId="clp"+Math.random().toFixed(4).toString().replace(".","");svg.append("clipPath").attr("id",clipId).append("rect").attr("width",width-2*clipOffset+clipMargin).attr("height",height-2*clipOffset+clipMargin).attr("x",clipOffset-clipMargin).attr("y",clipOffset-clipMargin);let range=[[-1.15,1.15],[-1.15,1.15]],unknownRanges=!0;if(options.PlotRange||env.plotRange){const e=env.plotRange||await interpretate(options.PlotRange,env);Number.isFinite(e[0][0])&&(Number.isFinite(e[1][0])?(range=e,unknownRanges=!1):(range[0]=e[0],range[1]=[-1.15,1.15]))}framed&&(clipRangeOffset=[10*(range[0][1]-range[0][0])/width,10*(range[1][1]-range[1][0])/height]);{const e=(range[0][0]+range[0][1])/2,t=(range[1][0]+range[1][1])/2;rawImage||(range=[[e+(range[0][0]-e)*clipRangeZoom-clipRangeOffset[0],e+(range[0][1]-e)*clipRangeZoom+clipRangeOffset[0]],[t+(range[1][0]-t)*clipRangeZoom-clipRangeOffset[1],t+(range[1][1]-t)*clipRangeZoom+clipRangeOffset[1]]])}let transitionType=d3.easeLinear;if(options.TransitionType){const e=await interpretate(options.TransitionType,{...env,context:g2d});switch(e){case"Linear":transitionType=d3.easeLinear;break;case"CubicInOut":transitionType=d3.easeCubicInOut;break;default:transitionType=void 0}}let niceTicks=!1,gX,gY,gTX,gRY;options.NicerTicks&&(niceTicks=!0),console.log(range);let x=d3.scaleLinear().domain(range[0]).range([0,width]),xAxis=d3.axisBottom(x),txAxis=d3.axisTop(x);if(console.log(axis),ticks)if(ticks[0])if("string"==typeof ticks[0])switch(ticks[0]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":xAxis=xAxis.tickValues([]);break;case"DateTicksFunction":x=d3.scaleTime().domain(range[0].map(e=>1e3*e-2208996e6)).range([0,width]),txAxis=d3.axisTop(x),xAxis=d3.axisBottom(x);const e=x;x=t=>e(1e3*t-2208996e6),x.copy=e.copy,x.range=e.range,x.domain=e.domain,x.invert=e.invert}else if(ticks[0]?.type){if("ScaledTicks"===ticks[0].type){x=d3.scaleLinear().domain(range[0]).range([0,width]);const mathFunction=eval("Math."+ticks[0].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};xAxis=d3.axisBottom(x).tickFormat(tickFormat)}}else if(!0===ticks[0])console.log("Default ticks");else if(Array.isArray(ticks[0][0])){const e=ticks[0].map(e=>e[1]);xAxis=xAxis.tickValues(ticks[0].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else xAxis=xAxis.tickValues(ticks[0]);else xAxis=xAxis.tickValues([]);if(ticks)if(ticks[2])if("string"==typeof ticks[2])switch(ticks[2]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":txAxis=txAxis.tickValues([]);break;case"DateTicksFunction":x=d3.scaleTime().domain(range[0].map(e=>1e3*e-2208996e6)).range([0,width]),txAxis=d3.axisTop(x).ticks(4),xAxis=d3.axisBottom(x).ticks(4);const e=x;x=t=>e(1e3*t-2208996e6),x.copy=e.copy,x.range=e.range,x.domain=e.domain,x.invert=e.invert}else if(ticks[2]?.type){if("ScaledTicks"===ticks[2].type){x=d3.scaleLinear().domain(range[0]).range([0,width]);const mathFunction=eval("Math."+ticks[2].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};txAxis=d3.axisTop(x).tickFormat(tickFormat)}}else if(!0===ticks[2])console.log("Default ticks");else if(Array.isArray(ticks[2][0])){const e=ticks[2].map(e=>e[1]);txAxis=txAxis.tickValues(ticks[2].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else txAxis=txAxis.tickValues(ticks[2]);else txAxis=txAxis.tickValues([]);let gridLines=!1;options.GridLines&&options.GridLines[1]&&(gridLines="Automatic"==options.GridLines[1]);const customLocale=d3.formatLocale({decimal:".",thousands:"",grouping:[3],currency:["",""]}),format=customLocale.format(",");tickLabels[0]?niceTicks&&(xAxis=xAxis.tickFormat(format)):xAxis=xAxis.tickFormat(e=>""),tickLabels[1]?niceTicks&&(txAxis=txAxis.tickFormat(format)):txAxis=txAxis.tickFormat(e=>""),invertedTicks?(xAxis=xAxis.tickSizeInner(-ticklengths[0]).tickSizeOuter(0),txAxis=txAxis.tickSizeInner(-ticklengths[2]).tickSizeOuter(0)):(xAxis=xAxis.tickSizeInner(ticklengths[0]).tickSizeOuter(0),txAxis=txAxis.tickSizeInner(ticklengths[2]).tickSizeOuter(0));let y=d3.scaleLinear().domain(range[1]).range([height,0]),yAxis=d3.axisLeft(y),ryAxis=d3.axisRight(y),xGrid,yGrid,gGX,gGY;if(ticks)if(ticks[1])if("string"==typeof ticks[1])switch(ticks[1]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":yAxis=yAxis.tickValues([]);break;case"DateTicksFunction":y=d3.scaleTime().domain(range[1].map(e=>1e3*e-2208996e6)).range([0,height]),ryAxis=d3.axisRight(y),yAxis=d3.axisLeft(y);const e=y;y=t=>e(1e3*t-2208996e6),y.copy=e.copy,y.range=e.range,y.domain=e.domain,y.invert=e.invert}else if(ticks[1]?.type){if("ScaledTicks"===ticks[1].type){y=d3.scaleLinear().domain(range[1]).range([height,0]);const mathFunction=eval("Math."+ticks[1].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};yAxis=d3.axisLeft(y).tickFormat(tickFormat)}}else if(!0===ticks[1])console.log("Default ticks");else if(Array.isArray(ticks[1][0])){const e=ticks[1].map(e=>e[1]);yAxis=yAxis.tickValues(ticks[1].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else yAxis=yAxis.tickValues(ticks[1]);else yAxis=yAxis.tickValues([]);if(ticks)if(ticks[3])if("string"==typeof ticks[3])switch(ticks[3]){case"Nice":niceTicks=!0;break;case"Automatic":break;case"None":ryAxis=ryAxis.tickValues([]);break;case"DateTicksFunction":y=d3.scaleTime().domain(range[1].map(e=>1e3*e-2208996e6)).range([0,height]),ryAxis=d3.axisRight(y),yAxis=d3.axisLeft(y);const e=y;y=t=>e(1e3*t-2208996e6),y.copy=e.copy,y.range=e.range,y.domain=e.domain,y.invert=e.invert}else if(ticks[3]?.type){if("ScaledTicks"===ticks[3].type){y=d3.scaleLinear().domain(range[1]).range([height,0]);const mathFunction=eval("Math."+ticks[1].args[0][2].toLowerCase()),tickFormat=e=>{const t=mathFunction(e),r=Math.abs(t);return r<.01||r>1e3?`${t.toExponential(1)}`:r<1?t.toFixed(3):r<10?t.toFixed(2):r<100?t.toFixed(1):t.toPrecision(3)};ryAxis=d3.axisRight(y).tickFormat(tickFormat)}}else if(!0===ticks[3])console.log("Default ticks");else if(Array.isArray(ticks[3][0])){const e=ticks[3].map(e=>e[1]);ryAxis=ryAxis.tickValues(ticks[3].map(e=>e[0])).tickFormat(function(t,r){return niceNumber(e[r])})}else ryAxis=ryAxis.tickValues(ticks[3]);else ryAxis=ryAxis.tickValues([]);if(tickLabels[2]?niceTicks&&(yAxis=yAxis.tickFormat(format)):yAxis=yAxis.tickFormat(e=>""),tickLabels[3]?niceTicks&&(ryAxis=ryAxis.tickFormat(format)):ryAxis=ryAxis.tickFormat(e=>""),invertedTicks?(yAxis=yAxis.tickSizeInner(-ticklengths[1]).tickSizeOuter(0),ryAxis=ryAxis.tickSizeInner(-ticklengths[3]).tickSizeOuter(0)):(yAxis=yAxis.tickSizeInner(ticklengths[1]).tickSizeOuter(0),ryAxis=ryAxis.tickSizeInner(ticklengths[3]).tickSizeOuter(0)),(ticks||axis[0])&&gridLines&&(axis[0]&&(xGrid=e=>t=>t.selectAll("line").data(e.ticks()).join("line").attr("x1",t=>e(t)).attr("x2",t=>e(t)).attr("y1",0).attr("y2",height)),axis[1]&&(yGrid=e=>t=>t.selectAll("line").data(e.ticks()).join("line").attr("x1",0).attr("x2",width).attr("y1",t=>e(t)).attr("y2",t=>e(t)))),env.context=g2d,env.svg=svg.append("g"),"PlotRangeClipping"in options){const e=await interpretate(options.PlotRangeClipping,env);env.svg=e?env.svg.attr("clip-path","url(#"+clipId+")").append("g"):env.svg.append("g")}else env.svg=env.svg.attr("clip-path","url(#"+clipId+")").append("g");env.rootSVG=env.svg,env.xAxis=x,env.yAxis=y,env.defs=svgDefs,env.xGrid=xGrid,env.yGrid=yGrid,env.numerical=!0,env.tostring=!1,env.offset={x:0,y:0},env.color="rgb(68, 68, 68)",env.stroke=void 0,env.opacity=1,env.fontsize=10,env.fontfamily="sans-serif",env.strokeWidth=1.5,env.pointSize=.023,env.arrowHead=1,env.onZoom=[],env.transitionDuration=50,env.transitionType=transitionType,env.plotRange=range,axesstyle={...env},ticksstyle={...env},options.AxesStyle&&await interpretate(options.AxesStyle,axesstyle),options.FrameStyle&&(console.warn("FrameStyle"),console.log(options.FrameStyle),await interpretate(options.FrameStyle,axesstyle),console.log(axesstyle)),options.FrameTicksStyle&&await interpretate(options.FrameTicksStyle,ticksstyle),yGrid&&(gGY=svg.append("g").attr("stroke","#0000002e").attr("stroke-dasharray","4 2").call(yGrid(y))),xGrid&&(gGX=svg.append("g").attr("stroke","#0000002e").attr("stroke-dasharray","4 2").call(xGrid(x))),axis[0]&&(gX=svg.append("g").attr("transform","translate(0,"+height+")").call(xAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color)),axis[2]&&(gTX=svg.append("g").attr("transform","translate(0,0)").call(txAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color)),axis[1]&&(gY=svg.append("g").call(yAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color)),axis[3]&&(gRY=svg.append("g").attr("transform","translate("+width+", 0)").call(ryAxis).attr("font-size",ticksstyle.fontsize).style("color",ticksstyle.color));let labelStyle={...axesstyle};if(options.LabelStyle&&await interpretate(options.LabelStyle,labelStyle),label){let e=!1;Array.isArray(label)&&"HoldForm"==label[0]&&(e=!0);try{e||(label=await interpretate(label,labelStyle))}catch(t){console.warn(t),e=!0}e?(console.warn("Fallback to Inset"),await interpretate(["Inset",options.PlotLabel,["JSObject",[x.invert(width/2+labelStyle.offset.x),y.invert(0-margin.top/2+labelStyle.offset.y)]],"Top"],{...env,context:g2d,svg:svg})):g2d.Text.PutText(svg.append("text").attr("x",width/2+labelStyle.offset.x).attr("y",0-margin.top/2+labelStyle.offset.y).attr("text-anchor","middle").attr("fill",labelStyle.color).style("font-size",labelStyle.fontsize).style("font-family",labelStyle.fontfamily),label,labelStyle)}if(options.AxesLabel&&!framed&&(options.AxesLabel=await interpretate(options.AxesLabel,{...env,hold:!0}),Array.isArray(options.AxesLabel)&&(gX&&options.AxesLabel[0]&&await processLabel(options.AxesLabel[0],gX,{...env},(e,t)=>{g2d.Text.PutText(gX.append("text").attr("x",width+15+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${width+15+t[0]}, ${margin.bottom+t[1]-10})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start")}),gY&&options.AxesLabel[1]&&await processLabel(options.AxesLabel[1],gY,{...env},(e,t)=>{g2d.Text.PutText(gY.append("text").attr("x",0+t[0]).attr("y",-margin.top/2+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${0+t[0]}, ${-margin.top/2+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","start")}))),options.FrameLabel&&framed&&(options.FrameLabel=await interpretate(options.FrameLabel,{...env,hold:!0}),Array.isArray(options.FrameLabel))){let e=options.FrameLabel[0],t=options.FrameLabel[1],r=!1;if(Array.isArray(e)?"List"!=e[0]?(e=["List",e,"None"],r=!0):Array.isArray(e[2])&&("List"==e[2][0]?3==e[2].length&&(e=["List",e,"None"],r=!0):"HoldForm"==e[2][0]&&Array.isArray(e[2][1])&&"List"==e[2][1][0]&&3==e[2][1].length&&(e=["List",["List",e[1],e[2][1]],"None"],r=!0)):(e=["List",e,"None"],r=!0),Array.isArray(t)?"List"!=t[0]?(t=["List",t,"None"],r=!0):Array.isArray(t[2])&&("List"==t[2][0]?3==t[2].length&&(t=["List",t,"None"],r=!0):"HoldForm"==t[2][0]&&Array.isArray(t[2][1])&&"List"==t[2][1][0]&&3==t[2][1].length&&(t=["List",["List",t[1],t[2][1]],"None"],r=!0)):(t=["List",t,"None"],r=!0),r&&([t,e]=[e,t]),"None"!=e[1]&&gY){let t=e[1];await processLabel(t,gY,{...env},(e,t)=>{g2d.Text.PutText(gY.append("text").attr("transform","rotate(-90)").attr("y",-margin.left+t[0]).attr("x",-height/2+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`rotate(-90) translate(${-height/2+t[1]}, ${-margin.left+t[0]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}if("None"!=e[2]&&gRY){let t=e[2];await processLabel(t,gRY,{...env},(e,t)=>{g2d.Text.PutText(gRY.append("text").attr("x",0+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${t[0]}, ${margin.bottom+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}if("None"!=t[2]&&gTX){let e=t[2];await processLabel(e,gTX,{...env},(e,t)=>{g2d.Text.PutText(gTX.append("text").attr("x",width/2+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${width/2+t[0]}, ${margin.bottom+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}if("None"!=t[1]&&gX){let e=t[1];await processLabel(e,gX,{...env},(e,t)=>{g2d.Text.PutText(gX.append("text").attr("x",width/2+t[0]).attr("y",margin.bottom+t[1]).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle"),e,axesstyle)},(e,t)=>{e.attr("transform",`translate(${width/2+t[0]}, ${margin.bottom+t[1]})`).attr("font-size",axesstyle.fontsize).attr("fill",axesstyle.color).attr("text-anchor","middle")})}}options.TransitionDuration&&(env.transitionDuration=await interpretate(options.TransitionDuration,env)),env.local.xAxis=x,env.local.yAxis=y;let GUIEnabled=!1;if((options.Controls||void 0===options.Controls)&&(void 0===options.Controls||await interpretate(options.Controls,env))&&(GUIEnabled=!0,addPanZoom(listenerSVG,svg,env.svg,gX,gY,gTX,gRY,gGX,gGY,xAxis,yAxis,txAxis,ryAxis,xGrid,yGrid,x,y,env)),env.local.listenerSVG=listenerSVG,env.panZoomEntites={canvas:listenerSVG,svg:env.svg,left:margin.left+padding.left,top:margin.top,gX:gX,gY:gY,gTX:gTX,gRY:gRY,gGX:gGX,gGY:gGY,xGrid:xGrid,yGrid:yGrid,xAxis:xAxis,yAxis:yAxis,txAxis:txAxis,ryAxis:ryAxis,x:x,y:y},!env.inset&&width>=160&&height>=98&&GUIEnabled){const e=new GUI$1({autoPlace:!1,name:"...",closed:!0}),t=document.createElement("div");t.classList.add("graphics2d-controller"),t.appendChild(e.domElement);const r={Save:function(){saveFile(serialize(container.firstChild),"plot.svg")}};e.add(r,"Save"),env.element.appendChild(t),env.local.guiContainer=t}const instancesKeys=Object.keys(env.global.stack);if(await interpretate(options.Prolog,env),await interpretate(args[0],env),interpretate(options.Epilog,env),unknownRanges){if(env.reRendered)return console.error("Something is wrong with ranges. We could not determine them properly"),void console.warn(env);svg.node().style.opacity=0,console.warn("d3.js autoscale! Requires double evaluation!!!");const e=ImageSize[0]-(margin.left+margin.right),t=ImageSize[1]-(margin.top+margin.bottom);let r=env.svg.node().getBBox();if(console.log([e,t]),console.log(r),0==r.width||0==r.height){for(let e=0;e<12&&(console.warn("Element is too small... Waiting for CSS reflow"),console.log([r.width,r.height]),await delay(300),r=env.svg.node().getBBox(),0==r.width&&0==r.height);++e);if(0==r.width&&0==r.height)throw svg.node().style.opacity=1,console.log(svg.node()),"Plot range has zero size. Content is hidden probably"}const o=[[x.invert(r.x),x.invert(r.x+r.width)],[y.invert(r.height+r.y),y.invert(r.height+r.y-r.height)]];let n=(o[1][1]-o[1][0])/(o[0][1]-o[0][0]);(!isFinite(n)||n<0||n>3||n<1/3)&&(n=void 0),console.warn("Kill all created instances");const a=Object.keys(env.global.stack).filter(e=>!instancesKeys.some(t=>t===e));for(const e of a)env.global.stack[e].dispose();return svg.remove(),container.replaceChildren(),await g2d.Graphics(args,{...env,plotRange:o,reRendered:!0,aspectRatio:n})}return env},g2d["Graphics`Serialize"]=async(e,t)=>{const r=await core._getRules(e,t);let o=t.element;r.TemporalDOM&&(o=document.createElement("div"),o.style.pointerEvents="none",o.style.opacity=0,o.style.position="absolute",document.body.appendChild(o));const n=await interpretate(e[0],{...t,element:o}),a=await serialize(n.element.firstChild).text();return Object.values(t.global.stack).forEach(e=>{e.dispose()}),r.TemporalDOM&&o.remove(),a},g2d.Graphics.update=(e,t)=>{console.error("root update method for Graphics is not supported")},g2d.Graphics.destroy=(e,t)=>{t.local.listenerSVG.remove(),t.local.guiContainer&&t.local.guiContainer.remove(),delete t.panZoomEntites,console.error("Nothing to destroy...")},g2d.JoinForm=(e,t)=>{t.joinform=interpretate(e[0],t),console.warn("JoinForm is not implemented!")};const curve={BezierCurve:async(e,t)=>{let r=await interpretate(e[0],t);var o=t.path;const n=t.xAxis,a=t.yAxis;r=r.map(e=>[n(e[0]),a(e[1])]);let i=r.length-1;if(t.startQ){o.moveTo(...r[0]);for(let e=1;e<r.length-2;e+=3)i-=3,o.bezierCurveTo(...r[e],...r[e+1],...r[e+2]);t.startQ=!1}else for(let e=0;e<r.length-2;e+=3)i-=3,o.bezierCurveTo(...r[e],...r[e+1],...r[e+2]);i>0&&o.quadraticCurveTo(...r[r.length-2],...r[r.length-1])}};g2d.Legended=async(e,t)=>{throw"Legended is not supported in the context of Graphics"},g2d.FaceForm=async(e,t)=>{const r={...t,hold:!0},o=await interpretate(e[0],r);if(Array.isArray(o)){r.hold=!1;for(const e of o)await interpretate(e,r)}t.thickness=r.thickness,t.width=r.width,t.opacity=r.opacity,t.color=r.color},curve.Line=async(e,t)=>{let r=await interpretate(e[0],t);var o=t.path;const n=t.xAxis,a=t.yAxis;if(r=r.map(e=>[n(e[0]),a(e[1])]),t.startQ){o.moveTo(...r[0]);for(let e=1;e<r.length;++e)o.lineTo(...r[e]);t.startQ=!1}else for(let e=0;e<r.length;++e)o.lineTo(...r[e])},g2d.RegularPolygon=async(e,t)=>{let r=3,o=1,[n,a]=[0,0],i=Math.PI/2;1==e.length&&(r=await interpretate(e[0],t)),2==e.length&&(r=await interpretate(e[1],t),o=await interpretate(e[0],t)),3==e.length&&([n,a]=await interpretate(e[0],t),r=await interpretate(e[2],t),o=await interpretate(e[1],t)),Array.isArray(o)&&(i+=o[1],o=o[0]);const s=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),l=2*Math.PI/r,c=d3.range(r).map(e=>{const t=i+e*l;return[n+o*Math.cos(t),a+o*Math.sin(t)]}),d=t.svg.append("path").datum(c).attr("d",s).attr("fill",t.color).attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color);return t.dasharray&&d.attr("stroke-dasharray",t.dasharray.join()),t.local.polygon=d,d},g2d.JoinedCurve=async(e,t)=>{const r=d3.path();return await interpretate(e[0],{...t,path:r,context:[curve,g2d],startQ:!0}),t.svg.append("path").attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",r)},g2d.CapForm=()=>{},g2d.FilledCurve=async(e,t)=>{const r=d3.path();return await interpretate(e[0],{...t,path:r,context:[curve,g2d],startQ:!0}),t.svg.append("path").attr("fill",t.color).attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("fill-rule","evenodd").attr("stroke","none").attr("stroke-width",t.strokeWidth).attr("d",r)};const delay=e=>new Promise(t=>{setTimeout(t,e)});g2d.Inset=async(e,t)=>{let r,o=[0,0];const n=await core._getRules(e,t),a=Object.keys(n).length;let i;e.length-a>1&&(o=await interpretate(e[1],t)),o instanceof NumericArrayObject&&(o=o.normal()),e.length-a>2&&(i=await interpretate(e[2],t));const s=t.svg.append("g"),l=s.append("foreignObject"),c={};t.local.stack=c;const d={global:{...t.global,stack:c},inset:!0,element:l.node(),context:g2d};n.ImageSizeRaw&&(r=n.ImageSizeRaw),r&&(l.attr("width",r[0]),l.attr("height",r[1]));let u=!1;"HoldForm"==e[0][0]&&(Array.isArray(e[0][1])&&"Offload"==e[0][1][0]||(u=!0));try{u||await interpretate(e[0],d)}catch(e){console.warn(e),u=!0}u&&await makeEditorView(e[0],d);const p=l.node();await delay(60);if((p.offsetHeight||p.firstChild?.offsetHeight||p.firstChild?.height)<10)for(let e=0;e<20&&(await delay(300),!((p.offsetHeight||p.firstChild?.offsetHeight||p.firstChild?.height)>30));++e);let m={width:p.offsetWidth||p.firstChild?.offsetWidth||p.firstChild?.width,height:p.offsetHeight||p.firstChild?.offsetHeight||p.firstChild?.height};if(m.width instanceof SVGAnimatedLength&&(m.width=m.width.animVal.valueInSpecifiedUnits),m.height instanceof SVGAnimatedLength&&(m.height=m.height.animVal.valueInSpecifiedUnits),console.warn(m),(m.width<1||!m.width)&&m.height>1){const e=p.getElementsByClassName("cm-scroller");e.length>0?m.width=e[0].firstChild.offsetWidth:m.width=1.66*m.height}if(r||(l.attr("width",m.width),l.attr("height",m.height)),"ViewMatrix"in n&&!n.ViewMatrix)return l.attr("x",0),l.attr("y",0),s;if(t.local.box=m,i&&"string"!=typeof i)l.attr("x",t.xAxis(o[0])-i[0]).attr("y",t.yAxis(o[1])+i[1]-m.height);else{switch(i){case"Top":i=[m.width/2,m.height];break;case"Bottom":i=[m.width/2,0];break;case"Left":i=[0,m.height/2];break;case"Right":i=[m.width,m.height/2];break;default:i=[m.width/2,m.height/2]}l.attr("x",t.xAxis(o[0])-i[0]).attr("y",t.yAxis(o[1])+i[1]-m.height)}return t.local.foreignObject=l,t.local.opos=i,s.attr("opacity",t.opacity),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.group=s,s},g2d.Inset.update=async(e,t)=>{let r=await interpretate(e[1],t);r instanceof NumericArrayObject&&(r=r.normal());const o=t.local.opos,n=t.local.foreignObject;return n&&n.attr("x",t.xAxis(r[0])-o[0]).attr("y",t.yAxis(r[1])+o[1]-t.local.box.height),n},g2d.Inset.updateOpacity=(e,t)=>{t.local.group.attr("opacity",t.opacity)},g2d.Inset.destroy=async(e,t)=>{t.opacityRefs&&delete t.opacityRefs[t.root.uid],Object.values(t.local.stack).forEach(e=>{e.dead||e.dispose()}),t.local.group.remove()},g2d.Inset.virtual=!0;const serialize=e=>{const t="http://www.w3.org/2000/xmlns/";e=e.cloneNode(!0);const r=window.location.href+"#",o=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT);for(;o.nextNode();)for(const e of o.currentNode.attributes)e.value.includes(r)&&(e.value=e.value.replace(r,"#"));e.setAttributeNS(t,"xmlns","http://www.w3.org/2000/svg"),e.setAttributeNS(t,"xmlns:xlink","http://www.w3.org/1999/xlink");const n=(new window.XMLSerializer).serializeToString(e);return new Blob([n],{type:"image/svg+xml"})};function saveFile(e,t){if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,t);else{const r=document.createElement("a");document.body.appendChild(r);const o=window.URL.createObjectURL(e);r.href=o,r.download=t,r.click(),setTimeout(()=>{window.URL.revokeObjectURL(o),document.body.removeChild(r)},0)}}const addPanZoom=(e,t,r,o,n,a,i,s,l,c,d,u,p,m,f,g,y,h)=>{console.log({listener:e,raw:t,view:r,gX:o,gY:n,gTX:a,gRY:i,xAxis:c,yAxis:d,txAxis:u,ryAxis:p,xGrid:m,yGrid:f,x:g,y:y,env:h});const _=d3.zoom().filter(function(e){return e.preventDefault(),!(e.ctrlKey&&"wheel"!==e.type||e.button)}).on("zoom",function({transform:e}){r.attr("transform",e);const t=e.rescaleX(g),_=e.rescaleY(y);o&&o.call(c.scale(t));n&&n.call(d.scale(_));a&&a.call(u.scale(t));i&&i.call(p.scale(_));s&&s.call(m(t));l&&l.call(f(_));h.onZoom.forEach(t=>t(e))});e.call(_),h._zoom=_};let arrow1;g2d.Texture=async(e,t)=>{const r=await interpretate(e[0],{...t,offscreen:!0});console.log("got it!");const o=await createImageBitmap(r);r.remove();return t.local.img=o,t.exposed.texture={image:o,get:e=>(t.local.texture||(e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),t.local.texture=twgl.createTexture(e,{src:o,flipY:!1,minMag:e.LINEAR})),t.local.texture)},o},g2d.Texture.destroy=(e,t)=>{t.local.img.close()},g2d.Texture.virtual=!0,g2d.SVGAttribute=async(e,t)=>{const r=await core._getRules(e,t);let o=await interpretate(e[0],t);return Object.keys(r).forEach(e=>{o=o.attr(e,r[e])}),t.local.object=o,o},g2d.SVGAttribute.update=async(e,t)=>{const r=await core._getRules(e,t);let o=t.local.object.maybeTransition(t.transitionType,t.transitionDuration);return Object.keys(r).forEach(e=>{o=o.attr(e,r[e])}),o},g2d.SVGAttribute.destroy=async(e,t)=>{console.log("SVGAttribute: nothing to destroy")},g2d.SVGAttribute.virtual=!0,g2d.LABColor=async(e,t)=>{let r;r=e.length>1?[await interpretate(e[0],t),await interpretate(e[1],t),await interpretate(e[2],t)]:await interpretate(e[0],t);const o=default_1({luminance:100*r[0],a:100*r[1],b:100*r[2]});return t.color="rgb("+Math.floor(o.red)+","+Math.floor(o.green)+","+Math.floor(o.blue)+")",e.length>3&&(t.opacity=await interpretate(e[3],t)),t.color},g2d.LABColor.update=()=>{},g2d.arrowGenerator=void 0,g2dComplex.BezierCurve=async(e,t)=>(await interpretate(e[0],t)).filter(e=>!Array.isArray(e)),g2dComplex.Arrow=async(e,t)=>{await interpretate.shared.d3.load(),arrow1||(arrow1=(await interpretate.shared.d3["d3-arrow"]).arrow1);let r=await interpretate(e[0],t);if(!Array.isArray(r)){let e;const o=uuidv4(),n=arrow1().id(o).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);return t.svg.call(n),e=r.attr("marker-end","url(#"+o+")"),e}if(r[0][0]){console.log("Multiple isntances"),console.log(r);const e=t.svg.append("g");e.attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth);const o=uuidv4(),n=arrow1().id(o).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);return t.svg.call(n),r.forEach(r=>{e.append("path").datum(r.map(e=>t.wgl.fallbackVertices[e-1])).attr("vector-effect","non-scaling-stroke").attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]})).attr("marker-end","url(#"+o+")")}),e}{const e=uuidv4(),o=arrow1().id(e).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);t.svg.call(o);return t.svg.append("path").datum(r.map(e=>t.wgl.fallbackVertices[e-1])).attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]})).attr("marker-end","url(#"+e+")")}},g2d.Arrow=async(e,t)=>{await interpretate.shared.d3.load(),arrow1||(arrow1=(await interpretate.shared.d3["d3-arrow"]).arrow1);const r=t.xAxis,o=t.yAxis,n=uuidv4(),a=arrow1(1.5*-(t.strokeWidth-1.5)).id(n).attr("fill",t.color).attr("stroke","none").scale([t.arrowHead]);t.local.marker=n,t.svg.call(a);let i=await interpretate(e[0],t);if(i instanceof NumericArrayObject&&(i=i.normal()),!Array.isArray(i)){let a,s=0;if(e.length>1){s=await interpretate(e[1],t),s=Math.max(Math.abs(r(s)-r(0)),Math.abs(o(s)-o(0)));const a=d3.select(document.getElementById(n));a.attr("refX",parseFloat(a.attr("refX"))+s)}return a=i.attr("marker-end","url(#"+n+")"),a}if(t.local.line=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),i[0][0][0]||"number"==typeof i[0][0][0]){const e=[];return i.forEach(r=>{e.push(t.svg.append("path").datum(r).attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",t.local.line).attr("marker-end","url(#"+n+")"))}),t.local.arrows=e,e}{const e=t.svg.append("path").datum(i).attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",t.local.line).attr("marker-end","url(#"+n+")");return t.local.arrow=e,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),e}},g2d.Arrow.update=async(e,t)=>{t.xAxis,t.yAxis;let r=await interpretate(e[0],t);if(r instanceof NumericArrayObject&&(r=r.normal()),r[0][0][0])throw"Arrows update method does not support multiple traces";return t.local.arrow.datum(r).maybeTransitionTween(t.TransitionType,t.TransitionDuration,"d",function(e){var r=d3.select(this).attr("d"),o=t.local.line(e);return interpolatePath(r,o)})};const dynSpace={DynamicName:async(e,t)=>{const r=await interpretate(e[0],{...t,context:[g2d,dynSpace]}),o=await interpretate(e[1],t);return t.contextSpace.put(o,r),r},DynamicLocation:async(e,t)=>{const r=await interpretate(e[0],t),o=(await t.contextSpace.get(r)).node().getBBox(),n=[o.x+o.width/2,o.y+o.height/2];return n[0]=t.xAxis.invert(n[0]),n[1]=t.yAxis.invert(n[1]),n}};g2d.DynamicNamespace=async(e,t)=>{const r={names:{},que:{},get:async e=>{if(e in r.names)return r.names[e];const t=new Deferred;return e in r.que||(r.que[e]=[]),r.que[e].push(t),t.promise},put:(e,t)=>{r.names[e]=t,e in r.que&&r.que[e].forEach(e=>e.resolve(t))}},o={...t,contextSpace:r,context:[dynSpace,g2d],hold:!0},n=await interpretate(e[0],o),a=[],i=[];if(Array.isArray(n))for(const e of n.reverse()){const t=o.svg.append("g");i.push(t),a.push(interpretate(e,{...o,hold:!1,svg:t}))}else a.push(n);await Promise.all(a);for(const e of i)o.svg.node().prepend(e.node())},g2d.Arrow.updateColor=(e,t)=>{"string"==typeof t.local.marker&&(t.local.marker=d3.select(document.getElementById(t.local.marker).firstChild)),t.local.marker.attr("fill",t.color),Array.isArray(t.local.arrows)?t.local.arrows.map(e=>e.attr("stroke",t.color)):t.local.arrow.attr("stroke",t.color)},g2d.Arrow.updateOpacity=(e,t)=>{"string"==typeof t.local.marker&&(t.local.marker=d3.select(document.getElementById(t.local.marker).firstChild)),t.local.marker.attr("opacity",t.opacity),Array.isArray(t.local.arrows)?t.local.arrows.map(e=>e.attr("opacity",t.opacity)):t.local.arrow.attr("opacity",t.opacity)},g2d.Arrow.virtual=!0,g2d.Arrow.destroy=async(e,t)=>{if(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],Array.isArray(t.local.arrows)?t.local.arrows.map(e=>e.remove):t.local?.arrow?.remove(),"string"==typeof t.local.marker){const e=document.getElementById(t.local.marker);t.local.marker=d3.select(e?.firstChild),t.local.marker?.remove(),e?.remove()}else t.local?.marker?.remove()},g2d.ImageScaled=async(e,t)=>{const r=await interpretate(e[0],t);return[r[0]*(t.plotRange[0][1]-t.plotRange[0][0])+t.plotRange[0][0],r[1]*(t.plotRange[1][1]-t.plotRange[1][0])+t.plotRange[1][0]]},g2d.Arrowheads=async(e,t)=>{const r=await interpretate(e[0],t);Array.isArray(r)?t.arrowHead=10*r.flat()[0]:t.arrowHead=10*r};const textContext={Pane:(e,t)=>interpretate(e[0],t),Framed:(e,t)=>interpretate(e[0],t)};g2d.DirectedInfinity=()=>1/0,g2d.Infinity=()=>1/0,textContext.NumberForm=async(e,t)=>{const r=(e,t,r)=>{const o=((e,t)=>{try{const r=Number(e).toFixed(t);return 0===Number(r)&&1/Number(e)==-1/0?"-"+r:r}catch{return String(e)}})(e,r);if(t===1/0)return o;if(o.replace(/[^0-9]/g,"").length<=t)return o;const n=Math.max(0,t-1);let a;try{a=Number(e).toExponential(n)}catch{return o}return 0!==Number(a)||1/Number(e)!=-1/0||/^-/.test(a)||(a="-"+a),a},o=(e,t)=>{if(Array.isArray(e))return e.map(e=>o(e,t));if((r=e)&&"object"==typeof r&&!Array.isArray(r)){const r={};for(const n of Object.keys(e))r[n]=o(e[n],t);return r}var r;return t(e)},n=await interpretate(e[0],t);let a,i,s="default";if(e.length>=2){const r=await interpretate(e[1],t);if(Array.isArray(r)&&r.length>=2){const e=r[0],t=r[1],o=e===1/0||"Infinity"===e?1/0:Number(e),n=Number(t);(Number.isFinite(o)||o===1/0)&&Number.isFinite(n)&&(a=o,i=Math.max(0,Math.floor(n)),s="nf")}else(r===1/0||"Infinity"===r||Number.isFinite(Number(r)))&&(a=r===1/0||"Infinity"===r?1/0:Number(r),s="n")}return o(n,e=>{if("number"!=typeof(t=e)||!isFinite(t))return e;var t;switch(s){case"n":return a===1/0?e.toString():((e,t)=>{try{const r=Number(e).toPrecision(t);return Object.is(e,-0)?r.replace(/^0/,"-0"):r}catch{return String(e)}})(e,Math.max(1,Math.floor(a)));case"nf":{const t=a===1/0?1/0:Math.max(1,Math.floor(a));return r(e,t,i)}default:return e}})},g2d.Row=()=>{throw"Row inside Graphics context is not applicable"},textContext.Rotate=async(e,t)=>(t.rotation=await interpretate(e[1],t),await interpretate(e[0],t));const textContextSym={};function detectNumbers(e){return!!Array.isArray(e)&&("Rational"==e[0]||("Complex"==e[0]||("Times"==e[0]||("Sqrt"==e[0]||("Exp"==e[0]||("Log"==e[0]||("Power"==e[0]||("Plus"==e[0]||void 0))))))))}function replaceCanvasWithImage(e){const t=e.canvas,r=t.toDataURL("image/png"),o=new Image;o.src=r,o.width=t.width,o.height=t.height,o.style.padding=0;return t.parentNode.replaceChild(o,t),o}function cleanupWebGL(e){const t=e.getExtension("WEBGL_lose_context");t&&t.loseContext()}textContextSym.E=async(e,t)=>"",textContextSym.E.update=textContextSym.E,textContextSym.Pi=async(e,t)=>"",textContextSym.Pi.update=textContextSym.Pi,textContextSym.Infinity=async(e,t)=>"",textContextSym.Infinity.update=textContextSym.Infinity,textContextSym.Indeterminate=async(e,t)=>"?",textContextSym.Indeterminate.update=textContextSym.Indeterminate,textContextSym.DirectedInfinity=async(e,t)=>"",textContextSym.DirectedInfinity.update=textContextSym.DirectedInfinity,textContextSym.Plus=async(e,t)=>{const r=await Promise.all(e.map(e=>interpretate(e,t))),o=document.createElement("span");return o.style.textWrap="nowrap",r.forEach((e,t)=>{var r;t>0&&o.appendChild(document.createTextNode(" + ")),o.appendChild((r=e)instanceof Node?r:document.createTextNode(null==r?"":"object"==typeof r?(()=>{try{return JSON.stringify(r)}catch{return String(r)}})():String(r)))}),o},textContextSym.Plus.update=textContextSym.Plus,textContextSym.Times=async(e,t)=>{const r=await Promise.all(e.map(e=>interpretate(e,t))),o=document.createElement("span");return o.style.textWrap="nowrap",r.forEach((e,t)=>{var r;t>0&&o.appendChild(document.createTextNode("  ")),o.appendChild((r=e)instanceof Node?r:document.createTextNode(null==r?"":"object"==typeof r?(()=>{try{return JSON.stringify(r)}catch{return String(r)}})():String(r)))}),o},textContextSym.Times.update=textContextSym.Times,textContextSym.Exp=async(e,t)=>{const[r]=await Promise.all(e.slice(0,1).map(e=>interpretate(e,t))),o=document.createElement("span");o.style.textWrap="nowrap";const n=document.createTextNode("e"),a=document.createElement("sup");var i;return a.appendChild((i=r)instanceof Node?i:document.createTextNode(null==i?"":"object"==typeof i?(()=>{try{return JSON.stringify(i)}catch{return String(i)}})():String(i))),o.appendChild(n),o.appendChild(a),o},textContextSym.Exp.update=textContextSym.Exp,textContextSym.Log=async(e,t)=>{const r=await Promise.all(e.slice(0,2).map(e=>interpretate(e,t))),o=e=>e instanceof Node?e:document.createTextNode(null==e?"":"object"==typeof e?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)),n=document.createElement("span");if(n.style.textWrap="nowrap",1===r.length)n.appendChild(document.createTextNode("ln(")),n.appendChild(o(r[0])),n.appendChild(document.createTextNode(")"));else{const[e,t]=r;n.appendChild(document.createTextNode("log"));const a=document.createElement("sub");a.appendChild(o(e)),n.appendChild(a),n.appendChild(document.createTextNode("(")),n.appendChild(o(t)),n.appendChild(document.createTextNode(")"))}return n},textContextSym.Log.update=textContextSym.Log,textContextSym.Sqrt=async(e,t)=>{const[r]=await Promise.all(e.slice(0,1).map(e=>interpretate(e,t))),o=document.createElement("span");o.style.textWrap="nowrap",o.classList.add("sqroot");const n=document.createElement("span");var a;return n.classList.add("radicant"),o.appendChild(n.appendChild((a=r)instanceof Node?a:document.createTextNode(null==a?"":"object"==typeof a?(()=>{try{return JSON.stringify(a)}catch{return String(a)}})():String(a)))),o},textContextSym.Sqrt.update=textContextSym.Sqrt,textContextSym.Power=async(e,t)=>{const r=await interpretate(e[1],{...t,compact:!0}),o=await interpretate(e[0],t),n=e=>e instanceof Node?e:document.createTextNode(null==e?"":"object"==typeof e?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)),a=document.createElement("span");a.style.textWrap="nowrap",a.appendChild(n(o));const i=document.createElement("sup");return i.style.lineHeight="unset",i.style.top="-0.25rem",i.style.marginLeft="0.05rem",i.style.fontSize="50%",i.appendChild(n(r)),a.appendChild(i),a},textContextSym.Power.update=textContextSym.Power,textContextSym.Complex=async(e,t)=>{const[r,o]=await Promise.all(e.slice(0,2).map(e=>interpretate(e,t))),n=document.createElement("span");return n.style.textWrap="nowrap",0!=r&&(r instanceof HTMLElement?n.appendChild(r):n.appendChild(document.createTextNode(r)),0!=o&&n.appendChild(document.createTextNode(" + "))),0!=o&&(1==o?n.appendChild(document.createTextNode("i")):(n.appendChild(document.createTextNode("i ")),o instanceof HTMLElement?n.appendChild(o):n.appendChild(document.createTextNode(o)))),n},textContextSym.Complex.update=textContextSym.Complex,textContextSym.Rational=async(e,t)=>{const[r,o]=await Promise.all(e.slice(0,2).map(e=>interpretate(e,t))),n=e=>e instanceof Node?e:document.createTextNode(null==e?"":"object"==typeof e?(()=>{try{return JSON.stringify(e)}catch{return String(e)}})():String(e)),a=document.createElement("span");if(t.compact)a.appendChild(n(r)),a.appendChild(document.createTextNode("/")),a.appendChild(n(o));else{a.className="fraction",a.innerHTML='\n        <table class="container" style="text-wrap: nowrap;">\n          <tbody>\n            <tr><td class="enumenator"></td></tr>\n            <tr><td></td></tr>\n          </tbody>\n        </table>';const[e,t]=a.querySelectorAll("td");e.appendChild(n(r)),t.appendChild(n(o))}return a},textContextSym.Rational.update=textContextSym.Rational,g2d.BaseStyle=()=>"BaseStyle",g2d.Text=async(e,t)=>{const r={...t};r.context=[textContext,g2d];let o=e[0];detectNumbers(o)?(r.context.unshift(textContextSym),o=await interpretate(e[0],r)):(o=await interpretate(e[0],r),t.local.text=o);let n=await interpretate(e[1],t);const a=await core._getRules(e,{...t,hold:!0});n instanceof NumericArrayObject&&(n=n.normal());let i,s={x:0,y:0};if("'Graphics'"==a.BaseStyle&&(r.color="black"),o instanceof HTMLElement){t.local.htmlQ=!0;const e=d3.select(o).style("font-family",r.fontfamily).style("font-size",r.fontsize+"px").style("opacity",r.opacity).style("color",r.color);r.fontweight&&e.style("font-weight",r.fontweight),i=t.svg.append("foreignObject").attr("style","overflow: visible"),i.node().appendChild(o);const n=i.node(),a=n.offsetHeight||n.firstChild?.offsetHeight||n.firstChild?.height,l=n.offsetWidth||n.firstChild?.offsetWidth||n.firstChild?.width;i.attr("width",l).attr("height",a),s.x=-Math.round(l/2),s.y=-Math.round(a/2)}else i=t.svg.append("text").attr("font-family",r.fontfamily).attr("font-size",r.fontsize).attr("opacity",r.opacity).attr("fill",r.color),r.fontweight&&i.attr("font-weight",r.fontweight);if(e.length>2){let o=[0,0];"Rule"!=e[2][0]&&(o=(await interpretate(e[2],{...t,plotRange:[[-1,1],[-1,1]]})).map(e=>Math.round(e)));const a=t.xAxis(n[0])+s.x,l=t.yAxis(n[1])+s.y;if(i.attr("x",a).attr("y",l),r.rotation){const e=Math.round(180*r.rotation/Math.PI);i.attr("transform",`rotate(${e}, ${a}, ${l})`)}0===o[0]?i.attr("text-anchor","middle"):o[0]>0?i.attr("text-anchor","end"):o[0]<0&&i.attr("text-anchor","start"),0===o[1]?i.attr("alignment-baseline","middle"):o[1]>0?i.attr("alignment-baseline","hanging"):o[1]<0&&i.attr("alignment-baseline","text-after")}else{const e=t.xAxis(n[0])+s.x,o=t.yAxis(n[1])+s.y;if(i.attr("x",e).attr("y",o),r.rotation){const t=Math.round(180*r.rotation/Math.PI);i.attr("transform",`rotate(${t}, ${e}, ${o})`)}}return g2d.Text.PutText(i,o,t),t.local.object=i,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),i},g2d.Text.PutText=(e,t,r)=>{if(!t)return;let o=t;if("number"==typeof t&&(o=t.toString()),"string"!=typeof o)return;const n=[g2d.Text.TokensSplit(o.replaceAll(/\\([a-zA-z]+)/g,g2d.Text.GreekReplacer),g2d.Text.TextOperators)].flat(1/0);let a;e.html(n.shift());let i=0;for(;null!=(a=n.shift());)"string"==typeof a?(e.append("tspan").html(a).attr("font-size",r.fontsize).attr("dy",-i),i=0):(i=-r.fontsize*a.ky,e.append("tspan").html(a.data).attr("font-size",Math.round(r.fontsize*a.kf)).attr("dy",i))},g2d.Text.TextOperators=[{type:"sup",handler:e=>e,regexp:/\^{([^{|}]*)}/,meta:{ky:.4,kf:.7}},{type:"sub",handler:e=>e,regexp:/\_{([^{|}]*)}/,meta:{ky:-.25,kf:.7}}],g2d.Text.GreekReplacer=(e,t,r)=>"&"+t.toLowerCase().replace("sqrt","radic").replace("degree","deg")+";",g2d.Text.TokensSplit=(e,t,r=0)=>{if(r===t.length||r<0)return e;const o=e.match(t[r].regexp);if(null===o)return g2d.Text.TokensSplit(e,t,r+1);const n={type:t[r].type,data:t[r].handler(o[1]),...t[r].meta};return[g2d.Text.TokensSplit(e.slice(0,o.index),t,r+1),n,g2d.Text.TokensSplit(e.slice(o.index+o[0].length),t,0)]},g2d.Text.virtual=!0,g2d.Text.updateColor=(e,t)=>{t.local.object.attr("fill",t.color)},g2d.Text.updateOpacity=(e,t)=>{t.local.object.attr("opacity",t.opacity)},g2d.Text.update=async(e,t)=>{let r,o=await interpretate(e[1],t);if(o instanceof NumericArrayObject&&(o=o.normal()),!t.local.htmlQ){let n;return r=await interpretate(e[0],t),n=t.local.text!=r?t.local.object.maybeTransition(t.transitionType,t.transitionDuration).text(r).attr("x",t.xAxis(o[0])).attr("y",t.yAxis(o[1])):t.local.object.maybeTransition(t.transitionType,t.transitionDuration).attr("x",t.xAxis(o[0])).attr("y",t.yAxis(o[1])),n}console.error("Update method for symbol-like elements is not supported in Text[]")},g2d.Text.destroy=(e,t)=>{t.local.object.remove(),delete t.local.object,t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid]},g2d.Text.subcontext={},g2d.FontSize=()=>"FontSize",g2d.FontSize.update=g2d.FontSize,g2d.FontFamily=()=>"FontFamily",g2d.FontFamily.update=g2d.FontFamily,g2d.Bold=()=>"Bold",g2d.Bold.update=()=>"Bold",g2d.Style=async(e,t)=>{const r=t,o=await core._getRules(e,t);o.FontSize&&(r.fontsize=o.FontSize),o.FontColor&&(r.color=o.FontColor),o.FontFamily&&(r.fontfamily=o.FontFamily);for(let t=1;t<e.length-Object.keys(o).length;++t){"Bold"==await interpretate(e[t],r)&&(r.fontweight="bold")}return await interpretate(e[0],r)},g2d.Style.update=async(e,t)=>{const r=await core._getRules(e,t);return r.FontSize&&(t.fontsize=r.FontSize),r.FontFamily&&(t.fontfamily=r.FontFamily),await interpretate(e[0],t)},g2d.AnimationFrameListener=async(e,t)=>{await interpretate(e[0],t);const r=await core._getRules(e,{...t,hold:!0});t.local.event=await interpretate(r.Event,t),t.local.fire=()=>{server.kernel.io.poke(t.local.event),performance.now()},window.requestAnimationFrame(t.local.fire)},g2d.AnimationFrameListener.update=async(e,t)=>{window.requestAnimationFrame(t.local.fire)},g2d.AnimationFrameListener.destroy=async(e,t)=>{console.warn("AnimationFrameListener does not exist anymore"),t.timer&&clearInterval(t.timer)},g2d.AnimationFrameListener.virtual=!0;const vs="\n    attribute vec2 position;\n    uniform vec2 u_resolution;\n    uniform bool u_vertexColor;\n    uniform bool u_vertexTexture;\n    uniform float u_pointSize;\n    attribute vec4 color;\n    varying vec4 v_color;\n\n    attribute vec2 texcoord;\n    varying vec2 v_texcoord;\n    \n\n    void main() {\n        vec2 clipSpace = (position / u_resolution) * 2.0 - 1.0;\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        if (u_vertexColor) v_color = color;  // Pass color to fragment shader\n        if (u_vertexTexture) v_texcoord = texcoord; // Pass texture (if applicable)\n        gl_PointSize = u_pointSize;\n    }\n  ",fs="\n    precision mediump float;\n    uniform vec4 u_color;\n    uniform bool u_vertexColor;\n    uniform bool u_vertexTexture;\n    varying vec4 v_color;\n\n    uniform sampler2D u_texture;\n    varying vec2 v_texcoord;\n\n    void main() {\n        if (u_vertexColor) {\n          gl_FragColor = v_color;\n          return;\n        }\n\n        if (u_vertexTexture) {\n          gl_FragColor = texture2D(u_texture, v_texcoord);\n          return;\n        }    \n        \n        gl_FragColor = u_color;\n    }\n  ";var twgl;g2d.GraphicsComplex=async(e,t)=>{twgl||(twgl=await Promise.resolve().then(function(){return twgl_module}));const r=(await interpretate(e[0],t)).map(e=>[t.xAxis(e[0]),t.yAxis(e[1])]);let o=1/0,n=1/0,a=-1/0,i=-1/0;for(const[e,t]of r)e<o&&(o=e),t<n&&(n=t),e>a&&(a=e),t>i&&(i=t);t.local.rect=t.svg.append("rect").attr("x",o).attr("y",n).attr("width",a-o).attr("height",i-n).attr("opacity",0);const s=await core._getRules(e,t),l={...t,context:[g2dComplex,g2d]},c=t.svg.append("foreignObject").attr("width",t.clipWidth).attr("height",t.clipHeight).append("xhtml:canvas");c.attr("width",Math.round(1*t.clipWidth)).attr("height",Math.round(1*t.clipHeight));const d=c.node().getContext("webgl",{premultipliedAlpha:!1}),u=twgl.createProgramInfo(d,[vs,fs]);d.getExtension("OES_element_index_uint")||console.error("TWGL: need OES_element_index_uint"),twgl.addExtensionsToContext(d),l.wgl={gl:d,programInfo:u},l.wgl.fallbackVertices=r;const p=t.opacity,m={position:{numComponents:2,data:r.flat(1/0).map(e=>1*e)}};if(s.VertexColors){let e=[];switch(l.wgl.vertexColors=!0,l.wgl.fallbackColors=s.VertexColors,s.VertexColors[0].length){case 3:for(let t=0;t<s.VertexColors.length;++t){const r=s.VertexColors[t];e.push(...r,p)}break;case 4:e=s.VertexColors.flat(1/0);break;default:if("string"==typeof s.VertexColors[0]){console.warn("FIXME: This is the worst case");for(let t=0;t<s.VertexColors.length;++t){const r=d3.color(s.VertexColors[t]);e.push(r.r/255,r.g/255,r.b/255,p)}}}m.color={numComponents:4,data:e}}if(s.VertexTextureCoordinates){const e=s.VertexTextureCoordinates.flat(1/0);m.texcoord={numComponents:2,data:e},l.wgl.vertexTexture=!0}const f=twgl.createBufferInfoFromArrays(d,m);d.viewport(0,0,d.canvas.width,d.canvas.height),d.clearColor(0,0,0,0),d.clear(d.COLOR_BUFFER_BIT),d.useProgram(u.program),d.enable(d.BLEND),twgl.setBuffersAndAttributes(d,u,f),await interpretate(e[1],l);const g=replaceCanvasWithImage(d);return cleanupWebGL(d),g.style.opacity=t.opacity,t.local.img=g,t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),g},g2d.GraphicsComplex.update=()=>{throw"Updates of GraphicsComplex are not supported!"},g2d.GraphicsComplex.updateOpacity=(e,t)=>{t.local.img.style.opacity=t.opacity},g2d.GraphicsComplex.destroy=(e,t)=>{t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.img.remove(),t.local.rect.remove()},g2d.GraphicsComplex.virtual=!0,g2d.Medium=()=>.08,g2d.Large=()=>1.1/10,g2d.Small=()=>.05,g2d.Tiny=()=>.02,g2d.GraphicsGroup=async(e,t)=>await interpretate(e[0],t),g2d.Invisible=async(e,t)=>{const r=t.svg.append("g");return r.attr("style","visibility:hidden"),await interpretate(e[0],{...t,svg:r})},g2d.Thickness=async(e,t)=>{const r=await interpretate(e[0],t);"number"==typeof r&&(t.strokeWidth=30*r)},g2d.AbsoluteThickness=(e,t)=>{t.strokeWidth=interpretate(e[0],t)},g2d.PointSize=async(e,t)=>{t.pointSize=await interpretate(e[0],t)},g2d.Annotation=async(e,t)=>await interpretate(e[0],{...t}),g2d.ZoomAt=async(e,t)=>{let r=await interpretate(e[0],t);const o={width:t.xAxis((t.plotRange[0][0]+t.plotRange[0][1])/2),height:t.yAxis((t.plotRange[1][0]+t.plotRange[1][1])/2)};let n=[(t.plotRange[0][0]+t.plotRange[0][1])/2,-(t.plotRange[1][0]+t.plotRange[1][1])/2];e.length>1&&(n=await interpretate(e[1],t)),n=[t.xAxis(n[0]),t.yAxis(n[1])],console.log(n);const a=t.panZoomEntites;console.log(t.svg.attr("transform"));const i=d3.zoomIdentity.translate(o.width,o.height).scale(r).translate(-n[0],-n[1]);a.svg.maybeTransition(t.transitionType,t.transitionDuration).attr("transform",i),a.gX&&a.gX.maybeTransition(t.transitionType,t.transitionDuration).call(a.xAxis.scale(i.rescaleX(a.x))),a.gY&&a.gY.maybeTransition(t.transitionType,t.transitionDuration).call(a.yAxis.scale(i.rescaleY(a.y))),a.gGX&&a.gGX.maybeTransition(t.transitionType,t.transitionDuration).call(a.xGrid(i.rescaleY(a.x))),a.gGY&&a.gGY.maybeTransition(t.transitionType,t.transitionDuration).call(a.yGrid(i.rescaleY(a.y))),a.gTX&&a.gTX.maybeTransition(t.transitionType,t.transitionDuration).call(a.txAxis.scale(i.rescaleX(a.x))),a.gRY&&a.gRY.maybeTransition(t.transitionType,t.transitionDuration).call(a.ryAxis.scale(i.rescaleY(a.y)))};const rescaleRanges=(e,t,r,o)=>{throw"not implemented"};g2d.Directive=async(e,t)=>{const r=await core._getRules(e,t);for(const e of Object.keys(r))t[e.toLowerCase()]=r[e];if(assignTransition(t),"PlotRange"in r){const e=r.PlotRange;rescaleRanges(e,t.plotRange,t.panZoomEntites)}for(let o=0;o<e.length-Object.keys(r).length;++o)await interpretate(e[o],t)},g2d.EdgeForm=async(e,t)=>{const r={...t,hold:!0},o=await interpretate(e[0],r);if(Array.isArray(o)){r.hold=!1;for(const e of o)await interpretate(e,r)}t.strokeWidth=r.strokeWidth,t.strokeOpacity=r.opacity,"rgb(68, 68, 68)"!==r.color&&(t.stroke=r.color)},g2d.EdgeForm.update=async(e,t)=>{},g2d.Opacity=async(e,t)=>{if(t.opacity=await interpretate(e[0],t),t.exposed.opacity=t.opacity,t.root.child){console.log("Dynamic env variable caught");const e={};t.exposed.opacityRefs=e,t.local.refs=e}return t.opacity},g2d.Opacity.update=async(e,t)=>{const r=await interpretate(e[0],t),o=Object.values(t.local.refs);for(const e of o)e.execute({method:"updateOpacity",opacity:r})},g2d.Opacity.destroy=(e,t)=>{delete t.local.refs},g2d.Opacity.virtual=!0,g2d.GrayLevel=async(e,t)=>{let r=await interpretate(e[0],t);return r.length&&(r=r[0]),r=Math.floor(255*r),t.color=`rgb(${r},${r},${r})`,t.color},g2d.RGBColor=async(e,t)=>{let r;if(3==e.length)r="rgb(",r+=String(Math.floor(255*await interpretate(e[0],t)))+",",r+=String(Math.floor(255*await interpretate(e[1],t)))+",",r+=String(Math.floor(255*await interpretate(e[2],t)))+")";else{let o=await interpretate(e[0],t);o instanceof NumericArrayObject&&(o=o.normal()),r="rgb(",r+=String(Math.floor(255*o[0]))+",",r+=String(Math.floor(255*o[1]))+",",r+=String(Math.floor(255*o[2]))+")"}if(t.root.child){console.log("Dynamic env variable caught");const e={};t.exposed.colorRefs=e,t.local.refs=e}return t.exposed.color=r,r},g2d.RGBColor.update=async(e,t)=>{let r;if(3==e.length)r="rgb(",r+=String(Math.floor(255*await interpretate(e[0],t)))+",",r+=String(Math.floor(255*await interpretate(e[1],t)))+",",r+=String(Math.floor(255*await interpretate(e[2],t)))+")";else{let o=await interpretate(e[0],t);o instanceof NumericArrayObject&&(o=o.normal()),r="rgb(",r+=String(Math.floor(255*o[0]))+",",r+=String(Math.floor(255*o[1]))+",",r+=String(Math.floor(255*o[2]))+")"}const o=Object.values(t.local.refs);for(const e of o)e.execute({method:"updateColor",color:r})},g2d.RGBColor.destroy=(e,t)=>{delete t.local.refs},g2d.RGBColor.virtual=!0;let hsv2hsl=(e,t,r,o=r-r*t/2,n=Math.min(o,1-o))=>[e,n?(r-o)/n:0,o];var earcut$2;g2d.Hue=async(e,t)=>{let r=await Promise.all(e.map(e=>interpretate(e,t)));if(r.length<3&&(r=[r[0],1,1]),r=hsv2hsl(...r),r=[r[0],(100*r[1]).toFixed(2),(100*r[2]).toFixed(2)],t.color="hsl("+(314*r[0]).toFixed(2)+","+r[1]+"%,"+r[2]+"%)",t.root.child){console.log("Dynamic env variable caught");const e={};t.exposed.colorRefs=e,t.local.refs=e}return t.exposed.color=t.color,t.color},g2d.Hue.update=async(e,t)=>{let r=await Promise.all(e.map(e=>interpretate(e,t)));r.length<3&&(r=[r[0],1,1]),r=hsv2hsl(...r),r=[r[0],(100*r[1]).toFixed(2),(100*r[2]).toFixed(2)];const o="hsl("+(314*r[0]).toFixed(2)+","+r[1]+"%,"+r[2]+"%)",n=Object.values(t.local.refs);for(const e of n)e.execute({method:"updateColor",color:o})},g2d.Hue.destroy=(e,t)=>{delete t.local.refs},g2d.Hue.virtual=!0,g2d.CubicInOut=()=>"CubicInOut",g2d.Linear=()=>"Linear",g2dComplex.List=core.List,g2dComplex.Polygon=async(e,t)=>{let r=await interpretate(e[0],t),o=d3.color(t.color);o=[o.r/255,o.g/255,o.b/255,t.opacity],r[0][0]||(r=[r]);const{gl:n,programInfo:a}=t.wgl;let i;switch(r[0].length){case 3:i=twgl.createBufferInfoFromArrays(n,{indices:r.flat(1/0).map(e=>e-1)});break;case 4:{const e=[];for(let t=0;t<r.length;++t){const o=r[t];e.push(o[0]-1,o[1]-1,o[2]-1,o[0]-1,o[2]-1,o[3]-1)}i=twgl.createBufferInfoFromArrays(n,{indices:e})}break;case 5:{const e=[];for(let t=0;t<r.length;++t){const o=r[t];e.push(o[0]-1,o[1]-1,o[2]-1,o[0]-1,o[2]-1,o[3]-1,o[0]-1,o[3]-1,o[4]-1)}i=twgl.createBufferInfoFromArrays(n,{indices:e})}break;case 6:{const e=[];for(let t=0;t<r.length;++t){const o=r[t];e.push(o[0]-1,o[1]-1,o[2]-1,o[0]-1,o[2]-1,o[3]-1,o[0]-1,o[3]-1,o[4]-1,o[0]-1,o[4]-1,o[5]-1)}i=twgl.createBufferInfoFromArrays(n,{indices:e})}break;default:const e=t.wgl.fallbackVertices,o=[];earcut$2||(earcut$2=(await Promise.resolve().then(function(){return earcut$1})).default);for(let t of r){t=t.map(e=>e-1);const r=t.flatMap(t=>e[t]);o.push(earcut$2(r).map(e=>t[e]))}i=twgl.createBufferInfoFromArrays(n,{indices:o.flat()})}if(twgl.setBuffersAndAttributes(n,a,i),t.wgl.vertexTexture){if(!t.texture)throw"Texture is not provided!";const e=t.texture.get(n);return twgl.setUniforms(a,{u_resolution:[n.canvas.width,n.canvas.height],u_texture:e,u_vertexTexture:!0}),void(t.wgl.fallbackVertices.length>65535?n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_INT,0):n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_SHORT,0))}twgl.setUniforms(a,{u_resolution:[n.canvas.width,n.canvas.height],u_color:o,u_vertexColor:Boolean(t.wgl.vertexColors)}),t.wgl.fallbackVertices.length>65535?n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_INT,0):n.drawElements(n.TRIANGLES,i.numElements,n.UNSIGNED_SHORT,0)},g2d.Deploy=(e,t)=>interpretate(e[0],t),g2d.Polygon=async(e,t)=>{let r=await interpretate(e[0],t);if(r?.lhs){const e=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])});let o=r.rhs,n=r.lhs;Array.isArray(n[0][0])||1!=o.length||(n=[n],o=o[0]);const a=[e([...o,o[0]]),...n.map(t=>{const r=[...t].reverse();return e([...r,r[0]])})].join("");return t.local.area=t.svg.append("path").attr("d",a).attr("fill",t.color).attr("fill-rule","evenodd").attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color),t.local.area}if(r instanceof NumericArrayObject&&(r=data.normal()),t.local.line=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),Array.isArray(r[0][0])){console.log("most likely there are many polygons");const e=t.svg.append("g").attr("fill",t.color).attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color);return t.texture&&t.local.area.attr("fill","url(#"+t.texture+")"),t.dasharray&&e.attr("stroke-dasharray",t.dasharray.join()),r.forEach(r=>{r.push(r[0]),e.append("path").datum(r).attr("d",t.local.line)}),t.local.polygons=e,e}return r.push(r[0]),t.local.area=t.svg.append("path").datum(r).attr("fill",t.color).attr("fill-opacity",t.opacity).attr("stroke-opacity",t.strokeOpacity||t.opacity).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).attr("stroke",t.stroke||t.color).attr("d",t.local.line),t.texture&&t.local.area.attr("fill","url(#"+t.texture+")"),t.dasharray&&t.local.area.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.area},g2d.Polygon.updateColor=(e,t)=>{if(t.local.polygons)for(const e of t.local.polygons)e.attr("fill",t.color);else t.local.area.attr("fill",t.color)},g2d.Polygon.updateOpacity=(e,t)=>{if(t.local.polygons)for(const e of t.local.polygons)e.attr("fill-opacity",t.opacity),e.attr("stroke-opacity",t.strokeOpacity||t.opacity);else t.local.area.attr("fill-opacity",t.opacity),t.local.area.attr("stroke-opacity",t.strokeOpacity||t.opacity)},g2d.Polygon.update=async(e,t)=>{let r=await interpretate(e[0],t);if(r instanceof NumericArrayObject&&(r=r.normal()),t.local.polygons)throw"update method for many polygons in not supported";t.xAxis,t.yAxis;return t.local.area.datum(r).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),o=t.local.line(e);return interpolatePath(r,o)})},g2d.Polygon.destroy=(e,t)=>{if(console.log("area destroyed"),t.local){if(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.area)return t.local.area.remove(),void delete t.local.area;t.local.polygons&&(t.local.polygons.remove(),delete t.local.polygons)}},g2d.Polygon.virtual=!0,g2d.IdentityFunction=async(e,t)=>await interpretate(e[0],t),g2d.StatusArea=g2d.IdentityFunction,g2d["Charting`DelayedMouseEffect"]=g2d.IdentityFunction,g2dComplex.Line=async(e,t)=>{const r=await interpretate(e[0],t);if(r[0][0]){const e=t.svg.append("g");return e.attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth),r.forEach(r=>{e.append("path").datum(r.map(e=>t.vertices[e-1])).attr("vector-effect","non-scaling-stroke").attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]}))}),e}{const e=t.svg.append("path").datum(r.map(e=>t.wgl.fallbackVertices[e-1])).attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return e[0]}).y(function(e){return e[1]}));return t.dasharray&&e.attr("stroke-dasharray",t.dasharray.join()),e}},g2d.SplineKnots=()=>"SplineKnots",g2d.SplineDegree=()=>"SplineDegree",g2d.BSplineCurve=async(e,t)=>{const r=await core._getRules(e,t);let o=await interpretate(e[0],t);const n=t.xAxis,a=t.yAxis,i=o.map(e=>3===e.length?{x:e[0],y:e[1],w:e[2]}:{x:e[0],y:e[1],w:1});let s=r.SplineDegree;"number"!=typeof s&&(s=3);const l=i.length-1,c=s;let d=r.SplineKnots;function u(e,t,r,o){if(0===t)return o[e]<=r&&r<o[e+1]?1:0;const n=o[e+t]-o[e],a=o[e+t+1]-o[e+1];return(n?(r-o[e])/n*u(e,t-1,r,o):0)+(a?(o[e+t+1]-r)/a*u(e+1,t-1,r,o):0)}function p(e){let t={x:0,y:0},r=0;for(let o=0;o<=l;o++){const n=u(o,c,e,d)*i[o].w;t.x+=n*i[o].x,t.y+=n*i[o].y,r+=n}return[n(t.x/r),a(t.y/r)]}Array.isArray(d)||(d=(()=>{const e=l+c+1;let t=[];for(let r=0;r<=e;r++)r<=c?t.push(0):r>=e-c?t.push(1):t.push((r-c)/(e-2*c));return t})());const m=d3.path(),f=t.steps||100;for(let e=0;e<=f;e++){const t=p(d[c]+(d[l+1]-d[c])*e/f);0===e?m.moveTo(...t):m.lineTo(...t)}return t.svg.append("path").attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",m)};const deCasteljau=(e,t)=>{let r=e.map(e=>[e[0],e[1]]);for(let o=1;o<e.length;o++)for(let n=0;n<e.length-o;n++)r[n][0]=(1-t)*r[n][0]+t*r[n+1][0],r[n][1]=(1-t)*r[n][1]+t*r[n+1][1];return r[0]},drawSampled=(e,t,r=48)=>{for(let o=1;o<=r;o++){const n=deCasteljau(t,o/r);e.lineTo(n[0],n[1])}};g2d.BezierCurve=async(e,t)=>{const r=await core._getRules(e,t);let o=await interpretate(e[0],t);const n=d3.path(),a=r&&Number.isInteger(r.SplineDegree)?r.SplineDegree:3,i=Math.max(1,a),s=t.xAxis,l=t.yAxis;if(o=o.map(e=>[s(e[0]),l(e[1])]),o.length<2)return null;n.moveTo(o[0][0],o[0][1]);let c=1;for(;c+i-1<o.length;){const e=o.length-c;if(3===i&&e>=3)n.bezierCurveTo(o[c][0],o[c][1],o[c+1][0],o[c+1][1],o[c+2][0],o[c+2][1]),c+=3;else if(2===i&&e>=2)n.quadraticCurveTo(o[c][0],o[c][1],o[c+1][0],o[c+1][1]),c+=2;else{const t=Math.min(i,e),r=[n._currentPoint||o[c-1]].concat(o.slice(c,c+t));drawSampled(n,r,Math.max(24,12*t));const a=r[r.length-1];n._currentPoint=[a[0],a[1]],c+=t}}const d=o.length-c;if(1===d)n.lineTo(o[c][0],o[c][1]);else if(2===d)n.quadraticCurveTo(o[c][0],o[c][1],o[c+1][0],o[c+1][1]);else if(d>2){const e=[n._currentPoint||o[c-1]].concat(o.slice(c));drawSampled(e,Math.max(24,12*d))}return t.svg.append("path").attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",n)},g2d.Line=async(e,t)=>{t.offset;let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const o=t.xAxis,n=t.yAxis;let a;switch(arrdims(r)){case 0:a=t.svg.append("path").datum([]).attr("fill","none").attr("vector-effect","non-scaling-stroke").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return o(e[0])}).y(function(e){return n(e[1])})),t.dasharray&&a.attr("stroke-dasharray",t.dasharray.join());break;case 2:if(t.returnPath)throw a=null,"Not implemented!";a=t.svg.append("path").datum(r).attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("opacity",t.opacity).attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return o(e[0])}).y(function(e){return n(e[1])})),t.dasharray&&a.attr("stroke-dasharray",t.dasharray.join());break;case 3:console.log(r),a=r.map(e=>{const r=t.svg.append("path").datum(e).join("path").attr("vector-effect","non-scaling-stroke").attr("fill","none").attr("stroke",t.color).attr("stroke-width",t.strokeWidth).attr("d",d3.line().x(function(e){return o(e[0])}).y(function(e){return n(e[1])}));return t.dasharray&&r.attr("stroke-dasharray",t.dasharray.join()),r})}return t.local.nsets=r.length,t.local.line=d3.line().x(function(e){return t.xAxis(e[0])}).y(function(e){return t.yAxis(e[1])}),t.local.object=a,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),Array.isArray(a)?a[0]:a},g2d.Line.updateColor=(e,t)=>{Array.isArray(t.local.object)?t.local.object.forEach(e=>e.style("stroke",t.color)):t.local.object.style("stroke",t.color)},g2d.Line.updateOpacity=(e,t)=>{Array.isArray(t.local.object)?t.local.object.forEach(e=>e.style("opacity",t.opacity)):t.local.object.style("opacity",t.opacity)},g2d.Line.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const o=t.xAxis,n=t.yAxis;let a,i=t.local.object;switch(arrdims(r)){case 0:a=i.datum([]).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),o=t.local.line(e);return interpolatePath(r,o)});break;case 2:a=i.datum(r).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),o=t.local.line(e);return interpolatePath(r,o)});break;case 3:for(let e=0;e<Math.min(r.length,t.local.nsets);++e)console.log("upd 1"),a=i[e].datum(r[e]).maybeTransitionTween(t.transitionType,t.transitionDuration,"d",function(e){var r=d3.select(this).attr("d"),o=t.local.line(e);return interpolatePath(r,o)});if(r.length>t.local.nsets){console.log("upd 2");for(let e=t.local.nsets;e<r.length;++e)a=t.svg.append("path").datum(r[e]).attr("fill","none").attr("stroke",t.color).attr("stroke-width",t.strokeWidth).maybeTransition(t.transitionType,t.transitionDuration).attr("d",d3.line().x(function(e){return o(e[0])}).y(function(e){return n(e[1])})),i.push(a)}if(r.length<t.local.nsets){console.log("upd 3");for(let e=r.length;e<t.local.nsets;++e)a=i[e].datum(r[0]).join("path").maybeTransition(t.transitionType,t.transitionDuration).attr("d",t.local.line)}}return t.local.nsets=Math.max(r.length,t.local.nsets),a},g2d.Line.virtual=!0,g2d.Line.destroy=(e,t)=>{t.local&&t.local.object&&(Array.isArray(t.local.object)?t.local.object.forEach(e=>e.remove()):t.local.object.remove(),delete t.local.object)},g2d.Circle=async(e,t)=>{if(e.length>2)return t.local.arcQ=!0,await g2d._arc(e,t);let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let o=[1,1];e.length>1&&(o=await interpretate(e[1],t),Array.isArray(o)||(o=[o,o]));const n=t.xAxis,a=t.yAxis;t.local.coords=[n(r[0]),a(r[1])],t.local.r=[n(o[0])-n(0),Math.abs(a(o[1])-a(0))];const i=t.svg.append("ellipse").attr("vector-effect","non-scaling-stroke").attr("cx",n(r[0])).attr("cy",a(r[1])).attr("rx",t.local.r[0]).attr("ry",t.local.r[1]).style("stroke",t.color).attr("vector-effect","non-scaling-stroke").attr("stroke-width",t.strokeWidth).style("fill","none").style("opacity",t.opacity);return t.local.object=i,t.dasharray&&i.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),i},g2d.Circle.updateColor=(e,t)=>{t.local.object.style("stroke",t.color)},g2d.Circle.updateOpacity=(e,t)=>{t.local.object.style("opacity",t.opacity)},g2d.Circle.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let o=1;e.length>1&&(o=await interpretate(e[1],t),Array.isArray(o)||(o=[o,o]));const n=t.xAxis,a=t.yAxis;return t.local.r=[n(o[0])-n(0),Math.abs(a(o[1])-a(0))],t.local.object.maybeTransition(t.transitionType,t.transitionDuration).attr("cx",n(r[0])).attr("cy",a(r[1])).attr("rx",t.local.r[0]).attr("ry",t.local.r[1]),t.local.object},g2d.Circle.destroy=(e,t)=>{t.local.arcQ||(t.local.object.remove(),t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid])},g2d.Circle.virtual=!0;const deg=function(e){return 180*e/Math.PI},rad=function(e){return e*Math.PI/180};function getEllipsePointForAngle(e,t,r,o,n,a){const{abs:i,sin:s,cos:l}=Math,c=i(r)*l(a),d=i(o)*s(a);return[e+l(n)*c-s(n)*d,t+s(n)*c+l(n)*d]}function getEndpointParameters(e,t,r,o,n,a,i){const[s,l]=getEllipsePointForAngle(e,t,r,o,n,a),[c,d]=getEllipsePointForAngle(e,t,r,o,n,a+i);return{x1:s,y1:l,x2:c,y2:d,fa:Math.abs(i)>Math.PI?1:0,fs:i>0?1:0}}function getCenterParameters(e,t,r,o,n,a,i,s,l){const{abs:c,sin:d,cos:u,sqrt:p}=Math,m=e=>Math.pow(e,2),f=d(l),g=u(l),y=g*(e-r)/2+f*(t-o)/2,h=-f*(e-r)/2+g*(t-o)/2,_=m(y),x=m(h),A=m(i),T=m(s),b=_/A+x/T;b>1?(i=p(b)*c(i),s=p(b)*c(s)):(i=c(i),s=c(s));const E=n===a?-1:1,v=p((A*T-A*x-T*_)/(A*x+T*_))*E,R=v*(i*h)/s,S=v*(-s*y)/i,w=g*R-f*S+(e+r)/2,C=f*R+g*S+(t+o)/2,F=vectorAngle([1,0],[(y-R)/i,(h-S)/s]);let I=deg(vectorAngle([(y-R)/i,(h-S)/s],[(-y-R)/i,(-h-S)/s]))%360;return 0===a&&I>0&&(I-=360),1===a&&I<0&&(I+=360),{cx:w,cy:C,theta:F,dTheta:rad(I)}}function vectorAngle([e,t],[r,o]){const{acos:n,sqrt:a}=Math;return(e*o-t*r<0?-1:1)*n((e*r+t*o)/(a(e*e+t*t)*a(r*r+o*o)))}g2d.Annulus=async(e,t)=>{let r=await interpretate(e[0],t),o=await interpretate(e[1],t);Array.isArray(o)||(o=[o,o]);let n=(await interpretate(e[2],t)).map(e=>2*Math.PI-e);const a=t.xAxis,i=t.yAxis,[s,l]=o,c=a(s)-a(0),d=Math.abs(i(s)-i(0)),u=a(l)-a(0),p=Math.abs(i(l)-i(0)),m=a(r[0]),f=i(r[1]),[g,y]=n,h=y-g>Math.PI?0:1,_=[`M ${m+c*Math.cos(g)} ${f+d*Math.sin(g)}`,`A ${c} ${d} 0 ${h} 0 ${m+c*Math.cos(y)} ${f+d*Math.sin(y)}`,`L ${m+u*Math.cos(y)} ${f+p*Math.sin(y)}`,`A ${u} ${p} 0 ${h} 1 ${m+u*Math.cos(g)} ${f+p*Math.sin(g)}`,"Z"].join(" ");return t.svg.append("path").attr("vector-effect","non-scaling-stroke").style("fill",t.color).style("opacity",t.opacity).attr("d",_)},g2d._arc=async(e,t)=>{let r=await interpretate(e[0],t),o=await interpretate(e[1],t);Array.isArray(o)||(o=[o,o]);let n=(await interpretate(e[2],t)).map(e=>2*Math.PI-e);const a=t.xAxis,i=t.yAxis,s={cx:a(r[0]),cy:i(r[1]),phi:0,rx:a(o[0])-a(0),ry:Math.abs(i(o[1])-i(0)),start:n[0],delta:n[1]-n[0]},{x1:l,y1:c,x2:d,y2:u,fa:p,fs:m}=getEndpointParameters(s.cx,s.cy,s.rx,s.ry,s.phi,s.start,s.delta),{cx:f,cy:g,theta:y,dTheta:h}=getCenterParameters(l,c,d,u,p,m,s.rx,s.ry,s.phi),_=t.svg.append("path").attr("vector-effect","non-scaling-stroke").style("stroke",t.stroke||t.color).style("stroke-width",t.strokeWidth).style("opacity",t.opacity).attr("d",`M ${f} ${g}\n         L ${l} ${c}\n         A ${s.rx} ${s.ry} ${deg(s.phi)} ${p} ${m} ${d} ${u}\n         Z`);return _.style("fill",t.filled?t.color:"none"),_},g2dComplex.Disk=async(e,t)=>{if(e.length>2)throw"Graphics complex with arcs is not supported";let r=await interpretate(e[0],t),o=1;e.length>1&&(o=await interpretate(e[1],t),Array.isArray(o)&&(o=(o[0]+o[1])/2));const n=t.xAxis;if(t.yAxis,r[0]){const e=[],a=n(o)-n(0);return r.map(e=>t.wgl.fallbackVertices[e-1]).map(r=>{e.push(t.svg.append("circle").attr("vector-effect","non-scaling-stroke").attr("cx",r[0]).attr("cy",r[1]).attr("r",a).style("stroke","none").style("fill",t.color).style("opacity",t.opacity))}),e}{const e=t.wgl.fallbackVertices[r-1],a=[e[0],e[1]],i=n(o)-n(0);return t.svg.append("circle").attr("vector-effect","non-scaling-stroke").attr("cx",a[0]).attr("cy",a[1]).attr("r",i).style("stroke","none").style("fill",t.color).style("opacity",t.opacity)}},g2d.Disk=async(e,t)=>{if(e.length>2)return await g2d._arc(e,{...t,filled:!0});let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let o=[1,1];e.length>1&&(o=await interpretate(e[1],t),Array.isArray(o)||(o=[o,o]));const n=t.xAxis,a=t.yAxis;t.local.coords=[n(r[0]),a(r[1])],t.local.r=[n(o[0])-n(0),Math.abs(a(o[1])-a(0))];const i=t.svg.append("ellipse").attr("vector-effect","non-scaling-stroke").attr("cx",n(r[0])).attr("cy",a(r[1])).attr("rx",t.local.r[0]).attr("ry",t.local.r[1]).style("stroke",t.stroke).attr("stroke-width",t.strokeWidth).style("fill",t.color).style("opacity",t.opacity);return t.local.object=i,t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),i},g2d.Disk.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());let o=t.local.r;e.length>1&&(o=await interpretate(e[1],t),Array.isArray(o)||(o=[o,o]));const n=t.xAxis,a=t.yAxis;t.local.coords=[n(r[0]),a(r[1])],t.local.r=[n(o[0])-n(0),Math.abs(a(o[1])-a(0))],t.local.object.maybeTransition(t.transitionType,t.transitionDuration).attr("cx",t.local.coords[0]).attr("cy",t.local.coords[1]).attr("rx",t.local.r[0]).attr("ry",t.local.r[1])},g2d.Disk.updateColor=(e,t)=>{t.local.object.style("fill",t.color)},g2d.Disk.updateOpacity=(e,t)=>{t.local.object.style("opacity",t.opacity)},g2d.Disk.virtual=!0,g2d.Disk.destroy=(e,t)=>{t.local&&t.local.object&&(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.object.remove(),delete t.local.object)},g2dComplex.Point=async(e,t)=>{let r=await interpretate(e[0],t),o=d3.color(t.color);if(o=[o.r/255,o.g/255,o.b/255,t.opacity],r[0][0])return;const{gl:n,programInfo:a}=t.wgl;let i,s=r.flat(1/0).map(e=>e-1);t.wgl.fallbackVertices.length>65535?(console.warn("Vertex buffer is too large and may not be indexed correctly"),i=twgl.createBufferInfoFromArrays(n,{indices:new Uint32Array(s)})):i=twgl.createBufferInfoFromArrays(n,{indices:new Uint16Array(s)}),twgl.setBuffersAndAttributes(n,a,i),twgl.setUniforms(a,{u_resolution:[n.canvas.width,n.canvas.height],u_color:o,u_pointSize:t.pointSize*window.devicePixelRatio*100*2,u_vertexColor:Boolean(t.wgl.vertexColors)}),t.wgl.fallbackVertices.length>65535?n.drawElements(n.POINTS,i.numElements,n.UNSIGNED_INT,0):n.drawElements(n.POINTS,i.numElements,n.UNSIGNED_SHORT,0)},g2d.Point=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const o=t.xAxis,n=t.yAxis,a=arrdims(r);0===a?r=[]:a<2&&(r=[r]);const i=t.svg.append("g").style("stroke-width",100*t.pointSize*2).style("stroke-linecap","round").style("stroke",t.color).style("opacity",t.opacity);t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root);const s=[];return r.forEach((e,t)=>{s.push(i.append("path").attr("d",`M ${o(e[0])} ${n(e[1])} l 0.0001 0`).attr("vector-effect","non-scaling-stroke"))}),t.local.points=s,t.local.object=i,i},g2d.Point.updateColor=(e,t)=>{t.local.object.style("stroke",t.color)},g2d.Point.updateOpacity=(e,t)=>{t.local.object.style("opacity",t.opacity)},g2d.Point.update=async(e,t)=>{let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const o=arrdims(r);0===o?r=[]:o<2&&(r=[r]);const n=t.xAxis,a=t.yAxis;let i;const s=t.local.object,l=Math.min(t.local.points.length,r.length);let c=[0,0];for(let e=t.local.points.length;e<r.length;e++)e-1>=0&&(c=r[e-1]),i=s.append("path").attr("d",`M ${n(c[0])} ${a(c[1])} l 0.0001 0`).attr("vector-effect","non-scaling-stroke"),t.local.points.push(i),i=i.maybeTransition(t.transitionType,t.transitionDuration).attr("d",`M ${n(r[e][0])} ${a(r[e][1])} l 0.0001 0`);for(let e=t.local.points.length;e>r.length;e--)i=t.local.points.pop(),i.remove();for(let e=0;e<l;e++)i=t.local.points[e].maybeTransition(t.transitionType,t.transitionDuration).attr("d",`M ${n(r[e][0])} ${a(r[e][1])} l 0.0001 0`);return i},g2d.Point.virtual=!0,g2d.Point.destroy=(e,t)=>{t.local&&t.local.object&&(t.colorRefs&&delete t.colorRefs[t.root.uid],Array.isArray(t.local.object)?t.local.object.forEach(e=>e.remove()):t.local.object.remove(),delete t.local.object)};const getCanvas=e=>{let t={k:1,x:0,y:0};e.onZoom.push(e=>{t=e});const r={xAxis:e.xAxis,yAxis:e.yAxis};return e.xAxis=e=>0,e.yAxis=e=>0,e.xAxis.invert=o=>{const n=(o-t.x-e.panZoomEntites.left)/t.k;return r.xAxis.invert(n)},e.yAxis.invert=o=>{const n=(o-t.y-e.panZoomEntites.top)/t.k;return r.yAxis.invert(n)},e.panZoomEntites.canvas};function makeStadiumPath(e,t,r){const o=e[0],n=e[1],a=t[0],i=t[1];if(0===r||o===a&&n===i){if(0===r)return`M ${o} ${n} Z`;const e=o-r;return[`M ${e} ${n}`,`A ${r} ${r} 0 1 0 ${o+r} ${n}`,`A ${r} ${r} 0 1 0 ${e} ${n}`,"Z"].join(" ")}const s=a-o,l=i-n,c=Math.sqrt(s*s+l*l),d=s/c,u=-(l/c);return["M",o+u*r,n+d*r,"A",r,r,0,0,1,o-u*r,n-d*r,"L",a-u*r,i-d*r,"A",r,r,0,0,1,a+u*r,i+d*r,"Z"].join(" ")}async function _triangle__normalizeInput(e,t){let r=await interpretate(e[0],t);r instanceof NumericArrayObject&&(r=r.normal());const o=e=>e instanceof NumericArrayObject?e.normal():Array.isArray(e)?e:[e[0],e[1]];return(Array.isArray(r)&&3===r.length&&r.every(e=>Array.isArray(e)&&e.length>=2&&"number"==typeof e[0]&&"number"==typeof e[1])?[r]:r).map(e=>e.map(o))}g2d.EventListener=async(e,t)=>{const r=await interpretate(e[1],t),o={...t};let n=await interpretate(e[0],o);return n?Array.isArray(n)&&(n=n[0]):n=getCanvas(o),n.on_list||(n.on_list={}),r.forEach(e=>{g2d.EventListener[e.lhs](e.rhs,n,o)}),null},g2d.EventListener.update=async(e,t)=>{console.log("EventListener does not support updates")},g2d.EventListener.onload=(e,t,r)=>{console.log("onload event generator"),server.kernel.emitt(e,"True","onload")},g2d.MiddlewareListener=async(e,t)=>{const r=await core._getRules(e,t),o=await interpretate(e[1],t),n=await interpretate(e[2],t);return console.log(e),t.local.middleware=g2d.MiddlewareListener[o](n,r,t),await interpretate(e[0],t)},g2d.MiddlewareListener.update=(e,t)=>interpretate(e[0],t),g2d.MiddlewareListener.end=(e,t,r)=>{const o=t.Threshold||1;return server.kernel.emitt(e,"True","end"),console.log("pre Fire"),t=>{let r=!1;return t.then(t=>t.tween(e,function(t){return function(t){t>=o&&!r&&(server.kernel.emitt(e,"True","end"),r=!0)}}))}},g2d.MiddlewareListener.endtransition=g2d.MiddlewareListener.end,g2d.EventListener.drag=(e,t,r)=>{const o=r.xAxis,n=r.yAxis;let a=null;t.classed("cursor-pointer",!0);const i=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"drag")});t.call(d3.drag().on("start",function(e,t){a=this.getBBox()}).on("drag",function(e,t){if(!a)return;const r=e.x-a.width/2-a.x,s=e.y-a.height/2-a.y;d3.select(this).raise().attr("transform",`translate(${r},${s})`),i(o.invert(e.x),n.invert(e.y))}).on("end",function(e,t){}))},g2d.EventListener.dragsignal=(e,t,r)=>{console.log("dragsignal event generator"),console.log(r.local),t.classed("cursor-pointer",!0);let o={k:1,x:0,y:0};r.onZoom.push(e=>{o=e});const n=e=>{const t=(e-o.x-r.panZoomEntites.left)/o.k;return r.xAxis.invert(t)},a=e=>{const t=(e-o.y-r.panZoomEntites.top)/o.k;return r.yAxis.invert(t)},i=r.panZoomEntites.canvas.node();let s=[0,0];const l=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"dragsignal")});function c(e){const t=d3.pointer(e,i),r=t[0]+0*s[0],o=t[1]+0*s[1];l(n(r),a(o))}function d(){i.removeEventListener("mousemove",c),i.removeEventListener("mouseup",d)}t.on("mousedown",function(e){e.stopPropagation(),e.preventDefault();const t=e.target.getBBox(),r=[t.x+t.width/2,t.y+t.height/2],o=d3.pointer(e,i);s=[r[0]-o[0],r[1]-o[1]];const u=o[0],p=o[1];l(n(u),a(p)),i.addEventListener("mousemove",c),i.addEventListener("mouseup",d)})},g2d.EventListener.dragall=(e,t,r)=>{console.log("drag event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis;const a=throttle((t,r,o)=>{server.kernel.io.fire(e,[String(o),[t,r]],"dragall")});t.call(d3.drag().on("start",function(e,t){a(o.invert(e.x),n.invert(e.y),"dragstarted")}).on("drag",function(e,t){a(o.invert(e.x),n.invert(e.y),"dragged")}).on("end",function(e,t){a(o.invert(e.x),n.invert(e.y),"dragended")}))},g2d.EventListener.click=(e,t,r)=>{console.log("click event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis,a=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"click")});function i(e,t){e.altKey||a(o.invert(t[0]),n.invert(t[1]))}t.classed("cursor-pointer",!0),"click"in t.on_list?t.on_list.click.push(e=>i(e,d3.pointer(e))):(t.on_list.click=[e=>i(e,d3.pointer(e))],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)}))},g2d.EventListener.mousedown=(e,t,r)=>{console.log("mousedown event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis,a=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousedown")});t.on("mousedown",e=>{return t=d3.pointer(e),void a(o.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.mouseup=(e,t,r)=>{console.log("mouseup event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis,a=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseup")});t.on("mouseup",e=>{return t=d3.pointer(e),void a(o.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.altclick=(e,t,r)=>{console.log("click event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis,a=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"altclick")});function i(e,t){e.altKey&&a(o.invert(t[0]),n.invert(t[1]))}"click"in t.on_list?t.on_list.click.push(e=>i(e,d3.pointer(e))):(t.on_list.click=[e=>i(e,d3.pointer(e))],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)}))},g2d.EventListener.capturekeydown=(e,t,r)=>{let o,n=!0;const a=t;o=()=>{n&&(a.node().focus(),n=!1)};var i;i=o,"click"in t.on_list?t.on_list.click.push(i):(t.on_list.click=[i],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)})),a.on("blur",()=>{n=!0}),a.node().addEventListener("keydown",t=>{server.kernel.emitt(e,'"'+t.code+'"',"capturekeydown"),t.preventDefault()})},g2d.EventListener.keydown=(e,t,r)=>{let o,n=!0;const a=t;o=()=>{n&&(a.node().focus(),n=!1)};var i;i=o,"click"in t.on_list?t.on_list.click.push(i):(t.on_list.click=[i],t.on("click",e=>{for(let r=0;r<t.on_list.click.length;++r)t.on_list.click[r](e)})),a.on("blur",()=>{n=!0}),a.addEventListener("keydown",t=>{server.kernel.emitt(e,'"'+t.code+'"',"keydown")})},g2d.EventListener.mousemove=(e,t,r)=>{console.log("mouse event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis,a=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousemove")});t.on("mousemove",e=>{return t=d3.pointer(e),void a(o.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.mouseover=(e,t,r)=>{console.log("mouse event generator"),console.log(r.local);const o=r.xAxis,n=r.yAxis,a=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseover")});t.on("mouseover",e=>{return t=d3.pointer(e),void a(o.invert(t[0]),n.invert(t[1]));var t})},g2d.EventListener.zoom=(e,t,r)=>{console.log("zoom event generator"),console.log(r.local);const o=throttle(t=>{server.kernel.io.fire(e,t,"zoom")});t.call(d3.zoom().on("zoom",function(e){console.log(),o(e.transform.k)}))},g2d.Rotate=async(e,t)=>{const r=await interpretate(e[1],t);let o;e.length>2&&(o=await interpretate(e[2],t),t.local.aligment=o);const n=t.svg.append("g");t.local.group=n,await interpretate(e[0],{...t,svg:n});let a=n.node().getBBox();o?(a.x=t.xAxis(o[0]),a.y=t.yAxis(o[1])):(a.x=a.x+a.width/2,a.y=a.y+a.height/2);const i="rotate("+r/Math.PI*180+", "+a.x+", "+a.y+")";n.attr("transform",i),t.local.rotation=i},g2d.Rotate.update=async(e,t)=>{const r=await interpretate(e[1],t);let o;o=t.local.group.node().getBBox(),t.local.aligment?(o.x=t.xAxis(t.local.aligment[0]),o.y=t.yAxis(t.local.aligment[1])):(o.x=o.x+o.width/2,o.y=o.y+o.height/2);const n="rotate("+r/Math.PI*180+", "+o.x+", "+o.y+")";var a=d3.interpolateString(t.local.rotation,n);t.local.group.maybeTransitionTween(t.transitionType,t.transitionDuration,"transform",function(e,t,r){return a}),t.local.rotation=n},g2d.Rotate.virtual=!0,g2d.Rotate.destroy=(e,t)=>{console.log("nothing to destroy")},g2d.GraphicsBoxOptions=()=>{},g2d.StrokeForm=()=>{},g2d.FontOpacity=()=>{},g2d.GeometricTransformation=async(e,t)=>{let r=await interpretate(e[1],t);const o=t.svg.append("g");t.local.group=o;const n=t.xAxis,a=t.yAxis;if(r.length>3){for(let i of r){if(!Array.isArray(i))continue;const r=o.append("g");i=i[0],"number"==typeof i[0]&&("number"==typeof i[1]&&(i=[n(i[0])-n(0),a(i[1])-a(0)],r.attr("transform",`translate(${i.join(",")})`),await interpretate(e[0],{...t,svg:r})))}return o}return await interpretate(e[0],{...t,svg:o}),console.warn(r),2==r.length?(r[0][0][1]=-r[0][0][1],r[0][1][0]=-r[0][1][0],r[0]=r[0].flat(1/0),r[1]=[n(r[1][0])-n(0),a(r[1][1])-a(0)],o.attr("transform",`matrix(${r[0].join(",")},${r[1].join(",")})`)):(r[0][1]=-r[0][1],r[1][0]=-r[1][0],r=r.flat(1/0),o.attr("transform",`matrix(${r.join(",")})`))},g2d.Translate=async(e,t)=>{let r=await interpretate(e[1],t);const o=t.svg.append("g");t.local.group=o;const n=t.xAxis,a=t.yAxis;if(r instanceof NumericArrayObject&&(r=r.normal()),Array.isArray(r[0])){const i=o.append("g"),s=[i];t.local.subgroups=s,i.attr("transform",`translate(${n(r[0][0])-n(0)}, ${a(r[0][1])-a(0)})`);const l=i.append("g");await interpretate(e[0],{...t,svg:l});for(let e=1;e<r.length;++e){const t=o.append("g"),i=r[e];s.push(t),t.attr("transform",`translate(${n(i[0])-n(0)}, ${a(i[1])-a(0)})`),t.append(()=>l.clone(!0).node())}return o}return o.attr("transform",`translate(${n(r[0])-n(0)}, ${a(r[1])-a(0)})`),await interpretate(e[0],{...t,svg:o}),o},g2d.Translate.update=async(e,t)=>{let r=await interpretate(e[1],t);r instanceof NumericArrayObject&&(r=r.normal());const o=t.xAxis,n=t.yAxis;if(!t.local.subgroups)return t.local.group.maybeTransition(t.transitionType,t.transitionDuration).attr("transform",`translate(${o(r[0])-o(0)}, ${n(r[1])-n(0)})`);for(let e=0;e<t.local.subgroups.length;++e){const a=r[e];t.local.subgroups[e].maybeTransition(t.transitionType,t.transitionDuration).attr("transform",`translate(${o(a[0])-o(0)}, ${n(a[1])-n(0)})`)}},g2d.Translate.virtual=!0,g2d.Translate.destroy=(e,t)=>{t.local.group.remove()},g2d.Center=()=>"Center",g2d.Center.update=g2d.Center,g2d.Top=()=>"Top",g2d.Top.update=g2d.Top,g2d.Bottom=()=>"Bottom",g2d.Bottom.update=g2d.Bottom,g2d.Left=()=>"Left",g2d.Left.update=g2d.Left,g2d.Right=()=>"Right",g2d.Right.update=g2d.Right,g2d.Degree=()=>Math.PI/180,g2d.Degree.update=g2d.Degree,g2d.RoundingRadius=()=>"RoundingRadius",g2d.RoundingRadius.update=()=>"RoundingRadius",g2d.Rectangle=async(e,t)=>{let r=await interpretate(e[0],t),o=await interpretate(e[1],t);const n=await core._getRules(e,t);if(r instanceof NumericArrayObject&&(r=r.normal()),o instanceof NumericArrayObject&&(o=o.normal()),r[1]>o[1]){const e=r[1];r[1]=o[1],o[1]=e}if(r[0]>o[0]){const e=r[0];r[0]=o[0],o[0]=e}const a=t.xAxis,i=t.yAxis;r[0]=a(r[0]),r[1]=i(r[1]),o[0]=a(o[0]),o[1]=i(o[1]);const s=[Math.abs(o[0]-r[0]),Math.abs(o[1]-r[1])];return t.local.rect=t.svg.append("rect").attr("x",r[0]).attr("y",r[1]-s[1]).attr("width",s[0]).attr("height",s[1]).attr("vector-effect","non-scaling-stroke").attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity).attr("fill",t.color),n.RoundingRadius&&("number"==typeof n.RoundingRadius?t.local.rect.attr("rx",50*n.RoundingRadius/.75):Array.isArray(n.RoundingRadius)&&(t.local.rect.attr("rx",50*n.RoundingRadius[0]/.75),t.local.rect.attr("ry",50*n.RoundingRadius[1]/.75))),t.dasharray&&t.local.rect.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.rect},g2d.Rectangle.updateColor=(e,t)=>{t.local.rect.attr("fill",t.color)},g2d.Rectangle.updateOpacity=(e,t)=>{t.local.rect.attr("opacity",t.opacity)},g2d.Rectangle.update=async(e,t)=>{let r=await interpretate(e[0],t),o=await interpretate(e[1],t);const n=await core._getRules(e,t);if(r instanceof NumericArrayObject&&(r=r.normal()),o instanceof NumericArrayObject&&(o=o.normal()),r[1]>o[1]){const e=r[1];r[1]=o[1],o[1]=e}if(r[0]>o[0]){const e=r[0];r[0]=o[0],o[0]=e}const a=t.xAxis,i=t.yAxis;r[0]=a(r[0]),r[1]=i(r[1]),o[0]=a(o[0]),o[1]=i(o[1]);const s=[Math.abs(o[0]-r[0]),Math.abs(o[1]-r[1])];t.local.rect.maybeTransition(t.transitionType,t.transitionDuration).attr("x",r[0]).attr("y",r[1]-s[1]).attr("width",s[0]).attr("height",s[1]),n.RoundingRadius&&("number"==typeof n.RoundingRadius?t.local.rect.attr("rx",50*n.RoundingRadius/.75):Array.isArray(n.RoundingRadius)&&(t.local.rect.attr("rx",50*n.RoundingRadius[0]/.75),t.local.rect.attr("ry",50*n.RoundingRadius[1]/.75)))},g2d.Rectangle.virtual=!0,g2d.Rectangle.destroy=(e,t)=>{console.log("nothing to destroy"),t.local&&t.local.rect&&(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.rect.remove(),delete t.local.rect)},g2d.StadiumShape=async(e,t)=>{let r=await interpretate(e[0],t),o=await interpretate(e[1],t);await core._getRules(e,t),r instanceof NumericArrayObject&&(r=r.normal()),o instanceof NumericArrayObject&&(o=o.normal()),Array.isArray(o)&&(o=o[0]);let n=r[0],a=r[1];n instanceof NumericArrayObject&&(n=n.normal()),a instanceof NumericArrayObject&&(a=a.normal());const i=t.xAxis,s=t.yAxis,l=[i(n[0]),s(n[1])],c=[i(a[0]),s(a[1])];let d=0;"number"==typeof o&&(d=Math.abs(i(n[0]+o)-i(n[0])));const u=makeStadiumPath(l,c,d);return t.local.stadium=t.svg.append("path").attr("d",u).attr("vector-effect","non-scaling-stroke").attr("fill",t.color).attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity),t.dasharray&&t.local.stadium.attr("stroke-dasharray",t.dasharray.join()),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.stadium},g2d.StadiumShape.updateColor=(e,t)=>{t.local&&t.local.stadium&&t.local.stadium.attr("fill",t.color)},g2d.StadiumShape.updateOpacity=(e,t)=>{t.local&&t.local.stadium&&t.local.stadium.attr("opacity",t.opacity)},g2d.StadiumShape.update=async(e,t)=>{let r=await interpretate(e[0],t),o=await interpretate(e[1],t);await core._getRules(e,t),r instanceof NumericArrayObject&&(r=r.normal()),o instanceof NumericArrayObject&&(o=o.normal()),Array.isArray(o)&&(o=o[0]);let n=r[0],a=r[1];n instanceof NumericArrayObject&&(n=n.normal()),a instanceof NumericArrayObject&&(a=a.normal());const i=t.xAxis,s=t.yAxis,l=[i(n[0]),s(n[1])],c=[i(a[0]),s(a[1])];let d=0;"number"==typeof o&&(d=Math.abs(i(n[0]+o)-i(n[0])));const u=makeStadiumPath(l,c,d);t.local.stadium.maybeTransition(t.transitionType,t.transitionDuration).attr("d",u)},g2d.StadiumShape.virtual=!0,g2d.StadiumShape.destroy=(e,t)=>{console.log("StadiumShape destroy"),t.local&&t.local.stadium&&(t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local.stadium.remove(),delete t.local.stadium)},g2d.Triangle=async(e,t)=>{const r=await _triangle__normalizeInput(e,t),o=t.xAxis,n=t.yAxis;t.local||(t.local={}),t.local.triGroup=t.svg.append("g");const a=r.map(e=>e.map(([e,t])=>[o(e),n(t)]));let i=t.local.triGroup.selectAll("polygon").data(a);const s=i.enter().append("polygon").attr("vector-effect","non-scaling-stroke").attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity).attr("fill",t.color).attr("points",e=>e.map(([e,t])=>`${e},${t}`).join(" "));return t.dasharray&&s.attr("stroke-dasharray",t.dasharray.join()),t.local.triangles=s.merge(i),t.colorRefs&&(t.colorRefs[t.root.uid]=t.root),t.opacityRefs&&(t.opacityRefs[t.root.uid]=t.root),t.local.triGroup},g2d.Tooltip=async(e,t)=>{try{await interpretate(e[0],t)}catch(e){console.error(e)}},g2d.Tooltip.update=g2d.Tooltip,g2d.Triangle.updateColor=(e,t)=>{t.local?.triGroup&&t.local.triGroup.selectAll("polygon").attr("fill",t.color)},g2d.Triangle.updateOpacity=(e,t)=>{t.local?.triGroup&&t.local.triGroup.selectAll("polygon").attr("opacity",t.opacity)},g2d.Triangle.update=async(e,t)=>{const r=await _triangle__normalizeInput(e,t),o=t.xAxis,n=t.yAxis,a=r.map(e=>e.map(([e,t])=>[o(e),n(t)]));let i=t.local.triGroup.selectAll("polygon").data(a);i.exit().remove();const s=i.enter().append("polygon").attr("vector-effect","non-scaling-stroke").attr("stroke",t.stroke).attr("stroke-width",t.strokeWidth).attr("opacity",t.opacity).attr("fill",t.color);t.dasharray&&s.attr("stroke-dasharray",t.dasharray.join()),i=s.merge(i),i.maybeTransition(t.transitionType,t.transitionDuration).attr("points",e=>e.map(([e,t])=>`${e},${t}`).join(" "))},g2d.Triangle.virtual=!0,g2d.Triangle.destroy=(e,t)=>{t.colorRefs&&delete t.colorRefs[t.root.uid],t.opacityRefs&&delete t.opacityRefs[t.root.uid],t.local?.triGroup&&(t.local.triGroup.remove(),delete t.local.triGroup),t.local?.triangles&&delete t.local.triangles},g2d.Void=(e,t)=>{},g2d.Identity=g2d.Void,g2d.Scaled=async(e,t)=>{if(1==e.length){const r=await interpretate(e[0],t);return[r[0]*(t.plotRange[0][1]-t.plotRange[0][0])+t.plotRange[0][0],r[1]*(t.plotRange[1][1]-t.plotRange[1][0])+t.plotRange[1][0]]}{const r=await interpretate(e[0],t),o=await interpretate(e[1],t);return[r[0]*(t.plotRange[0][1]-t.plotRange[0][0])+o[0],r[1]*(t.plotRange[1][1]-t.plotRange[1][0])+o[1]]}},g2d.Scaled.update=g2d.Scaled,g2d.GoldenRatio=g2d.Void,g2d.None=()=>!1,g2d.AbsolutePointSize=g2d.Void,g2d.CopiedValueFunction=g2d.Void,g2d.Raster=async(e,t)=>{if(t.image)return await interpretate(e[0],t);const r=await interpretate(e[0],{...t,context:g2d,nfast:!0,numeric:!0});console.log(e);const o=r.length,n=r[0].length,a=r[0][0].length,i=t.xAxis,s=t.yAxis;let l=[[0,n],[0,o]];if(e.length>1){const r=await interpretate(e[1],t);l[0][0]=r[0][0],l[0][1]=r[1][0],l[1][0]=r[0][1],l[1][1]=r[1][1]}e.length>2&&(await interpretate(e[2],t),console.warn("scaling is not implemented!"));const c=Math.abs((i(l[0][1])-i(l[0][0]))/n),d=Math.abs((s(l[1][1])-s(l[1][0]))/o),u=(l[0][1]-l[0][0])/n,p=(l[1][1]-l[1][0])/o,m=t.svg;if(a)if(2!==a)if(3!==a)if(4!==a);else for(let e=0;e<o;++e)for(let t=0;t<n;++t)m.append("rect").attr("x",i(u*t+l[0][0])).attr("y",s(p*e+l[1][0])-d).attr("width",c).attr("height",d).attr("opacity",r[e][t][3]).attr("fill",`rgb(${Math.floor(255*r[e][t][0])}, ${Math.floor(255*r[e][t][1])}, ${Math.floor(255*r[e][t][2])})`);else for(let e=0;e<o;++e)for(let o=0;o<n;++o)m.append("rect").attr("x",i(u*o+l[0][0])).attr("y",s(p*e+l[1][0])-d).attr("width",c).attr("height",d).attr("opacity",t.opacity).attr("fill",`rgb(${Math.floor(255*r[e][o][0])}, ${Math.floor(255*r[e][o][1])}, ${Math.floor(255*r[e][o][2])})`);else for(let e=0;e<o;++e)for(let t=0;t<n;++t)m.append("rect").attr("x",i(u*t+l[0][0])).attr("y",s(p*e+l[1][0])-d).attr("width",c).attr("height",d).attr("opacity",r[e][t][1]).attr("fill",`rgb(${Math.floor(255*r[e][t][0])}, ${Math.floor(255*r[e][t][0])}, ${Math.floor(255*r[e][t][0])})`);else for(let e=0;e<o;++e)for(let o=0;o<n;++o)m.append("rect").attr("x",i(u*o+l[0][0])).attr("y",s(p*e+l[1][0])-d).attr("width",c).attr("height",d).attr("opacity",t.opacity).attr("fill",`rgb(${Math.floor(255*r[e][o])}, ${Math.floor(255*r[e][o])}, ${Math.floor(255*r[e][o])})`)},g2d.Magnification=()=>"Magnification",g2d.ColorSpace=()=>"ColorSpace",g2d.Interleaving=()=>"Interleaving",g2d.MetaInformation=()=>"MetaInformation",g2d.ImageResolution=()=>"ImageResolution",g2d.DateObject=()=>{console.warn("Date Object is not supported for now")};const numericAccelerator={TypeReal:{},TypeInteger:{}},types={Real64:{context:numericAccelerator.TypeReal,constructor:Float64Array},Real32:{context:numericAccelerator.TypeReal,constructor:Float32Array},Integer32:{context:numericAccelerator.TypeInteger,constructor:Int32Array},Integer64:{context:numericAccelerator.TypeInteger,constructor:BigInt64Array},Integer16:{context:numericAccelerator.TypeInteger,constructor:Int16Array},Integer8:{context:numericAccelerator.TypeInteger,constructor:Int8Array},UnsignedInteger32:{context:numericAccelerator.TypeInteger,constructor:Uint32Array},UnsignedInteger64:{context:numericAccelerator.TypeInteger,constructor:BigUint64Array},UnsignedInteger16:{context:numericAccelerator.TypeInteger,constructor:Uint16Array},UnsignedInteger8:{context:numericAccelerator.TypeInteger,constructor:Uint8Array}};function checkdims(e,t=[]){return Array.isArray(e)?(t.push(e.length),checkdims(e[0],t)):t}const WLNumber=new RegExp(/^(-?\d+)(.?\d*)(\*\^)?(\d*)/),isInteger=window.isNumeric;function readArray(e,t){if(Array.isArray(e[1]))for(let r=1;r<e.length;++r)readArray(e[r],t);else t.array.set(e.slice(1).map(e=>{if("string"==typeof e){if(isInteger(e))return parseInt(e);if(WLNumber.test(e)){let[t,r,o,n,a]=e.split(WLNumber);return r+="."===o?o+"0":o,n&&(r+="E"+a),parseFloat(r)}}return e}),t.index),t.index+=e.length-1}function moveRGBAReal(e,t,r){var o,n=0;for(o=0;o<r<<2;)t[o++]=255*e[n++]>>>0,t[o++]=255*e[n++]>>>0,t[o++]=255*e[n++]>>>0,t[o++]=255*e[n++]>>>0}function moveRGBReal(e,t,r){var o,n=0;const a=new Uint32Array(t.buffer);for(o=0;o<r;o++)a[o]=4278190080+(255*e[n++]>>>0)+(255*e[n++]>>>0<<8)+(255*e[n++]>>>0<<16)}function moveRGBReal2(e,t,r){var o,n=0;const a=new Uint32Array(t.buffer);for(o=0;o<r;o++)a[o]=4278190080+(255*e[n++]>>>0)+(255*e[n++]>>>0<<8)}function moveRGBRealTransposed(e,t,r){const o=new Uint32Array(t.buffer),n=r,a=2*r;for(let t=0;t<r;t++){const r=255*e[t]>>>0,i=255*e[n+t]>>>0,s=255*e[a+t]>>>0;o[t]=4278190080+r+(i<<8)+(s<<16)}}function moveGrayReal(e,t,r){var o;const n=new Uint32Array(t.buffer);for(o=0;o<r;o++){const t=255*e[o]>>>0;n[o]=4278190080+(t<<16)+(t<<8)+t}}function moveRGB(e,t,r){var o,n=0;const a=new Uint32Array(t.buffer);for(o=0;o<r;o++)a[o]=4278190080+e[n++]+(e[n++]<<8)+(e[n++]<<16)}function moveRGBTransposed(e,t,r){const o=new Uint32Array(t.buffer),n=r,a=2*r;for(let t=0;t<r;t++){const r=e[t],i=e[n+t],s=e[a+t];o[t]=4278190080+r+(i<<8)+(s<<16)}}function moveRGBATransposed(e,t,r){const o=new Uint32Array(t.buffer),n=r,a=2*r,i=3*r;for(let t=0;t<r;t++){const r=e[t],s=e[n+t],l=e[a+t],c=e[i+t];o[t]=(c<<24)+r+(s<<8)+(l<<16)}}function moveRGB2(e,t,r){var o,n=0;const a=new Uint32Array(t.buffer);for(o=0;o<r;o++)a[o]=4278190080+e[n++]+(e[n++]<<8)}function moveGray(e,t,r){var o;const n=new Uint32Array(t.buffer);for(o=0;o<r;o++){const t=e[o];n[o]=4278190080+(t<<16)+(t<<8)+t}}function moveGrayBits(e,t,r){var o;const n=new Uint32Array(t.buffer);for(o=0;o<r;o++){const t=e[o]<<8;n[o]=4278190080+(t<<16)+(t<<8)+t}}numericAccelerator.NumericArray=(e,t)=>{const r=types[interpretate(e[1])],o=[];let n=e[0].length-1;o.push(n),"List"===e[0][1][0]&&(n*=e[0][1].length-1,o.push(e[0][1].length-1),"List"===e[0][1][1][0]&&(n*=e[0][1][1].length-1,o.push(e[0][1][1].length-1)));const a=new r.constructor(n);return readArray(e[0],{index:0,array:a}),{buffer:a,dims:o}},numericAccelerator.NumericArray.update=numericAccelerator.NumericArray;const imageTypes={Byte:{constructor:Uint8Array,convert:e=>{if(3===e.dims.length){if(4===e.dims[2]){return new Uint8ClampedArray(e.buffer)}if(3===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGB(e.buffer,r,t),r}if(2===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGB2(e.buffer,r,t),r}throw console.error(e),"It must be RGB or RGBA or RG!"}if(2===e.dims.length){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGray(e.buffer,r,t),r}throw"This is not an image data!"},convert_nonInterleaved:e=>{const t=e.dims[0];if(3===t||4===t){const r=e.dims[2]*e.dims[1],o=new Uint8ClampedArray(r<<2);return 3===t?moveRGBTransposed(e.buffer,o,r):moveRGBATransposed(e.buffer,o,r),o}throw console.error(e),"convert_nonInterleaved has limited support"}},Bit:{constructor:Uint8Array,convert:e=>{const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGrayBits(e.buffer,r,t),r}},Real32:{constructor:Float32Array,convert:e=>{if(3===e.dims.length){if(4===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBAReal(e.buffer,r,t),r}if(3===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal(e.buffer,r,t),r}if(2===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal2(e.buffer,r,t),r}throw console.error(e),"It must be RGB or RGBA or RG!"}if(2===e.dims.length){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGrayReal(e.buffer,r,t),r}throw"This is not an image data!"},convert_nonInterleaved:e=>{if(3===e.dims[0]){const t=e.dims[2]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBRealTransposed(e.buffer,r,t),r}throw"convert_nonInterleaved has a limited support"}},Real64:{contructor:Float64Array,convert:e=>{if(3===e.dims.length){if(4===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBAReal(e.buffer,r,t),r}if(3===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal(e.buffer,r,t),r}if(2===e.dims[2]){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveRGBReal2(e.buffer,r,t),r}throw console.error(e),"It must be RGB or RGBA!"}if(2===e.dims.length){const t=e.dims[0]*e.dims[1],r=new Uint8ClampedArray(t<<2);return moveGrayReal(e.buffer,r,t),r}throw"This is not an image data!"}}};g2d.Antialiasing=()=>"Antialiasing";var imageContext={};let runOptcodes$1;imageContext.EventListener=async(e,t)=>{const r=await interpretate(e[1],t),o={...t},n=t.local.canvas;return r.forEach(e=>{imageContext.EventListener[e.lhs](e.rhs,n,o)}),null},imageContext.EventListener.click=(e,t,r)=>{const o=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"click")});t.addEventListener("click",function(e){e.altKey||n(e.offsetX*o,e.offsetY*o)})},imageContext.EventListener.altclick=(e,t,r)=>{const o=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"altclick")});t.addEventListener("click",function(e){e.altKey&&n(e.offsetX*o,e.offsetY*o)})},imageContext.EventListener.mouseup=(e,t,r)=>{const o=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseup")});t.addEventListener("mouseup",function(e){n(e.offsetX*o,e.offsetY*o)})},imageContext.EventListener.mousedown=(e,t,r)=>{const o=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousedown")});t.addEventListener("mousedown",function(e){n(e.offsetX*o,e.offsetY*o)})},imageContext.EventListener.mousemove=(e,t,r)=>{const o=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mousemove")});t.addEventListener("mousemove",function(e){n(e.offsetX*o,e.offsetY*o)})},imageContext.EventListener.mouseover=(e,t,r)=>{const o=window.devicePixelRatio,n=throttle((t,r)=>{server.kernel.io.fire(e,[t,r],"mouseover")});t.addEventListener("mouseover",function(e){n(e.offsetX*o,e.offsetY*o)})},g2d.Image=async(e,t)=>{const r=await core._getRules(e,{...t,context:g2d,hold:!0});let o=await interpretate(e[0],{...t,context:[numericAccelerator,g2d]});if(o instanceof HTMLCanvasElement)return t.offscreen||t.element.appendChild(o),t.local.canvas=o,o;let n,a="Real32";e.length-Object.keys(r).length>1&&(a=interpretate(e[1])),a=imageTypes[a];let i,s,l=!0;"Interleaving"in r&&(l=interpretate(r.Interleaving,{})),Array.isArray(o)&&(console.warn("Will be slow. Not a typed array"),o={buffer:o.flat(1/0),dims:checkdims(o)}),l?(console.warn(a),n=a.convert(o)):n=a.convert_nonInterleaved(o),t.local.type=a,console.log("ImageSize"),console.log(o.dims),l?(s=o.dims[0],i=o.dims[1]):(s=o.dims[1],i=o.dims[2]),t.local.interleaving=l,t.local.dims=o.dims,n=new ImageData(new Uint8ClampedArray(n),i,s);let c=r.ImageSize;if(c=await interpretate(r.ImageSize,{...t,context:g2d}),r.Magnification){const e=await interpretate(r.Magnification,{...t,context:g2d});c=Math.floor(i*e)}c||(c=t.imageSize?t.imageSize:i),Array.isArray(c)?"number"!=typeof c[0]&&(c=[i,s]):"number"!=typeof c&&(c=i),Array.isArray(c)&&(c=c[0]);const d=Math.floor(c),u=Math.floor(s/i*c);let p;console.warn("ImageSize"),console.warn({target_width:d,target_height:u}),t.local.targetDims=[u,d];const m=window.devicePixelRatio;var f=document.createElement("canvas");return f.width=d,f.height=u,t.offscreen||t.element.appendChild(f),f.style.width=d/m+"px",f.style.height=u/m+"px",p=f.getContext("2d"),t.local.ctx=p,t.local.canvas=f,"Antialiasing"in r&&(p.imageSmoothingEnabled=await interpretate(r.Antialiasing,{...t,context:g2d})),d!=i||u!=s?(t.local.resized=!0,console.warn("Resizing might be slow"),n=await createImageBitmap(n),p.drawImage(n,0,0,d,u)):p.putImageData(n,0,0),r.Epilog&&interpretate(r.Epilog,{...t,context:[imageContext,g2d]}),f},g2d.Image.update=async(e,t)=>{let r=await interpretate(e[0],{...t,context:[numericAccelerator,g2d]});if(Array.isArray(r)&&(console.warn("Image:update: not a typed array. It will be slow..."),r={buffer:r.flat(1/0),dims:checkdims(r)}),!t.local.interleaving)throw"Update with no interleaving is not supported!";let o=t.local.type.convert(r);o=new ImageData(new Uint8ClampedArray(o),t.local.dims[1],t.local.dims[0]),t.local.resized?(o=await createImageBitmap(o),t.local.ctx.clearRect(0,0,t.local.targetDims[1],t.local.targetDims[0]),t.local.ctx.drawImage(o,0,0,t.local.targetDims[1],t.local.targetDims[0])):t.local.ctx.putImageData(o,0,0)},g2d.Image.destroy=(e,t)=>{t.local?.canvas?.remove()},core["Canvas2D`Private`ctx"]=async(e,t)=>{if(!t.root.parent)throw"ctx cannot be executed without parent node";if("Image"!=t.root.parent.firstName)throw console.error(t.root.parent),"parent node is not Image";const r=await core._getRules(t.root.parent.virtual.slice(1),{...t,hold:!0,context:[g2d,imageContext]}),o=await interpretate(e[1],t);runOptcodes$1||(runOptcodes$1=(await Promise.resolve().then(function(){return canvas2d})).runOptcodes);const n=document.createElement("canvas");r.ImageResolution=await interpretate(r.ImageResolution,t),"number"!=typeof r.ImageResolution[0]&&(r.ImageResolution=[500,500]),n.width=r.ImageResolution[0],n.height=r.ImageResolution[1];const a=n.getContext("2d");t.local.ctx=a,t.local.canvas=n,r.Prolog&&await interpretate(r.Prolog,{...t,context:[imageContext,g2d]});const i=window.devicePixelRatio||1;return n.style.width=r.ImageResolution[0]/i+"px",n.style.height=r.ImageResolution[1]/i+"px",t.local.refmap=new Map,await runOptcodes$1(t.local.ctx,o,t.local.refmap),r.Epilog&&await interpretate(r.Epilog,{...t,context:[imageContext,g2d]}),n},core["Canvas2D`Private`ctx"].virtual=!0,core["Canvas2D`Private`ctx"].update=async(e,t)=>{const r=await interpretate(e[1],t);await runOptcodes$1(t.local.ctx,r,t.local.refmap)},core["Canvas2D`Private`ctx"].destroy=(e,t)=>{t.local.canvas.remove(),t.local.refmap.clear()},g2d.Image.virtual=!0,g2d.Graphics.virtual=!0,g2d.GraphicsGroupBox=g2d.GraphicsGroup,g2d.GraphicsComplexBox=g2d.GraphicsComplex,g2d.DiskBox=g2d.Disk,g2d.LineBox=g2d.Line;
/* @license twgl.js 5.5.3 Copyright (c) 2015, Gregg Tavares All Rights Reserved.
Available via the MIT license.
see: http://github.com/greggman/twgl.js for details */
const BYTE$2=5120,UNSIGNED_BYTE$3=5121,SHORT$2=5122,UNSIGNED_SHORT$3=5123,INT$3=5124,UNSIGNED_INT$3=5125,FLOAT$3=5126,UNSIGNED_SHORT_4_4_4_4$1=32819,UNSIGNED_SHORT_5_5_5_1$1=32820,UNSIGNED_SHORT_5_6_5$1=33635,HALF_FLOAT$1=5131,UNSIGNED_INT_2_10_10_10_REV$1=33640,UNSIGNED_INT_10F_11F_11F_REV$1=35899,UNSIGNED_INT_5_9_9_9_REV$1=35902,FLOAT_32_UNSIGNED_INT_24_8_REV$1=36269,UNSIGNED_INT_24_8$1=34042,glTypeToTypedArray={};{const e=glTypeToTypedArray;e[BYTE$2]=Int8Array,e[UNSIGNED_BYTE$3]=Uint8Array,e[SHORT$2]=Int16Array,e[UNSIGNED_SHORT$3]=Uint16Array,e[INT$3]=Int32Array,e[UNSIGNED_INT$3]=Uint32Array,e[FLOAT$3]=Float32Array,e[UNSIGNED_SHORT_4_4_4_4$1]=Uint16Array,e[UNSIGNED_SHORT_5_5_5_1$1]=Uint16Array,e[UNSIGNED_SHORT_5_6_5$1]=Uint16Array,e[HALF_FLOAT$1]=Uint16Array,e[UNSIGNED_INT_2_10_10_10_REV$1]=Uint32Array,e[UNSIGNED_INT_10F_11F_11F_REV$1]=Uint32Array,e[UNSIGNED_INT_5_9_9_9_REV$1]=Uint32Array,e[FLOAT_32_UNSIGNED_INT_24_8_REV$1]=Uint32Array,e[UNSIGNED_INT_24_8$1]=Uint32Array}function getGLTypeForTypedArray(e){if(e instanceof Int8Array)return BYTE$2;if(e instanceof Uint8Array)return UNSIGNED_BYTE$3;if(e instanceof Uint8ClampedArray)return UNSIGNED_BYTE$3;if(e instanceof Int16Array)return SHORT$2;if(e instanceof Uint16Array)return UNSIGNED_SHORT$3;if(e instanceof Int32Array)return INT$3;if(e instanceof Uint32Array)return UNSIGNED_INT$3;if(e instanceof Float32Array)return FLOAT$3;throw new Error("unsupported typed array type")}function getGLTypeForTypedArrayType(e){if(e===Int8Array)return BYTE$2;if(e===Uint8Array)return UNSIGNED_BYTE$3;if(e===Uint8ClampedArray)return UNSIGNED_BYTE$3;if(e===Int16Array)return SHORT$2;if(e===Uint16Array)return UNSIGNED_SHORT$3;if(e===Int32Array)return INT$3;if(e===Uint32Array)return UNSIGNED_INT$3;if(e===Float32Array)return FLOAT$3;throw new Error("unsupported typed array type")}function getTypedArrayTypeForGLType(e){const t=glTypeToTypedArray[e];if(!t)throw new Error("unknown gl type");return t}const isArrayBuffer$1="undefined"!=typeof SharedArrayBuffer?function(e){return e&&e.buffer&&(e.buffer instanceof ArrayBuffer||e.buffer instanceof SharedArrayBuffer)}:function(e){return e&&e.buffer&&e.buffer instanceof ArrayBuffer};var typedarrays=Object.freeze({__proto__:null,getGLTypeForTypedArray:getGLTypeForTypedArray,getGLTypeForTypedArrayType:getGLTypeForTypedArrayType,getTypedArrayTypeForGLType:getTypedArrayTypeForGLType,isArrayBuffer:isArrayBuffer$1});function copyExistingProperties(e,t){Object.keys(t).forEach(function(r){t.hasOwnProperty(r)&&e.hasOwnProperty(r)&&(t[r]=e[r])})}function error$1(...e){console.error(...e)}function warn$1(...e){console.warn(...e)}const isTypeWeakMaps=new Map;function isType(e,t){if(!e||"object"!=typeof e)return!1;let r=isTypeWeakMaps.get(t);r||(r=new WeakMap,isTypeWeakMaps.set(t,r));let o=r.get(e);if(void 0===o){const n=Object.prototype.toString.call(e);o=n.substring(8,n.length-1)===t,r.set(e,o)}return o}function isBuffer(e,t){return"undefined"!=typeof WebGLBuffer&&isType(t,"WebGLBuffer")}function isRenderbuffer(e,t){return"undefined"!=typeof WebGLRenderbuffer&&isType(t,"WebGLRenderbuffer")}function isTexture(e,t){return"undefined"!=typeof WebGLTexture&&isType(t,"WebGLTexture")}function isSampler(e,t){return"undefined"!=typeof WebGLSampler&&isType(t,"WebGLSampler")}const STATIC_DRAW=35044,ARRAY_BUFFER$1=34962,ELEMENT_ARRAY_BUFFER$2=34963,BUFFER_SIZE=34660,BYTE$1=5120,UNSIGNED_BYTE$2=5121,SHORT$1=5122,UNSIGNED_SHORT$2=5123,INT$2=5124,UNSIGNED_INT$2=5125,FLOAT$2=5126,defaults$2={attribPrefix:""};function setAttributePrefix(e){defaults$2.attribPrefix=e}function setDefaults$2(e){copyExistingProperties(e,defaults$2)}function setBufferFromTypedArray(e,t,r,o,n){e.bindBuffer(t,r),e.bufferData(t,o,n||STATIC_DRAW)}function createBufferFromTypedArray(e,t,r,o){if(isBuffer(e,t))return t;r=r||ARRAY_BUFFER$1;const n=e.createBuffer();return setBufferFromTypedArray(e,r,n,t,o),n}function isIndices(e){return"indices"===e}function getNormalizationForTypedArrayType(e){return e===Int8Array||e===Uint8Array}function getArray(e){return e.length?e:e.data}const texcoordRE=/coord|texture/i,colorRE=/color|colour/i;function guessNumComponentsFromName(e,t){let r;if(r=texcoordRE.test(e)?2:colorRE.test(e)?4:3,t%r>0)throw new Error(`Can not guess numComponents for attribute '${e}'. Tried ${r} but ${t} values is not evenly divisible by ${r}. You should specify it.`);return r}function getNumComponents(e,t,r){return e.numComponents||e.size||guessNumComponentsFromName(t,r||getArray(e).length)}function makeTypedArray(e,t){if(isArrayBuffer$1(e))return e;if(isArrayBuffer$1(e.data))return e.data;Array.isArray(e)&&(e={data:e});let r=e.type?typedArrayTypeFromGLTypeOrTypedArrayCtor(e.type):void 0;return r||(r=isIndices(t)?Uint16Array:Float32Array),new r(e.data)}function glTypeFromGLTypeOrTypedArrayType(e){return"number"==typeof e?e:e?getGLTypeForTypedArrayType(e):FLOAT$2}function typedArrayTypeFromGLTypeOrTypedArrayCtor(e){return"number"==typeof e?getTypedArrayTypeForGLType(e):e||Float32Array}function attribBufferFromBuffer(e,t){return{buffer:t.buffer,numValues:24,type:glTypeFromGLTypeOrTypedArrayType(t.type),arrayType:typedArrayTypeFromGLTypeOrTypedArrayCtor(t.type)}}function attribBufferFromSize(e,t){const r=t.data||t,o=typedArrayTypeFromGLTypeOrTypedArrayCtor(t.type),n=r*o.BYTES_PER_ELEMENT,a=e.createBuffer();return e.bindBuffer(ARRAY_BUFFER$1,a),e.bufferData(ARRAY_BUFFER$1,n,t.drawType||STATIC_DRAW),{buffer:a,numValues:r,type:getGLTypeForTypedArrayType(o),arrayType:o}}function attribBufferFromArrayLike(e,t,r){const o=makeTypedArray(t,r);return{arrayType:o.constructor,buffer:createBufferFromTypedArray(e,o,void 0,t.drawType),type:getGLTypeForTypedArray(o),numValues:0}}function createAttribsFromArrays(e,t){const r={};return Object.keys(t).forEach(function(o){if(!isIndices(o)){const n=t[o],a=n.attrib||n.name||n.attribName||defaults$2.attribPrefix+o;if(n.value){if(!Array.isArray(n.value)&&!isArrayBuffer$1(n.value))throw new Error("array.value is not array or typedarray");r[a]={value:n.value}}else{let t;t=n.buffer&&n.buffer instanceof WebGLBuffer?attribBufferFromBuffer:"number"==typeof n||"number"==typeof n.data?attribBufferFromSize:attribBufferFromArrayLike;const{buffer:i,type:s,numValues:l,arrayType:c}=t(e,n,o),d=void 0!==n.normalize?n.normalize:getNormalizationForTypedArrayType(c),u=getNumComponents(n,o,l);r[a]={buffer:i,numComponents:u,type:s,normalize:d,stride:n.stride||0,offset:n.offset||0,divisor:void 0===n.divisor?void 0:n.divisor,drawType:n.drawType}}}}),e.bindBuffer(ARRAY_BUFFER$1,null),r}function setAttribInfoBufferFromArray(e,t,r,o){r=makeTypedArray(r),void 0!==o?(e.bindBuffer(ARRAY_BUFFER$1,t.buffer),e.bufferSubData(ARRAY_BUFFER$1,o,r)):setBufferFromTypedArray(e,ARRAY_BUFFER$1,t.buffer,r,t.drawType)}function getBytesPerValueForGLType(e,t){return t===BYTE$1||t===UNSIGNED_BYTE$2?1:t===SHORT$1||t===UNSIGNED_SHORT$2?2:t===INT$2||t===UNSIGNED_INT$2||t===FLOAT$2?4:0}const positionKeys=["position","positions","a_position"];function getNumElementsFromNonIndexedArrays(e){let t,r;for(r=0;r<positionKeys.length&&(t=positionKeys[r],!(t in e));++r);r===positionKeys.length&&(t=Object.keys(e)[0]);const o=e[t],n=getArray(o).length;if(void 0===n)return 1;const a=getNumComponents(o,t),i=n/a;if(n%a>0)throw new Error(`numComponents ${a} not correct for length ${n}`);return i}function getNumElementsFromAttributes(e,t){let r,o;for(o=0;o<positionKeys.length&&(r=positionKeys[o],!(r in t))&&(r=defaults$2.attribPrefix+r,!(r in t));++o);o===positionKeys.length&&(r=Object.keys(t)[0]);const n=t[r];if(!n.buffer)return 1;e.bindBuffer(ARRAY_BUFFER$1,n.buffer);const a=e.getBufferParameter(ARRAY_BUFFER$1,BUFFER_SIZE);e.bindBuffer(ARRAY_BUFFER$1,null);const i=a/getBytesPerValueForGLType(e,n.type),s=n.numComponents||n.size,l=i/s;if(l%1!=0)throw new Error(`numComponents ${s} not correct for length ${length}`);return l}function createBufferInfoFromArrays(e,t,r){const o=createAttribsFromArrays(e,t),n=Object.assign({},r||{});n.attribs=Object.assign({},r?r.attribs:{},o);const a=t.indices;if(a){const t=makeTypedArray(a,"indices");n.indices=createBufferFromTypedArray(e,t,ELEMENT_ARRAY_BUFFER$2),n.numElements=t.length,n.elementType=getGLTypeForTypedArray(t)}else n.numElements||(n.numElements=getNumElementsFromAttributes(e,n.attribs));return n}function createBufferFromArray(e,t,r){const o="indices"===r?ELEMENT_ARRAY_BUFFER$2:ARRAY_BUFFER$1;return createBufferFromTypedArray(e,makeTypedArray(t,r),o)}function createBuffersFromArrays(e,t){const r={};return Object.keys(t).forEach(function(o){r[o]=createBufferFromArray(e,t[o],o)}),t.indices?(r.numElements=t.indices.length,r.elementType=getGLTypeForTypedArray(makeTypedArray(t.indices))):r.numElements=getNumElementsFromNonIndexedArrays(t),r}var attributes=Object.freeze({__proto__:null,createAttribsFromArrays:createAttribsFromArrays,createBuffersFromArrays:createBuffersFromArrays,createBufferFromArray:createBufferFromArray,createBufferFromTypedArray:createBufferFromTypedArray,createBufferInfoFromArrays:createBufferInfoFromArrays,setAttribInfoBufferFromArray:setAttribInfoBufferFromArray,setAttributePrefix:setAttributePrefix,setAttributeDefaults_:setDefaults$2,getNumComponents_:getNumComponents,getArray_:getArray});function isWebGL2(e){return!!e.texStorage2D}function isWebGL1(e){return!e.texStorage2D}const glEnumToString=function(){const e={},t={};return function(r,o){return function(r){const o=r.constructor.name;if(!e[o]){for(const e in r)if("number"==typeof r[e]){const o=t[r[e]];t[r[e]]=o?`${o} | ${e}`:e}e[o]=!0}}(r),t[o]||("number"==typeof o?`0x${o.toString(16)}`:o)}}();var utils=Object.freeze({__proto__:null,glEnumToString:glEnumToString,isWebGL1:isWebGL1,isWebGL2:isWebGL2});const defaults$1={textureColor:new Uint8Array([128,192,255,255]),textureOptions:{},crossOrigin:void 0},isArrayBuffer=isArrayBuffer$1,getShared2DContext=function(){let e;return function(){return e=e||("undefined"!=typeof document&&document.createElement?document.createElement("canvas").getContext("2d"):null),e}}(),ALPHA=6406,RGB=6407,RGBA$1=6408,LUMINANCE=6409,LUMINANCE_ALPHA=6410,DEPTH_COMPONENT$1=6402,DEPTH_STENCIL$1=34041,CLAMP_TO_EDGE$1=33071,NEAREST=9728,LINEAR$1=9729,TEXTURE_2D$2=3553,TEXTURE_CUBE_MAP$1=34067,TEXTURE_3D$1=32879,TEXTURE_2D_ARRAY$1=35866,TEXTURE_CUBE_MAP_POSITIVE_X=34069,TEXTURE_CUBE_MAP_NEGATIVE_X=34070,TEXTURE_CUBE_MAP_POSITIVE_Y=34071,TEXTURE_CUBE_MAP_NEGATIVE_Y=34072,TEXTURE_CUBE_MAP_POSITIVE_Z=34073,TEXTURE_CUBE_MAP_NEGATIVE_Z=34074,TEXTURE_MIN_FILTER=10241,TEXTURE_MAG_FILTER=10240,TEXTURE_WRAP_S=10242,TEXTURE_WRAP_T=10243,TEXTURE_WRAP_R=32882,TEXTURE_MIN_LOD=33082,TEXTURE_MAX_LOD=33083,TEXTURE_BASE_LEVEL=33084,TEXTURE_MAX_LEVEL=33085,TEXTURE_COMPARE_MODE=34892,TEXTURE_COMPARE_FUNC=34893,UNPACK_ALIGNMENT=3317,UNPACK_ROW_LENGTH=3314,UNPACK_IMAGE_HEIGHT=32878,UNPACK_SKIP_PIXELS=3316,UNPACK_SKIP_ROWS=3315,UNPACK_SKIP_IMAGES=32877,UNPACK_COLORSPACE_CONVERSION_WEBGL=37443,UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441,UNPACK_FLIP_Y_WEBGL=37440,R8=33321,R8_SNORM=36756,R16F=33325,R32F=33326,R8UI=33330,R8I=33329,RG16UI=33338,RG16I=33337,RG32UI=33340,RG32I=33339,RG8=33323,RG8_SNORM=36757,RG16F=33327,RG32F=33328,RG8UI=33336,RG8I=33335,R16UI=33332,R16I=33331,R32UI=33334,R32I=33333,RGB8=32849,SRGB8=35905,RGB565$1=36194,RGB8_SNORM=36758,R11F_G11F_B10F=35898,RGB9_E5=35901,RGB16F=34843,RGB32F=34837,RGB8UI=36221,RGB8I=36239,RGB16UI=36215,RGB16I=36233,RGB32UI=36209,RGB32I=36227,RGBA8=32856,SRGB8_ALPHA8=35907,RGBA8_SNORM=36759,RGB5_A1$1=32855,RGBA4$1=32854,RGB10_A2=32857,RGBA16F=34842,RGBA32F=34836,RGBA8UI=36220,RGBA8I=36238,RGB10_A2UI=36975,RGBA16UI=36214,RGBA16I=36232,RGBA32I=36226,RGBA32UI=36208,DEPTH_COMPONENT16$1=33189,DEPTH_COMPONENT24$1=33190,DEPTH_COMPONENT32F$1=36012,DEPTH32F_STENCIL8$1=36013,DEPTH24_STENCIL8$1=35056,BYTE=5120,UNSIGNED_BYTE$1=5121,SHORT=5122,UNSIGNED_SHORT$1=5123,INT$1=5124,UNSIGNED_INT$1=5125,FLOAT$1=5126,UNSIGNED_SHORT_4_4_4_4=32819,UNSIGNED_SHORT_5_5_5_1=32820,UNSIGNED_SHORT_5_6_5=33635,HALF_FLOAT=5131,HALF_FLOAT_OES=36193,UNSIGNED_INT_2_10_10_10_REV=33640,UNSIGNED_INT_10F_11F_11F_REV=35899,UNSIGNED_INT_5_9_9_9_REV=35902,FLOAT_32_UNSIGNED_INT_24_8_REV=36269,UNSIGNED_INT_24_8=34042,RG=33319,RG_INTEGER=33320,RED=6403,RED_INTEGER=36244,RGB_INTEGER=36248,RGBA_INTEGER=36249,formatInfo={};{const e=formatInfo;e[ALPHA]={numColorComponents:1},e[LUMINANCE]={numColorComponents:1},e[LUMINANCE_ALPHA]={numColorComponents:2},e[RGB]={numColorComponents:3},e[RGBA$1]={numColorComponents:4},e[RED]={numColorComponents:1},e[RED_INTEGER]={numColorComponents:1},e[RG]={numColorComponents:2},e[RG_INTEGER]={numColorComponents:2},e[RGB]={numColorComponents:3},e[RGB_INTEGER]={numColorComponents:3},e[RGBA$1]={numColorComponents:4},e[RGBA_INTEGER]={numColorComponents:4},e[DEPTH_COMPONENT$1]={numColorComponents:1},e[DEPTH_STENCIL$1]={numColorComponents:2}}let s_textureInternalFormatInfo;function getTextureInternalFormatInfo(e){if(!s_textureInternalFormatInfo){const e={};e[ALPHA]={textureFormat:ALPHA,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1]},e[LUMINANCE]={textureFormat:LUMINANCE,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1,2,2,4],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1]},e[LUMINANCE_ALPHA]={textureFormat:LUMINANCE_ALPHA,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2,4,4,8],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1]},e[RGB]={textureFormat:RGB,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,6,6,12,2],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1,UNSIGNED_SHORT_5_6_5]},e[RGBA$1]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,8,8,16,2,2],type:[UNSIGNED_BYTE$1,HALF_FLOAT,HALF_FLOAT_OES,FLOAT$1,UNSIGNED_SHORT_4_4_4_4,UNSIGNED_SHORT_5_5_5_1]},e[DEPTH_COMPONENT$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[UNSIGNED_INT$1,UNSIGNED_SHORT$1]},e[R8]={textureFormat:RED,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[1],type:[UNSIGNED_BYTE$1]},e[R8_SNORM]={textureFormat:RED,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[1],type:[BYTE]},e[R16F]={textureFormat:RED,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4,2],type:[FLOAT$1,HALF_FLOAT]},e[R32F]={textureFormat:RED,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[4],type:[FLOAT$1]},e[R8UI]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[UNSIGNED_BYTE$1]},e[R8I]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[1],type:[BYTE]},e[R16UI]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[UNSIGNED_SHORT$1]},e[R16I]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[SHORT]},e[R32UI]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT$1]},e[R32I]={textureFormat:RED_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[INT$1]},e[RG8]={textureFormat:RG,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[2],type:[UNSIGNED_BYTE$1]},e[RG8_SNORM]={textureFormat:RG,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[2],type:[BYTE]},e[RG16F]={textureFormat:RG,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[8,4],type:[FLOAT$1,HALF_FLOAT]},e[RG32F]={textureFormat:RG,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[8],type:[FLOAT$1]},e[RG8UI]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[UNSIGNED_BYTE$1]},e[RG8I]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2],type:[BYTE]},e[RG16UI]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_SHORT$1]},e[RG16I]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[SHORT]},e[RG32UI]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[UNSIGNED_INT$1]},e[RG32I]={textureFormat:RG_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[INT$1]},e[RGB8]={textureFormat:RGB,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3],type:[UNSIGNED_BYTE$1]},e[SRGB8]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[UNSIGNED_BYTE$1]},e[RGB565$1]={textureFormat:RGB,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[3,2],type:[UNSIGNED_BYTE$1,UNSIGNED_SHORT_5_6_5]},e[RGB8_SNORM]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[3],type:[BYTE]},e[R11F_G11F_B10F]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[FLOAT$1,HALF_FLOAT,UNSIGNED_INT_10F_11F_11F_REV]},e[RGB9_E5]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6,4],type:[FLOAT$1,HALF_FLOAT,UNSIGNED_INT_5_9_9_9_REV]},e[RGB16F]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[12,6],type:[FLOAT$1,HALF_FLOAT]},e[RGB32F]={textureFormat:RGB,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[FLOAT$1]},e[RGB8UI]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[UNSIGNED_BYTE$1]},e[RGB8I]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[3],type:[BYTE]},e[RGB16UI]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[UNSIGNED_SHORT$1]},e[RGB16I]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[6],type:[SHORT]},e[RGB32UI]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[UNSIGNED_INT$1]},e[RGB32I]={textureFormat:RGB_INTEGER,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[12],type:[INT$1]},e[RGBA8]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[UNSIGNED_BYTE$1]},e[SRGB8_ALPHA8]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[UNSIGNED_BYTE$1]},e[RGBA8_SNORM]={textureFormat:RGBA$1,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[4],type:[BYTE]},e[RGB5_A1$1]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2,4],type:[UNSIGNED_BYTE$1,UNSIGNED_SHORT_5_5_5_1,UNSIGNED_INT_2_10_10_10_REV]},e[RGBA4$1]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4,2],type:[UNSIGNED_BYTE$1,UNSIGNED_SHORT_4_4_4_4]},e[RGB10_A2]={textureFormat:RGBA$1,colorRenderable:!0,textureFilterable:!0,bytesPerElement:[4],type:[UNSIGNED_INT_2_10_10_10_REV]},e[RGBA16F]={textureFormat:RGBA$1,colorRenderable:!1,textureFilterable:!0,bytesPerElement:[16,8],type:[FLOAT$1,HALF_FLOAT]},e[RGBA32F]={textureFormat:RGBA$1,colorRenderable:!1,textureFilterable:!1,bytesPerElement:[16],type:[FLOAT$1]},e[RGBA8UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_BYTE$1]},e[RGBA8I]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[BYTE]},e[RGB10_A2UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT_2_10_10_10_REV]},e[RGBA16UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[UNSIGNED_SHORT$1]},e[RGBA16I]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[8],type:[SHORT]},e[RGBA32I]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[INT$1]},e[RGBA32UI]={textureFormat:RGBA_INTEGER,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[16],type:[UNSIGNED_INT$1]},e[DEPTH_COMPONENT16$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[2,4],type:[UNSIGNED_SHORT$1,UNSIGNED_INT$1]},e[DEPTH_COMPONENT24$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT$1]},e[DEPTH_COMPONENT32F$1]={textureFormat:DEPTH_COMPONENT$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[FLOAT$1]},e[DEPTH24_STENCIL8$1]={textureFormat:DEPTH_STENCIL$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[UNSIGNED_INT_24_8]},e[DEPTH32F_STENCIL8$1]={textureFormat:DEPTH_STENCIL$1,colorRenderable:!0,textureFilterable:!1,bytesPerElement:[4],type:[FLOAT_32_UNSIGNED_INT_24_8_REV]},Object.keys(e).forEach(function(t){const r=e[t];r.bytesPerElementMap={},r.bytesPerElement.forEach(function(e,t){const o=r.type[t];r.bytesPerElementMap[o]=e})}),s_textureInternalFormatInfo=e}return s_textureInternalFormatInfo[e]}function getBytesPerElementForInternalFormat(e,t){const r=getTextureInternalFormatInfo(e);if(!r)throw"unknown internal format";const o=r.bytesPerElementMap[t];if(void 0===o)throw"unknown internal format";return o}function getFormatAndTypeForInternalFormat(e){const t=getTextureInternalFormatInfo(e);if(!t)throw"unknown internal format";return{format:t.textureFormat,type:t.type[0]}}function isPowerOf2(e){return!(e&e-1)}function canGenerateMipmap(e,t,r,o){if(!isWebGL2(e))return isPowerOf2(t)&&isPowerOf2(r);const n=getTextureInternalFormatInfo(o);if(!n)throw"unknown internal format";return n.colorRenderable&&n.textureFilterable}function canFilter(e){const t=getTextureInternalFormatInfo(e);if(!t)throw"unknown internal format";return t.textureFilterable}function getNumComponentsForFormat(e){const t=formatInfo[e];if(!t)throw"unknown format: "+e;return t.numColorComponents}function getTextureTypeForArrayType(e,t,r){return isArrayBuffer(t)?getGLTypeForTypedArray(t):r||UNSIGNED_BYTE$1}function guessDimensions(e,t,r,o,n){if(n%1!=0)throw"can't guess dimensions";if(r||o){if(o){if(!r&&(r=n/o)%1)throw"can't guess dimensions"}else if((o=n/r)%1)throw"can't guess dimensions"}else{const e=Math.sqrt(n/(t===TEXTURE_CUBE_MAP$1?6:1));e%1==0?(r=e,o=e):(r=n,o=1)}return{width:r,height:o}}function setDefaultTextureColor(e){defaults$1.textureColor=new Uint8Array([255*e[0],255*e[1],255*e[2],255*e[3]])}function setDefaults$1(e){copyExistingProperties(e,defaults$1),e.textureColor&&setDefaultTextureColor(e.textureColor)}function setPackState(e,t){void 0!==t.colorspaceConversion&&e.pixelStorei(UNPACK_COLORSPACE_CONVERSION_WEBGL,t.colorspaceConversion),void 0!==t.premultiplyAlpha&&e.pixelStorei(UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),void 0!==t.flipY&&e.pixelStorei(UNPACK_FLIP_Y_WEBGL,t.flipY)}function setSkipStateToDefault(e){e.pixelStorei(UNPACK_ALIGNMENT,4),isWebGL2(e)&&(e.pixelStorei(UNPACK_ROW_LENGTH,0),e.pixelStorei(UNPACK_IMAGE_HEIGHT,0),e.pixelStorei(UNPACK_SKIP_PIXELS,0),e.pixelStorei(UNPACK_SKIP_ROWS,0),e.pixelStorei(UNPACK_SKIP_IMAGES,0))}function setTextureSamplerParameters(e,t,r,o){o.minMag&&(r.call(e,t,TEXTURE_MIN_FILTER,o.minMag),r.call(e,t,TEXTURE_MAG_FILTER,o.minMag)),o.min&&r.call(e,t,TEXTURE_MIN_FILTER,o.min),o.mag&&r.call(e,t,TEXTURE_MAG_FILTER,o.mag),o.wrap&&(r.call(e,t,TEXTURE_WRAP_S,o.wrap),r.call(e,t,TEXTURE_WRAP_T,o.wrap),(t===TEXTURE_3D$1||isSampler(e,t))&&r.call(e,t,TEXTURE_WRAP_R,o.wrap)),o.wrapR&&r.call(e,t,TEXTURE_WRAP_R,o.wrapR),o.wrapS&&r.call(e,t,TEXTURE_WRAP_S,o.wrapS),o.wrapT&&r.call(e,t,TEXTURE_WRAP_T,o.wrapT),void 0!==o.minLod&&r.call(e,t,TEXTURE_MIN_LOD,o.minLod),void 0!==o.maxLod&&r.call(e,t,TEXTURE_MAX_LOD,o.maxLod),void 0!==o.baseLevel&&r.call(e,t,TEXTURE_BASE_LEVEL,o.baseLevel),void 0!==o.maxLevel&&r.call(e,t,TEXTURE_MAX_LEVEL,o.maxLevel),void 0!==o.compareFunc&&r.call(e,t,TEXTURE_COMPARE_FUNC,o.compareFunc),void 0!==o.compareMode&&r.call(e,t,TEXTURE_COMPARE_MODE,o.compareMode)}function setTextureParameters(e,t,r){const o=r.target||TEXTURE_2D$2;e.bindTexture(o,t),setTextureSamplerParameters(e,o,e.texParameteri,r)}function setSamplerParameters(e,t,r){setTextureSamplerParameters(e,t,e.samplerParameteri,r)}function createSampler(e,t){const r=e.createSampler();return setSamplerParameters(e,r,t),r}function createSamplers(e,t){const r={};return Object.keys(t).forEach(function(o){r[o]=createSampler(e,t[o])}),r}function make1Pixel(e){return e=e||defaults$1.textureColor,isArrayBuffer(e)?e:new Uint8Array([255*e[0],255*e[1],255*e[2],255*e[3]])}function setTextureFilteringForSize(e,t,r,o,n,a){r=r||defaults$1.textureOptions,a=a||RGBA$1;const i=r.target||TEXTURE_2D$2;if(o=o||r.width,n=n||r.height,e.bindTexture(i,t),canGenerateMipmap(e,o,n,a))e.generateMipmap(i);else{const t=canFilter(a)?LINEAR$1:NEAREST;e.texParameteri(i,TEXTURE_MIN_FILTER,t),e.texParameteri(i,TEXTURE_MAG_FILTER,t),e.texParameteri(i,TEXTURE_WRAP_S,CLAMP_TO_EDGE$1),e.texParameteri(i,TEXTURE_WRAP_T,CLAMP_TO_EDGE$1)}}function shouldAutomaticallySetTextureFilteringForSize(e){return!0===e.auto||void 0===e.auto&&void 0===e.level}function getCubeFaceOrder(e,t){return(t=t||{}).cubeFaceOrder||[TEXTURE_CUBE_MAP_POSITIVE_X,TEXTURE_CUBE_MAP_NEGATIVE_X,TEXTURE_CUBE_MAP_POSITIVE_Y,TEXTURE_CUBE_MAP_NEGATIVE_Y,TEXTURE_CUBE_MAP_POSITIVE_Z,TEXTURE_CUBE_MAP_NEGATIVE_Z]}function getCubeFacesWithNdx(e,t){const r=getCubeFaceOrder(e,t).map(function(e,t){return{face:e,ndx:t}});return r.sort(function(e,t){return e.face-t.face}),r}function setTextureFromElement(e,t,r,o){const n=(o=o||defaults$1.textureOptions).target||TEXTURE_2D$2,a=o.level||0;let i=r.width,s=r.height;const l=o.internalFormat||o.format||RGBA$1,c=getFormatAndTypeForInternalFormat(l),d=o.format||c.format,u=o.type||c.type;if(setPackState(e,o),e.bindTexture(n,t),n===TEXTURE_CUBE_MAP$1){const c=r.width,p=r.height;let m,f;if(c/6===p)m=p,f=[0,0,1,0,2,0,3,0,4,0,5,0];else if(p/6===c)m=c,f=[0,0,0,1,0,2,0,3,0,4,0,5];else if(c/3==p/2)m=c/3,f=[0,0,1,0,2,0,0,1,1,1,2,1];else{if(c/2!=p/3)throw"can't figure out cube map from element: "+(r.src?r.src:r.nodeName);m=c/2,f=[0,0,1,0,0,1,1,1,0,2,1,2]}const g=getShared2DContext();g?(g.canvas.width=m,g.canvas.height=m,i=m,s=m,getCubeFacesWithNdx(e,o).forEach(function(t){const o=f[2*t.ndx+0]*m,n=f[2*t.ndx+1]*m;g.drawImage(r,o,n,m,m,0,0,m,m),e.texImage2D(t.face,a,l,d,u,g.canvas)}),g.canvas.width=1,g.canvas.height=1):"undefined"!=typeof createImageBitmap&&(i=m,s=m,getCubeFacesWithNdx(e,o).forEach(function(c){const p=f[2*c.ndx+0]*m,g=f[2*c.ndx+1]*m;e.texImage2D(c.face,a,l,m,m,0,d,u,null),createImageBitmap(r,p,g,m,m,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(function(r){setPackState(e,o),e.bindTexture(n,t),e.texImage2D(c.face,a,l,d,u,r),shouldAutomaticallySetTextureFilteringForSize(o)&&setTextureFilteringForSize(e,t,o,i,s,l)})}))}else if(n===TEXTURE_3D$1||n===TEXTURE_2D_ARRAY$1){const t=Math.min(r.width,r.height),o=Math.max(r.width,r.height),i=o/t;if(i%1!=0)throw"can not compute 3D dimensions of element";const s=r.width===o?1:0,c=r.height===o?1:0;e.pixelStorei(UNPACK_ALIGNMENT,1),e.pixelStorei(UNPACK_ROW_LENGTH,r.width),e.pixelStorei(UNPACK_IMAGE_HEIGHT,0),e.pixelStorei(UNPACK_SKIP_IMAGES,0),e.texImage3D(n,a,l,t,t,t,0,d,u,null);for(let o=0;o<i;++o){const i=o*t*s,l=o*t*c;e.pixelStorei(UNPACK_SKIP_PIXELS,i),e.pixelStorei(UNPACK_SKIP_ROWS,l),e.texSubImage3D(n,a,0,0,o,t,t,1,d,u,r)}setSkipStateToDefault(e)}else e.texImage2D(n,a,l,d,u,r);shouldAutomaticallySetTextureFilteringForSize(o)&&setTextureFilteringForSize(e,t,o,i,s,l),setTextureParameters(e,t,o)}function noop(){}function urlIsSameOrigin(e){if("undefined"!=typeof document){const t=document.createElement("a");return t.href=e,t.hostname===location.hostname&&t.port===location.port&&t.protocol===location.protocol}{const t=new URL(location.href).origin;return new URL(e,location.href).origin===t}}function setToAnonymousIfUndefinedAndURLIsNotSameOrigin(e,t){return void 0!==t||urlIsSameOrigin(e)?t:"anonymous"}function loadImage$1(e,t,r){let o;if(r=r||noop,t=void 0!==t?t:defaults$1.crossOrigin,t=setToAnonymousIfUndefinedAndURLIsNotSameOrigin(e,t),"undefined"!=typeof Image){o=new Image,void 0!==t&&(o.crossOrigin=t);const n=function(){o.removeEventListener("error",a),o.removeEventListener("load",i),o=null},a=function(){const t="couldn't load image: "+e;error$1(t),r(t,o),n()},i=function(){r(null,o),n()};return o.addEventListener("error",a),o.addEventListener("load",i),o.src=e,o}if("undefined"!=typeof ImageBitmap){let n,a;const i=function(){r(n,a)},s={};t&&(s.mode="cors"),fetch(e,s).then(function(e){if(!e.ok)throw e;return e.blob()}).then(function(e){return createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"})}).then(function(e){a=e,setTimeout(i)}).catch(function(e){n=e,setTimeout(i)}),o=null}return o}function isTexImageSource(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof HTMLElement&&e instanceof HTMLElement}function loadAndUseImage(e,t,r){return isTexImageSource(e)?(setTimeout(function(){r(null,e)}),e):loadImage$1(e,t,r)}function setTextureTo1PixelColor(e,t,r){const o=(r=r||defaults$1.textureOptions).target||TEXTURE_2D$2;if(e.bindTexture(o,t),!1===r.color)return;const n=make1Pixel(r.color);if(o===TEXTURE_CUBE_MAP$1)for(let t=0;t<6;++t)e.texImage2D(TEXTURE_CUBE_MAP_POSITIVE_X+t,0,RGBA$1,1,1,0,RGBA$1,UNSIGNED_BYTE$1,n);else o===TEXTURE_3D$1||o===TEXTURE_2D_ARRAY$1?e.texImage3D(o,0,RGBA$1,1,1,1,0,RGBA$1,UNSIGNED_BYTE$1,n):e.texImage2D(o,0,RGBA$1,1,1,0,RGBA$1,UNSIGNED_BYTE$1,n)}function loadTextureFromUrl(e,t,r,o){o=o||noop,r=r||defaults$1.textureOptions,setTextureTo1PixelColor(e,t,r);return loadAndUseImage((r=Object.assign({},r)).src,r.crossOrigin,function(n,a){n?o(n,t,a):(setTextureFromElement(e,t,a,r),o(null,t,a))})}function loadCubemapFromUrls(e,t,r,o){o=o||noop;const n=r.src;if(6!==n.length)throw"there must be 6 urls for a cubemap";const a=r.level||0,i=r.internalFormat||r.format||RGBA$1,s=getFormatAndTypeForInternalFormat(i),l=r.format||s.format,c=r.type||UNSIGNED_BYTE$1,d=r.target||TEXTURE_2D$2;if(d!==TEXTURE_CUBE_MAP$1)throw"target must be TEXTURE_CUBE_MAP";setTextureTo1PixelColor(e,t,r),r=Object.assign({},r);let u=6;const p=[],m=getCubeFaceOrder(e,r);let f;f=n.map(function(n,s){return loadAndUseImage(n,r.crossOrigin,(g=m[s],function(n,s){--u,n?p.push(n):s.width!==s.height?p.push("cubemap face img is not a square: "+s.src):(setPackState(e,r),e.bindTexture(d,t),5===u?getCubeFaceOrder().forEach(function(t){e.texImage2D(t,a,i,l,c,s)}):e.texImage2D(g,a,i,l,c,s),shouldAutomaticallySetTextureFilteringForSize(r)&&e.generateMipmap(d)),0===u&&o(p.length?p:void 0,t,f)}));var g})}function loadSlicesFromUrls(e,t,r,o){o=o||noop;const n=r.src,a=r.internalFormat||r.format||RGBA$1,i=getFormatAndTypeForInternalFormat(a),s=r.format||i.format,l=r.type||UNSIGNED_BYTE$1,c=r.target||TEXTURE_2D_ARRAY$1;if(c!==TEXTURE_3D$1&&c!==TEXTURE_2D_ARRAY$1)throw"target must be TEXTURE_3D or TEXTURE_2D_ARRAY";setTextureTo1PixelColor(e,t,r),r=Object.assign({},r);let d=n.length;const u=[];let p;const m=r.level||0;let f=r.width,g=r.height;const y=n.length;let h=!0;p=n.map(function(n,i){return loadAndUseImage(n,r.crossOrigin,(_=i,function(n,i){if(--d,n)u.push(n);else{if(setPackState(e,r),e.bindTexture(c,t),h){h=!1,f=r.width||i.width,g=r.height||i.height,e.texImage3D(c,m,a,f,g,y,0,s,l,null);for(let t=0;t<y;++t)e.texSubImage3D(c,m,0,0,t,f,g,1,s,l,i)}else{let t,r=i;i.width===f&&i.height===g||(t=getShared2DContext(),r=t.canvas,t.canvas.width=f,t.canvas.height=g,t.drawImage(i,0,0,f,g)),e.texSubImage3D(c,m,0,0,_,f,g,1,s,l,r),t&&r===t.canvas&&(t.canvas.width=0,t.canvas.height=0)}shouldAutomaticallySetTextureFilteringForSize(r)&&e.generateMipmap(c)}0===d&&o(u.length?u:void 0,t,p)}));var _})}function setTextureFromArray(e,t,r,o){const n=(o=o||defaults$1.textureOptions).target||TEXTURE_2D$2;e.bindTexture(n,t);let a=o.width,i=o.height,s=o.depth;const l=o.level||0,c=o.internalFormat||o.format||RGBA$1,d=getFormatAndTypeForInternalFormat(c),u=o.format||d.format,p=o.type||getTextureTypeForArrayType(e,r,d.type);if(isArrayBuffer(r))r instanceof Uint8ClampedArray&&(r=new Uint8Array(r.buffer));else{const e=getTypedArrayTypeForGLType(p);r=new e(r)}const m=getBytesPerElementForInternalFormat(c,p),f=r.byteLength/m;if(f%1)throw"length wrong size for format: "+glEnumToString(e,u);let g;if(n===TEXTURE_3D$1||n===TEXTURE_2D_ARRAY$1)if(a||i||s)!a||i&&s?!i||a&&s?(g=guessDimensions(e,n,a,i,f/s),a=g.width,i=g.height):(g=guessDimensions(e,n,a,s,f/i),a=g.width,s=g.height):(g=guessDimensions(e,n,i,s,f/a),i=g.width,s=g.height);else{const e=Math.cbrt(f);if(e%1!=0)throw"can't guess cube size of array of numElements: "+f;a=e,i=e,s=e}else g=guessDimensions(e,n,a,i,f),a=g.width,i=g.height;if(setSkipStateToDefault(e),e.pixelStorei(UNPACK_ALIGNMENT,o.unpackAlignment||1),setPackState(e,o),n===TEXTURE_CUBE_MAP$1){const t=f/6*(m/r.BYTES_PER_ELEMENT);getCubeFacesWithNdx(e,o).forEach(o=>{const n=t*o.ndx,s=r.subarray(n,n+t);e.texImage2D(o.face,l,c,a,i,0,u,p,s)})}else n===TEXTURE_3D$1||n===TEXTURE_2D_ARRAY$1?e.texImage3D(n,l,c,a,i,s,0,u,p,r):e.texImage2D(n,l,c,a,i,0,u,p,r);return{width:a,height:i,depth:s,type:p}}function setEmptyTexture(e,t,r){const o=r.target||TEXTURE_2D$2;e.bindTexture(o,t);const n=r.level||0,a=r.internalFormat||r.format||RGBA$1,i=getFormatAndTypeForInternalFormat(a),s=r.format||i.format,l=r.type||i.type;if(setPackState(e,r),o===TEXTURE_CUBE_MAP$1)for(let t=0;t<6;++t)e.texImage2D(TEXTURE_CUBE_MAP_POSITIVE_X+t,n,a,r.width,r.height,0,s,l,null);else o===TEXTURE_3D$1||o===TEXTURE_2D_ARRAY$1?e.texImage3D(o,n,a,r.width,r.height,r.depth,0,s,l,null):e.texImage2D(o,n,a,r.width,r.height,0,s,l,null)}function createTexture(e,t,r){r=r||noop,t=t||defaults$1.textureOptions;const o=e.createTexture(),n=t.target||TEXTURE_2D$2;let a=t.width||1,i=t.height||1;const s=t.internalFormat||RGBA$1;e.bindTexture(n,o),n===TEXTURE_CUBE_MAP$1&&(e.texParameteri(n,TEXTURE_WRAP_S,CLAMP_TO_EDGE$1),e.texParameteri(n,TEXTURE_WRAP_T,CLAMP_TO_EDGE$1));let l=t.src;if(l)if("function"==typeof l&&(l=l(e,t)),"string"==typeof l)loadTextureFromUrl(e,o,t,r);else if(isArrayBuffer(l)||Array.isArray(l)&&("number"==typeof l[0]||Array.isArray(l[0])||isArrayBuffer(l[0]))){const r=setTextureFromArray(e,o,l,t);a=r.width,i=r.height}else Array.isArray(l)&&("string"==typeof l[0]||isTexImageSource(l[0]))?n===TEXTURE_CUBE_MAP$1?loadCubemapFromUrls(e,o,t,r):loadSlicesFromUrls(e,o,t,r):(setTextureFromElement(e,o,l,t),a=l.width,i=l.height);else setEmptyTexture(e,o,t);return shouldAutomaticallySetTextureFilteringForSize(t)&&setTextureFilteringForSize(e,o,t,a,i,s),setTextureParameters(e,o,t),o}function resizeTexture(e,t,r,o,n,a){o=o||r.width,n=n||r.height,a=a||r.depth;const i=r.target||TEXTURE_2D$2;e.bindTexture(i,t);const s=r.level||0,l=r.internalFormat||r.format||RGBA$1,c=getFormatAndTypeForInternalFormat(l),d=r.format||c.format;let u;const p=r.src;if(u=p&&(isArrayBuffer(p)||Array.isArray(p)&&"number"==typeof p[0])?r.type||getTextureTypeForArrayType(e,p,c.type):r.type||c.type,i===TEXTURE_CUBE_MAP$1)for(let t=0;t<6;++t)e.texImage2D(TEXTURE_CUBE_MAP_POSITIVE_X+t,s,l,o,n,0,d,u,null);else i===TEXTURE_3D$1||i===TEXTURE_2D_ARRAY$1?e.texImage3D(i,s,l,o,n,a,0,d,u,null):e.texImage2D(i,s,l,o,n,0,d,u,null)}function isAsyncSrc(e){return"string"==typeof e||Array.isArray(e)&&"string"==typeof e[0]}function createTextures(e,t,r){r=r||noop;let o=0;const n=[],a={},i={};function s(){0===o&&setTimeout(function(){r(n.length?n:void 0,a,i)},0)}return Object.keys(t).forEach(function(r){const l=t[r];let c;isAsyncSrc(l.src)&&(c=function(e,t,a){i[r]=a,--o,e&&n.push(e),s()},++o),a[r]=createTexture(e,l,c)}),s(),a}var textures=Object.freeze({__proto__:null,setTextureDefaults_:setDefaults$1,createSampler:createSampler,createSamplers:createSamplers,setSamplerParameters:setSamplerParameters,createTexture:createTexture,setEmptyTexture:setEmptyTexture,setTextureFromArray:setTextureFromArray,loadTextureFromUrl:loadTextureFromUrl,setTextureFromElement:setTextureFromElement,setTextureFilteringForSize:setTextureFilteringForSize,setTextureParameters:setTextureParameters,setDefaultTextureColor:setDefaultTextureColor,createTextures:createTextures,resizeTexture:resizeTexture,canGenerateMipmap:canGenerateMipmap,canFilter:canFilter,getNumComponentsForFormat:getNumComponentsForFormat,getBytesPerElementForInternalFormat:getBytesPerElementForInternalFormat,getFormatAndTypeForInternalFormat:getFormatAndTypeForInternalFormat});const error=error$1,warn=warn$1;function getElementById(e){return"undefined"!=typeof document&&document.getElementById?document.getElementById(e):null}const TEXTURE0=33984,DYNAMIC_DRAW=35048,ARRAY_BUFFER=34962,ELEMENT_ARRAY_BUFFER$1=34963,UNIFORM_BUFFER=35345,TRANSFORM_FEEDBACK_BUFFER=35982,TRANSFORM_FEEDBACK=36386,COMPILE_STATUS=35713,LINK_STATUS=35714,FRAGMENT_SHADER=35632,VERTEX_SHADER=35633,SEPARATE_ATTRIBS=35981,ACTIVE_UNIFORMS=35718,ACTIVE_ATTRIBUTES=35721,TRANSFORM_FEEDBACK_VARYINGS=35971,ACTIVE_UNIFORM_BLOCKS=35382,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398,UNIFORM_BLOCK_DATA_SIZE=35392,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395,FLOAT=5126,FLOAT_VEC2=35664,FLOAT_VEC3=35665,FLOAT_VEC4=35666,INT=5124,INT_VEC2=35667,INT_VEC3=35668,INT_VEC4=35669,BOOL=35670,BOOL_VEC2=35671,BOOL_VEC3=35672,BOOL_VEC4=35673,FLOAT_MAT2=35674,FLOAT_MAT3=35675,FLOAT_MAT4=35676,SAMPLER_2D=35678,SAMPLER_CUBE=35680,SAMPLER_3D=35679,SAMPLER_2D_SHADOW=35682,FLOAT_MAT2x3=35685,FLOAT_MAT2x4=35686,FLOAT_MAT3x2=35687,FLOAT_MAT3x4=35688,FLOAT_MAT4x2=35689,FLOAT_MAT4x3=35690,SAMPLER_2D_ARRAY=36289,SAMPLER_2D_ARRAY_SHADOW=36292,SAMPLER_CUBE_SHADOW=36293,UNSIGNED_INT=5125,UNSIGNED_INT_VEC2=36294,UNSIGNED_INT_VEC3=36295,UNSIGNED_INT_VEC4=36296,INT_SAMPLER_2D=36298,INT_SAMPLER_3D=36299,INT_SAMPLER_CUBE=36300,INT_SAMPLER_2D_ARRAY=36303,UNSIGNED_INT_SAMPLER_2D=36306,UNSIGNED_INT_SAMPLER_3D=36307,UNSIGNED_INT_SAMPLER_CUBE=36308,UNSIGNED_INT_SAMPLER_2D_ARRAY=36311,TEXTURE_2D$1=3553,TEXTURE_CUBE_MAP=34067,TEXTURE_3D=32879,TEXTURE_2D_ARRAY=35866,typeMap={};function getBindPointForSamplerType(e,t){return typeMap[t].bindPoint}function floatSetter(e,t){return function(r){e.uniform1f(t,r)}}function floatArraySetter(e,t){return function(r){e.uniform1fv(t,r)}}function floatVec2Setter(e,t){return function(r){e.uniform2fv(t,r)}}function floatVec3Setter(e,t){return function(r){e.uniform3fv(t,r)}}function floatVec4Setter(e,t){return function(r){e.uniform4fv(t,r)}}function intSetter(e,t){return function(r){e.uniform1i(t,r)}}function intArraySetter(e,t){return function(r){e.uniform1iv(t,r)}}function intVec2Setter(e,t){return function(r){e.uniform2iv(t,r)}}function intVec3Setter(e,t){return function(r){e.uniform3iv(t,r)}}function intVec4Setter(e,t){return function(r){e.uniform4iv(t,r)}}function uintSetter(e,t){return function(r){e.uniform1ui(t,r)}}function uintArraySetter(e,t){return function(r){e.uniform1uiv(t,r)}}function uintVec2Setter(e,t){return function(r){e.uniform2uiv(t,r)}}function uintVec3Setter(e,t){return function(r){e.uniform3uiv(t,r)}}function uintVec4Setter(e,t){return function(r){e.uniform4uiv(t,r)}}function floatMat2Setter(e,t){return function(r){e.uniformMatrix2fv(t,!1,r)}}function floatMat3Setter(e,t){return function(r){e.uniformMatrix3fv(t,!1,r)}}function floatMat4Setter(e,t){return function(r){e.uniformMatrix4fv(t,!1,r)}}function floatMat23Setter(e,t){return function(r){e.uniformMatrix2x3fv(t,!1,r)}}function floatMat32Setter(e,t){return function(r){e.uniformMatrix3x2fv(t,!1,r)}}function floatMat24Setter(e,t){return function(r){e.uniformMatrix2x4fv(t,!1,r)}}function floatMat42Setter(e,t){return function(r){e.uniformMatrix4x2fv(t,!1,r)}}function floatMat34Setter(e,t){return function(r){e.uniformMatrix3x4fv(t,!1,r)}}function floatMat43Setter(e,t){return function(r){e.uniformMatrix4x3fv(t,!1,r)}}function samplerSetter(e,t,r,o){const n=getBindPointForSamplerType(e,t);return isWebGL2(e)?function(t){let a,i;!t||isTexture(e,t)?(a=t,i=null):(a=t.texture,i=t.sampler),e.uniform1i(o,r),e.activeTexture(TEXTURE0+r),e.bindTexture(n,a),e.bindSampler(r,i)}:function(t){e.uniform1i(o,r),e.activeTexture(TEXTURE0+r),e.bindTexture(n,t)}}function samplerArraySetter(e,t,r,o,n){const a=getBindPointForSamplerType(e,t),i=new Int32Array(n);for(let e=0;e<n;++e)i[e]=r+e;return isWebGL2(e)?function(t){e.uniform1iv(o,i),t.forEach(function(t,o){let n,s;e.activeTexture(TEXTURE0+i[o]),!t||isTexture(e,t)?(n=t,s=null):(n=t.texture,s=t.sampler),e.bindSampler(r,s),e.bindTexture(a,n)})}:function(t){e.uniform1iv(o,i),t.forEach(function(t,r){e.activeTexture(TEXTURE0+i[r]),e.bindTexture(a,t)})}}function floatAttribSetter(e,t){return function(r){if(r.value)switch(e.disableVertexAttribArray(t),r.value.length){case 4:e.vertexAttrib4fv(t,r.value);break;case 3:e.vertexAttrib3fv(t,r.value);break;case 2:e.vertexAttrib2fv(t,r.value);break;case 1:e.vertexAttrib1fv(t,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else e.bindBuffer(ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,r.numComponents||r.size,r.type||FLOAT,r.normalize||!1,r.stride||0,r.offset||0),e.vertexAttribDivisor&&e.vertexAttribDivisor(t,r.divisor||0)}}function intAttribSetter(e,t){return function(r){if(r.value){if(e.disableVertexAttribArray(t),4!==r.value.length)throw new Error("The length of an integer constant value must be 4!");e.vertexAttrib4iv(t,r.value)}else e.bindBuffer(ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribIPointer(t,r.numComponents||r.size,r.type||INT,r.stride||0,r.offset||0),e.vertexAttribDivisor&&e.vertexAttribDivisor(t,r.divisor||0)}}function uintAttribSetter(e,t){return function(r){if(r.value){if(e.disableVertexAttribArray(t),4!==r.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");e.vertexAttrib4uiv(t,r.value)}else e.bindBuffer(ARRAY_BUFFER,r.buffer),e.enableVertexAttribArray(t),e.vertexAttribIPointer(t,r.numComponents||r.size,r.type||UNSIGNED_INT,r.stride||0,r.offset||0),e.vertexAttribDivisor&&e.vertexAttribDivisor(t,r.divisor||0)}}function matAttribSetter(e,t,r){const o=r.size,n=r.count;return function(r){e.bindBuffer(ARRAY_BUFFER,r.buffer);const a=r.size||r.numComponents||o,i=a/n,s=r.type||FLOAT,l=typeMap[s].size*a,c=r.normalize||!1,d=r.offset||0,u=l/n;for(let o=0;o<n;++o)e.enableVertexAttribArray(t+o),e.vertexAttribPointer(t+o,i,s,c,l,d+u*o),e.vertexAttribDivisor&&e.vertexAttribDivisor(t+o,r.divisor||0)}}typeMap[FLOAT]={Type:Float32Array,size:4,setter:floatSetter,arraySetter:floatArraySetter},typeMap[FLOAT_VEC2]={Type:Float32Array,size:8,setter:floatVec2Setter,cols:2},typeMap[FLOAT_VEC3]={Type:Float32Array,size:12,setter:floatVec3Setter,cols:3},typeMap[FLOAT_VEC4]={Type:Float32Array,size:16,setter:floatVec4Setter,cols:4},typeMap[INT]={Type:Int32Array,size:4,setter:intSetter,arraySetter:intArraySetter},typeMap[INT_VEC2]={Type:Int32Array,size:8,setter:intVec2Setter,cols:2},typeMap[INT_VEC3]={Type:Int32Array,size:12,setter:intVec3Setter,cols:3},typeMap[INT_VEC4]={Type:Int32Array,size:16,setter:intVec4Setter,cols:4},typeMap[UNSIGNED_INT]={Type:Uint32Array,size:4,setter:uintSetter,arraySetter:uintArraySetter},typeMap[UNSIGNED_INT_VEC2]={Type:Uint32Array,size:8,setter:uintVec2Setter,cols:2},typeMap[UNSIGNED_INT_VEC3]={Type:Uint32Array,size:12,setter:uintVec3Setter,cols:3},typeMap[UNSIGNED_INT_VEC4]={Type:Uint32Array,size:16,setter:uintVec4Setter,cols:4},typeMap[BOOL]={Type:Uint32Array,size:4,setter:intSetter,arraySetter:intArraySetter},typeMap[BOOL_VEC2]={Type:Uint32Array,size:8,setter:intVec2Setter,cols:2},typeMap[BOOL_VEC3]={Type:Uint32Array,size:12,setter:intVec3Setter,cols:3},typeMap[BOOL_VEC4]={Type:Uint32Array,size:16,setter:intVec4Setter,cols:4},typeMap[FLOAT_MAT2]={Type:Float32Array,size:32,setter:floatMat2Setter,rows:2,cols:2},typeMap[FLOAT_MAT3]={Type:Float32Array,size:48,setter:floatMat3Setter,rows:3,cols:3},typeMap[FLOAT_MAT4]={Type:Float32Array,size:64,setter:floatMat4Setter,rows:4,cols:4},typeMap[FLOAT_MAT2x3]={Type:Float32Array,size:32,setter:floatMat23Setter,rows:2,cols:3},typeMap[FLOAT_MAT2x4]={Type:Float32Array,size:32,setter:floatMat24Setter,rows:2,cols:4},typeMap[FLOAT_MAT3x2]={Type:Float32Array,size:48,setter:floatMat32Setter,rows:3,cols:2},typeMap[FLOAT_MAT3x4]={Type:Float32Array,size:48,setter:floatMat34Setter,rows:3,cols:4},typeMap[FLOAT_MAT4x2]={Type:Float32Array,size:64,setter:floatMat42Setter,rows:4,cols:2},typeMap[FLOAT_MAT4x3]={Type:Float32Array,size:64,setter:floatMat43Setter,rows:4,cols:3},typeMap[SAMPLER_2D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[SAMPLER_CUBE]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[SAMPLER_3D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_3D},typeMap[SAMPLER_2D_SHADOW]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[SAMPLER_2D_ARRAY]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY},typeMap[SAMPLER_2D_ARRAY_SHADOW]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY},typeMap[SAMPLER_CUBE_SHADOW]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[INT_SAMPLER_2D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[INT_SAMPLER_3D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_3D},typeMap[INT_SAMPLER_CUBE]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[INT_SAMPLER_2D_ARRAY]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY},typeMap[UNSIGNED_INT_SAMPLER_2D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D$1},typeMap[UNSIGNED_INT_SAMPLER_3D]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_3D},typeMap[UNSIGNED_INT_SAMPLER_CUBE]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_CUBE_MAP},typeMap[UNSIGNED_INT_SAMPLER_2D_ARRAY]={Type:null,size:0,setter:samplerSetter,arraySetter:samplerArraySetter,bindPoint:TEXTURE_2D_ARRAY};const attrTypeMap={};attrTypeMap[FLOAT]={size:4,setter:floatAttribSetter},attrTypeMap[FLOAT_VEC2]={size:8,setter:floatAttribSetter},attrTypeMap[FLOAT_VEC3]={size:12,setter:floatAttribSetter},attrTypeMap[FLOAT_VEC4]={size:16,setter:floatAttribSetter},attrTypeMap[INT]={size:4,setter:intAttribSetter},attrTypeMap[INT_VEC2]={size:8,setter:intAttribSetter},attrTypeMap[INT_VEC3]={size:12,setter:intAttribSetter},attrTypeMap[INT_VEC4]={size:16,setter:intAttribSetter},attrTypeMap[UNSIGNED_INT]={size:4,setter:uintAttribSetter},attrTypeMap[UNSIGNED_INT_VEC2]={size:8,setter:uintAttribSetter},attrTypeMap[UNSIGNED_INT_VEC3]={size:12,setter:uintAttribSetter},attrTypeMap[UNSIGNED_INT_VEC4]={size:16,setter:uintAttribSetter},attrTypeMap[BOOL]={size:4,setter:intAttribSetter},attrTypeMap[BOOL_VEC2]={size:8,setter:intAttribSetter},attrTypeMap[BOOL_VEC3]={size:12,setter:intAttribSetter},attrTypeMap[BOOL_VEC4]={size:16,setter:intAttribSetter},attrTypeMap[FLOAT_MAT2]={size:4,setter:matAttribSetter,count:2},attrTypeMap[FLOAT_MAT3]={size:9,setter:matAttribSetter,count:3},attrTypeMap[FLOAT_MAT4]={size:16,setter:matAttribSetter,count:4};const errorRE=/ERROR:\s*\d+:(\d+)/gi;function addLineNumbersWithError(e,t="",r=0){const o=[...t.matchAll(errorRE)],n=new Map(o.map((e,r)=>{const n=parseInt(e[1]),a=o[r+1],i=a?a.index:t.length;return[n-1,t.substring(e.index,i)]}));return e.split("\n").map((e,t)=>{const o=n.get(t);return`${t+1+r}: ${e}${o?`\n\n^^^ ${o}`:""}`}).join("\n")}const spaceRE=/^[ \t]*\n/;function prepShaderSource(e){let t=0;return spaceRE.test(e)&&(t=1,e=e.replace(spaceRE,"")),{lineOffset:t,shaderSource:e}}function reportError(e,t){return e.errorCallback(t),e.callback&&setTimeout(()=>{e.callback(`${t}\n${e.errors.join("\n")}`)}),null}function checkShaderStatus(e,t,r,o){o=o||error;if(!e.getShaderParameter(r,COMPILE_STATUS)){const n=e.getShaderInfoLog(r),{lineOffset:a,shaderSource:i}=prepShaderSource(e.getShaderSource(r)),s=`${addLineNumbersWithError(i,n,a)}\nError compiling ${glEnumToString(e,t)}: ${n}`;return o(s),s}return""}function getProgramOptions(e,t,r){let o,n,a;if("function"==typeof t&&(r=t,t=void 0),"function"==typeof e)r=e,e=void 0;else if(e&&!Array.isArray(e)){const t=e;r=t.errorCallback,e=t.attribLocations,o=t.transformFeedbackVaryings,n=t.transformFeedbackMode,a=t.callback}const i=r||error,s=[],l={errorCallback(e,...t){s.push(e),i(e,...t)},transformFeedbackVaryings:o,transformFeedbackMode:n,callback:a,errors:s};{let r={};Array.isArray(e)?e.forEach(function(e,o){r[e]=t?t[o]:o}):r=e||{},l.attribLocations=r}return l}const defaultShaderType=["VERTEX_SHADER","FRAGMENT_SHADER"];function getShaderTypeFromScriptType(e,t){return t.indexOf("frag")>=0?FRAGMENT_SHADER:t.indexOf("vert")>=0?VERTEX_SHADER:void 0}function deleteProgramAndShaders(e,t,r){const o=e.getAttachedShaders(t);for(const t of o)r.has(t)&&e.deleteShader(t);e.deleteProgram(t)}const wait=(e=0)=>new Promise(t=>setTimeout(t,e));function createProgramNoCheck(e,t,r){const o=e.createProgram(),{attribLocations:n,transformFeedbackVaryings:a,transformFeedbackMode:i}=getProgramOptions(r);for(let r=0;r<t.length;++r){let n=t[r];if("string"==typeof n){const t=getElementById(n),a=t?t.text:n;let i=e[defaultShaderType[r]];t&&t.type&&(i=getShaderTypeFromScriptType(e,t.type)||i),n=e.createShader(i),e.shaderSource(n,prepShaderSource(a).shaderSource),e.compileShader(n),e.attachShader(o,n)}}Object.entries(n).forEach(([t,r])=>e.bindAttribLocation(o,r,t));{let t=a;t&&(t.attribs&&(t=t.attribs),Array.isArray(t)||(t=Object.keys(t)),e.transformFeedbackVaryings(o,t,i||SEPARATE_ATTRIBS))}return e.linkProgram(o),o}function createProgram(e,t,r,o,n){const a=getProgramOptions(r,o,n),i=new Set(t),s=createProgramNoCheck(e,t,a);function l(e,t){const r=getProgramErrors(e,t,a.errorCallback);return r&&deleteProgramAndShaders(e,t,i),r}if(!a.callback)return l(e,s)?void 0:s;waitForProgramLinkCompletionAsync(e,s).then(()=>{const t=l(e,s);a.callback(t,t?void 0:s)})}function wrapCallbackFnToAsyncFn(e){return function(t,r,...o){return new Promise((n,a)=>{const i=getProgramOptions(...o);i.callback=(e,t)=>{e?a(e):n(t)},e(t,r,i)})}}const createProgramAsync=wrapCallbackFnToAsyncFn(createProgram),createProgramInfoAsync=wrapCallbackFnToAsyncFn(createProgramInfo);async function waitForProgramLinkCompletionAsync(e,t){const r=e.getExtension("KHR_parallel_shader_compile"),o=r?(e,t)=>e.getProgramParameter(t,r.COMPLETION_STATUS_KHR):()=>!0;let n=0;do{await wait(n),n=1e3/60}while(!o(e,t))}async function waitForAllProgramsLinkCompletionAsync(e,t){for(const r of Object.values(t))await waitForProgramLinkCompletionAsync(e,r)}function getProgramErrors(e,t,r){r=r||error;if(!e.getProgramParameter(t,LINK_STATUS)){const o=e.getProgramInfoLog(t);r(`Error in program linking: ${o}`);return`${o}\n${e.getAttachedShaders(t).map(t=>checkShaderStatus(e,e.getShaderParameter(t,e.SHADER_TYPE),t,r)).filter(e=>e).join("\n")}`}}function createProgramFromScripts(e,t,r,o,n){const a=getProgramOptions(r,o,n),i=[];for(const e of t){const t=getElementById(e);if(!t)return reportError(a,`unknown script element: ${e}`);i.push(t.text)}return createProgram(e,i,a)}function createProgramFromSources(e,t,r,o,n){return createProgram(e,t,r,o,n)}function isBuiltIn(e){const t=e.name;return t.startsWith("gl_")||t.startsWith("webgl_")}const tokenRE=/(\.|\[|]|\w+)/g,isDigit=e=>e>="0"&&e<="9";function addSetterToUniformTree(e,t,r,o){const n=e.split(tokenRE).filter(e=>""!==e);let a=0,i="";for(;;){const e=n[a++];i+=e;const s=isDigit(e[0]),l=s?parseInt(e):e;s&&(i+=n[a++]);if(a===n.length){r[l]=t;break}{const e=n[a++],t="["===e,s=r[l]||(t?[]:{});r[l]=s,r=s,o[i]=o[i]||function(e){return function(t){setUniformTree(e,t)}}(s),i+=e}}}function createUniformSetters(e,t){let r=0;function o(t,o,n){const a=o.name.endsWith("[0]"),i=o.type,s=typeMap[i];if(!s)throw new Error(`unknown type: 0x${i.toString(16)}`);let l;if(s.bindPoint){const t=r;r+=o.size,l=a?s.arraySetter(e,i,t,n,o.size):s.setter(e,i,t,n,o.size)}else l=s.arraySetter&&a?s.arraySetter(e,n):s.setter(e,n);return l.location=n,l}const n={},a={},i=e.getProgramParameter(t,ACTIVE_UNIFORMS);for(let r=0;r<i;++r){const i=e.getActiveUniform(t,r);if(isBuiltIn(i))continue;let s=i.name;s.endsWith("[0]")&&(s=s.substr(0,s.length-3));const l=e.getUniformLocation(t,i.name);if(l){const e=o(0,i,l);n[s]=e,addSetterToUniformTree(s,e,a,n)}}return n}function createTransformFeedbackInfo(e,t){const r={},o=e.getProgramParameter(t,TRANSFORM_FEEDBACK_VARYINGS);for(let n=0;n<o;++n){const o=e.getTransformFeedbackVarying(t,n);r[o.name]={index:n,type:o.type,size:o.size}}return r}function bindTransformFeedbackInfo(e,t,r){t.transformFeedbackInfo&&(t=t.transformFeedbackInfo),r.attribs&&(r=r.attribs);for(const o in r){const n=t[o];if(n){const t=r[o];t.offset?e.bindBufferRange(TRANSFORM_FEEDBACK_BUFFER,n.index,t.buffer,t.offset,t.size):e.bindBufferBase(TRANSFORM_FEEDBACK_BUFFER,n.index,t.buffer)}}}function createTransformFeedback(e,t,r){const o=e.createTransformFeedback();return e.bindTransformFeedback(TRANSFORM_FEEDBACK,o),e.useProgram(t.program),bindTransformFeedbackInfo(e,t,r),e.bindTransformFeedback(TRANSFORM_FEEDBACK,null),o}function createUniformBlockSpecFromProgram(e,t){const r=e.getProgramParameter(t,ACTIVE_UNIFORMS),o=[],n=[];for(let a=0;a<r;++a){n.push(a),o.push({});const r=e.getActiveUniform(t,a);o[a].name=r.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach(function(r){const a=r[0],i=r[1];e.getActiveUniforms(t,n,e[a]).forEach(function(e,t){o[t][i]=e})});const a={},i=e.getProgramParameter(t,ACTIVE_UNIFORM_BLOCKS);for(let r=0;r<i;++r){const o=e.getActiveUniformBlockName(t,r),n={index:e.getUniformBlockIndex(t,o),usedByVertexShader:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),usedByFragmentShader:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),size:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_DATA_SIZE),uniformIndices:e.getActiveUniformBlockParameter(t,r,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES)};n.used=n.usedByVertexShader||n.usedByFragmentShader,a[o]=n}return{blockSpecs:a,uniformData:o}}const arraySuffixRE=/\[\d+\]\.$/,pad=(e,t)=>((e+(t-1))/t|0)*t;function createUniformBlockUniformSetter(e,t,r,o){if(t||r){o=o||1;const t=e.length/4;return function(r){let n=0,a=0;for(let i=0;i<t;++i){for(let t=0;t<o;++t)e[n++]=r[a++];n+=4-o}}}return function(t){t.length?e.set(t):e[0]=t}}function createUniformBlockInfoFromProgram(e,t,r,o){const n=r.blockSpecs,a=r.uniformData,i=n[o];if(!i)return warn("no uniform block object named:",o),{name:o,uniforms:{}};const s=new ArrayBuffer(i.size),l=e.createBuffer(),c=i.index;e.bindBuffer(UNIFORM_BUFFER,l),e.uniformBlockBinding(t,i.index,c);let d=o+".";arraySuffixRE.test(d)&&(d=d.replace(arraySuffixRE,"."));const u={},p={},m={};return i.uniformIndices.forEach(function(e){const t=a[e];let r=t.name;r.startsWith(d)&&(r=r.substr(d.length));const o=r.endsWith("[0]");o&&(r=r.substr(0,r.length-3));const n=typeMap[t.type],i=n.Type,l=o?pad(n.size,16)*t.size:n.size*t.size,c=new i(s,t.offset,l/i.BYTES_PER_ELEMENT);u[r]=c;const f=createUniformBlockUniformSetter(c,o,n.rows,n.cols);p[r]=f,addSetterToUniformTree(r,f,m,p)}),{name:o,array:s,asFloat:new Float32Array(s),buffer:l,uniforms:u,setters:p}}function createUniformBlockInfo(e,t,r){return createUniformBlockInfoFromProgram(e,t.program,t.uniformBlockSpec,r)}function bindUniformBlock(e,t,r){const o=(t.uniformBlockSpec||t).blockSpecs[r.name];if(o){const t=o.index;return e.bindBufferRange(UNIFORM_BUFFER,t,r.buffer,r.offset||0,r.array.byteLength),!0}return!1}function setUniformBlock(e,t,r){bindUniformBlock(e,t,r)&&e.bufferData(UNIFORM_BUFFER,r.array,DYNAMIC_DRAW)}function setBlockUniforms(e,t){const r=e.setters;for(const e in t){const o=r[e];if(o){o(t[e])}}}function setUniformTree(e,t){for(const r in t){const o=e[r];"function"==typeof o?o(t[r]):setUniformTree(e[r],t[r])}}function setUniforms(e,...t){const r=e.uniformSetters||e,o=t.length;for(let e=0;e<o;++e){const o=t[e];if(Array.isArray(o)){const e=o.length;for(let t=0;t<e;++t)setUniforms(r,o[t])}else for(const e in o){const t=r[e];t&&t(o[e])}}}const setUniformsAndBindTextures=setUniforms;function createAttributeSetters(e,t){const r={},o=e.getProgramParameter(t,ACTIVE_ATTRIBUTES);for(let n=0;n<o;++n){const o=e.getActiveAttrib(t,n);if(isBuiltIn(o))continue;const a=e.getAttribLocation(t,o.name),i=attrTypeMap[o.type],s=i.setter(e,a,i);s.location=a,r[o.name]=s}return r}function setAttributes(e,t){for(const r in t){const o=e[r];o&&o(t[r])}}function setBuffersAndAttributes(e,t,r){r.vertexArrayObject?e.bindVertexArray(r.vertexArrayObject):(setAttributes(t.attribSetters||t,r.attribs),r.indices&&e.bindBuffer(ELEMENT_ARRAY_BUFFER$1,r.indices))}function createProgramInfoFromProgram(e,t){const r={program:t,uniformSetters:createUniformSetters(e,t),attribSetters:createAttributeSetters(e,t)};return isWebGL2(e)&&(r.uniformBlockSpec=createUniformBlockSpecFromProgram(e,t),r.transformFeedbackInfo=createTransformFeedbackInfo(e,t)),r}const notIdRE=/\s|{|}|;/;function createProgramInfo(e,t,r,o,n){const a=getProgramOptions(r,o,n),i=[];if(t=t.map(function(e){if(!notIdRE.test(e)){const t=getElementById(e);if(t)e=t.text;else{const t=`no element with id: ${e}`;a.errorCallback(t),i.push(t)}}return e}),i.length)return reportError(a,"");const s=a.callback;s&&(a.callback=(t,r)=>{s(t,t?void 0:createProgramInfoFromProgram(e,r))});const l=createProgramFromSources(e,t,a);return l?createProgramInfoFromProgram(e,l):null}function checkAllPrograms(e,t,r,o,n){for(const[a,i]of Object.entries(t)){const s={...n},l=r[a];Array.isArray(l)||Object.assign(s,l);const c=getProgramErrors(e,i,s.errorCallback);if(c){for(const r of Object.values(t)){const t=e.getAttachedShaders(r);e.deleteProgram(r);for(const r of t)o.has(r)||e.deleteShader(r)}return c}}}function createPrograms(e,t,r={}){const o=new Set,n=Object.fromEntries(Object.entries(t).map(([t,n])=>{const a={...r},i=Array.isArray(n)?n:n.shaders;return Array.isArray(n)||Object.assign(a,n),i.forEach(o.add,o),[t,createProgramNoCheck(e,i,a)]}));if(r.callback)return void waitForAllProgramsLinkCompletionAsync(e,n).then(()=>{const a=checkAllPrograms(e,n,t,o,r);r.callback(a,a?void 0:n)});return checkAllPrograms(e,n,t,o,r)?void 0:n}function createProgramInfos(e,t,r){function o(e,t){return Object.fromEntries(Object.entries(t).map(([t,r])=>[t,createProgramInfoFromProgram(e,r)]))}const n=(r=getProgramOptions(r)).callback;n&&(r.callback=(t,r)=>{n(t,t?void 0:o(e,r))});const a=createPrograms(e,t,r);if(!n&&a)return o(e,a)}const createProgramsAsync=wrapCallbackFnToAsyncFn(createPrograms),createProgramInfosAsync=wrapCallbackFnToAsyncFn(createProgramInfos);var programs=Object.freeze({__proto__:null,createAttributeSetters:createAttributeSetters,createProgram:createProgram,createProgramAsync:createProgramAsync,createPrograms:createPrograms,createProgramsAsync:createProgramsAsync,createProgramFromScripts:createProgramFromScripts,createProgramFromSources:createProgramFromSources,createProgramInfo:createProgramInfo,createProgramInfoAsync:createProgramInfoAsync,createProgramInfos:createProgramInfos,createProgramInfosAsync:createProgramInfosAsync,createProgramInfoFromProgram:createProgramInfoFromProgram,createUniformSetters:createUniformSetters,createUniformBlockSpecFromProgram:createUniformBlockSpecFromProgram,createUniformBlockInfoFromProgram:createUniformBlockInfoFromProgram,createUniformBlockInfo:createUniformBlockInfo,createTransformFeedback:createTransformFeedback,createTransformFeedbackInfo:createTransformFeedbackInfo,bindTransformFeedbackInfo:bindTransformFeedbackInfo,setAttributes:setAttributes,setBuffersAndAttributes:setBuffersAndAttributes,setUniforms:setUniforms,setUniformsAndBindTextures:setUniformsAndBindTextures,setUniformBlock:setUniformBlock,setBlockUniforms:setBlockUniforms,bindUniformBlock:bindUniformBlock});const TRIANGLES=4,UNSIGNED_SHORT=5123;function drawBufferInfo(e,t,r,o,n,a){r=void 0===r?TRIANGLES:r;const i=t.indices,s=t.elementType,l=void 0===o?t.numElements:o;n=void 0===n?0:n,s||i?void 0!==a?e.drawElementsInstanced(r,l,void 0===s?UNSIGNED_SHORT:t.elementType,n,a):e.drawElements(r,l,void 0===s?UNSIGNED_SHORT:t.elementType,n):void 0!==a?e.drawArraysInstanced(r,n,l,a):e.drawArrays(r,n,l)}function drawObjectList(e,t){let r=null,o=null;t.forEach(function(t){if(!1===t.active)return;const n=t.programInfo,a=t.vertexArrayInfo||t.bufferInfo;let i=!1;const s=void 0===t.type?TRIANGLES:t.type;n!==r&&(r=n,e.useProgram(n.program),i=!0),(i||a!==o)&&(o&&o.vertexArrayObject&&!a.vertexArrayObject&&e.bindVertexArray(null),o=a,setBuffersAndAttributes(e,n,a)),setUniforms(n,t.uniforms),drawBufferInfo(e,a,s,t.count,t.offset,t.instanceCount)}),o&&o.vertexArrayObject&&e.bindVertexArray(null)}var draw=Object.freeze({__proto__:null,drawBufferInfo:drawBufferInfo,drawObjectList:drawObjectList});const FRAMEBUFFER=36160,RENDERBUFFER=36161,TEXTURE_2D=3553,UNSIGNED_BYTE=5121,DEPTH_COMPONENT=6402,RGBA=6408,DEPTH_COMPONENT24=33190,DEPTH_COMPONENT32F=36012,DEPTH24_STENCIL8=35056,DEPTH32F_STENCIL8=36013,RGBA4=32854,RGB5_A1=32855,RGB565=36194,DEPTH_COMPONENT16=33189,STENCIL_INDEX=6401,STENCIL_INDEX8=36168,DEPTH_STENCIL=34041,COLOR_ATTACHMENT0=36064,DEPTH_ATTACHMENT=36096,STENCIL_ATTACHMENT=36128,DEPTH_STENCIL_ATTACHMENT=33306,CLAMP_TO_EDGE=33071,LINEAR=9729,defaultAttachments=[{format:RGBA,type:UNSIGNED_BYTE,min:LINEAR,wrap:CLAMP_TO_EDGE},{format:DEPTH_STENCIL}],attachmentsByFormat={};function getAttachmentPointForFormat(e,t){return attachmentsByFormat[e]||attachmentsByFormat[t]}attachmentsByFormat[DEPTH_STENCIL]=DEPTH_STENCIL_ATTACHMENT,attachmentsByFormat[STENCIL_INDEX]=STENCIL_ATTACHMENT,attachmentsByFormat[STENCIL_INDEX8]=STENCIL_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT16]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT24]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH_COMPONENT32F]=DEPTH_ATTACHMENT,attachmentsByFormat[DEPTH24_STENCIL8]=DEPTH_STENCIL_ATTACHMENT,attachmentsByFormat[DEPTH32F_STENCIL8]=DEPTH_STENCIL_ATTACHMENT;const renderbufferFormats={};function isRenderbufferFormat(e){return renderbufferFormats[e]}renderbufferFormats[RGBA4]=!0,renderbufferFormats[RGB5_A1]=!0,renderbufferFormats[RGB565]=!0,renderbufferFormats[DEPTH_STENCIL]=!0,renderbufferFormats[DEPTH_COMPONENT16]=!0,renderbufferFormats[STENCIL_INDEX]=!0,renderbufferFormats[STENCIL_INDEX8]=!0;const MAX_COLOR_ATTACHMENT_POINTS=32;function isColorAttachmentPoint(e){return e>=COLOR_ATTACHMENT0&&e<COLOR_ATTACHMENT0+MAX_COLOR_ATTACHMENT_POINTS}function createFramebufferInfo(e,t,r,o){const n=FRAMEBUFFER,a=e.createFramebuffer();e.bindFramebuffer(n,a),r=r||e.drawingBufferWidth,o=o||e.drawingBufferHeight;const i=[],s={framebuffer:a,attachments:[],width:r,height:o};return(t=t||defaultAttachments).forEach(function(t,a){let l=t.attachment;const c=t.samples,d=t.format;let u=t.attachmentPoint||getAttachmentPointForFormat(d,t.internalFormat);if(u||(u=COLOR_ATTACHMENT0+a),isColorAttachmentPoint(u)&&i.push(u),!l)if(void 0!==c||isRenderbufferFormat(d))l=e.createRenderbuffer(),e.bindRenderbuffer(RENDERBUFFER,l),c>1?e.renderbufferStorageMultisample(RENDERBUFFER,c,d,r,o):e.renderbufferStorage(RENDERBUFFER,d,r,o);else{const n=Object.assign({},t);n.width=r,n.height=o,void 0===n.auto&&(n.auto=!1,n.min=n.min||n.minMag||LINEAR,n.mag=n.mag||n.minMag||LINEAR,n.wrapS=n.wrapS||n.wrap||CLAMP_TO_EDGE,n.wrapT=n.wrapT||n.wrap||CLAMP_TO_EDGE),l=createTexture(e,n)}if(isRenderbuffer(e,l))e.framebufferRenderbuffer(n,u,RENDERBUFFER,l);else{if(!isTexture(e,l))throw new Error("unknown attachment type");void 0!==t.layer?e.framebufferTextureLayer(n,u,l,t.level||0,t.layer):e.framebufferTexture2D(n,u,t.target||TEXTURE_2D,l,t.level||0)}s.attachments.push(l)}),e.drawBuffers&&e.drawBuffers(i),s}function resizeFramebufferInfo(e,t,r,o,n){o=o||e.drawingBufferWidth,n=n||e.drawingBufferHeight,t.width=o,t.height=n,(r=r||defaultAttachments).forEach(function(r,a){const i=t.attachments[a],s=r.format,l=r.samples;if(void 0!==l||isRenderbuffer(e,i))e.bindRenderbuffer(RENDERBUFFER,i),l>1?e.renderbufferStorageMultisample(RENDERBUFFER,l,s,o,n):e.renderbufferStorage(RENDERBUFFER,s,o,n);else{if(!isTexture(e,i))throw new Error("unknown attachment type");resizeTexture(e,i,r,o,n)}})}function bindFramebufferInfo(e,t,r){r=r||FRAMEBUFFER,t?(e.bindFramebuffer(r,t.framebuffer),e.viewport(0,0,t.width,t.height)):(e.bindFramebuffer(r,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight))}var framebuffers=Object.freeze({__proto__:null,bindFramebufferInfo:bindFramebufferInfo,createFramebufferInfo:createFramebufferInfo,resizeFramebufferInfo:resizeFramebufferInfo});const ELEMENT_ARRAY_BUFFER=34963;function createVertexArrayInfo(e,t,r){const o=e.createVertexArray();return e.bindVertexArray(o),t.length||(t=[t]),t.forEach(function(t){setBuffersAndAttributes(e,t,r)}),e.bindVertexArray(null),{numElements:r.numElements,elementType:r.elementType,vertexArrayObject:o}}function createVAOAndSetAttributes(e,t,r,o){const n=e.createVertexArray();return e.bindVertexArray(n),setAttributes(t,r),o&&e.bindBuffer(ELEMENT_ARRAY_BUFFER,o),e.bindVertexArray(null),n}function createVAOFromBufferInfo(e,t,r){return createVAOAndSetAttributes(e,t.attribSetters||t,r.attribs,r.indices)}var vertexArrays=Object.freeze({__proto__:null,createVertexArrayInfo:createVertexArrayInfo,createVAOAndSetAttributes:createVAOAndSetAttributes,createVAOFromBufferInfo:createVAOFromBufferInfo});const defaults={addExtensionsToContext:!0};function setDefaults(e){copyExistingProperties(e,defaults),setDefaults$2(e),setDefaults$1(e)}const prefixRE=/^(.*?)_/;function addExtensionToContext(e,t){glEnumToString(e,0);const r=e.getExtension(t);if(r){const o={},n=prefixRE.exec(t)[1],a="_"+n;for(const t in r){const i=r[t],s="function"==typeof i,l=s?n:a;let c=t;t.endsWith(l)&&(c=t.substring(0,t.length-l.length)),void 0!==e[c]?s||e[c]===i||warn$1(c,e[c],i,t):s?e[c]=function(e){return function(){return e.apply(r,arguments)}}(i):(e[c]=i,o[c]=i)}o.constructor={name:r.constructor.name},glEnumToString(o,0)}return r}const supportedExtensions=["ANGLE_instanced_arrays","EXT_blend_minmax","EXT_color_buffer_float","EXT_color_buffer_half_float","EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2","EXT_frag_depth","EXT_sRGB","EXT_shader_texture_lod","EXT_texture_filter_anisotropic","OES_element_index_uint","OES_standard_derivatives","OES_texture_float","OES_texture_float_linear","OES_texture_half_float","OES_texture_half_float_linear","OES_vertex_array_object","WEBGL_color_buffer_float","WEBGL_compressed_texture_atc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb","WEBGL_depth_texture","WEBGL_draw_buffers"];function addExtensionsToContext(e){for(let t=0;t<supportedExtensions.length;++t)addExtensionToContext(e,supportedExtensions[t])}function create3DContext(e,t){const r=["webgl","experimental-webgl"];let o=null;for(let n=0;n<r.length;++n)if(o=e.getContext(r[n],t),o){defaults.addExtensionsToContext&&addExtensionsToContext(o);break}return o}function getWebGLContext(e,t){return create3DContext(e,t)}function createContext(e,t){const r=["webgl2","webgl","experimental-webgl"];let o=null;for(let n=0;n<r.length;++n)if(o=e.getContext(r[n],t),o){defaults.addExtensionsToContext&&addExtensionsToContext(o);break}return o}function getContext(e,t){return createContext(e,t)}function resizeCanvasToDisplaySize(e,t){t=t||1,t=Math.max(0,t);const r=e.clientWidth*t|0,o=e.clientHeight*t|0;return(e.width!==r||e.height!==o)&&(e.width=r,e.height=o,!0)}var twgl_module=Object.freeze({__proto__:null,addExtensionsToContext:addExtensionsToContext,attributes:attributes,bindFramebufferInfo:bindFramebufferInfo,bindTransformFeedbackInfo:bindTransformFeedbackInfo,bindUniformBlock:bindUniformBlock,canFilter:canFilter,canGenerateMipmap:canGenerateMipmap,createAttribsFromArrays:createAttribsFromArrays,createAttributeSetters:createAttributeSetters,createBufferFromArray:createBufferFromArray,createBufferFromTypedArray:createBufferFromTypedArray,createBufferInfoFromArrays:createBufferInfoFromArrays,createBuffersFromArrays:createBuffersFromArrays,createFramebufferInfo:createFramebufferInfo,createProgram:createProgram,createProgramAsync:createProgramAsync,createProgramFromScripts:createProgramFromScripts,createProgramFromSources:createProgramFromSources,createProgramInfo:createProgramInfo,createProgramInfoAsync:createProgramInfoAsync,createProgramInfoFromProgram:createProgramInfoFromProgram,createProgramInfos:createProgramInfos,createProgramInfosAsync:createProgramInfosAsync,createPrograms:createPrograms,createProgramsAsync:createProgramsAsync,createSampler:createSampler,createSamplers:createSamplers,createTexture:createTexture,createTextures:createTextures,createTransformFeedback:createTransformFeedback,createTransformFeedbackInfo:createTransformFeedbackInfo,createUniformBlockInfo:createUniformBlockInfo,createUniformBlockInfoFromProgram:createUniformBlockInfoFromProgram,createUniformBlockSpecFromProgram:createUniformBlockSpecFromProgram,createUniformSetters:createUniformSetters,createVAOAndSetAttributes:createVAOAndSetAttributes,createVAOFromBufferInfo:createVAOFromBufferInfo,createVertexArrayInfo:createVertexArrayInfo,draw:draw,drawBufferInfo:drawBufferInfo,drawObjectList:drawObjectList,framebuffers:framebuffers,getArray_:getArray,getBytesPerElementForInternalFormat:getBytesPerElementForInternalFormat,getContext:getContext,getFormatAndTypeForInternalFormat:getFormatAndTypeForInternalFormat,getGLTypeForTypedArray:getGLTypeForTypedArray,getGLTypeForTypedArrayType:getGLTypeForTypedArrayType,getNumComponentsForFormat:getNumComponentsForFormat,getNumComponents_:getNumComponents,getTypedArrayTypeForGLType:getTypedArrayTypeForGLType,getWebGLContext:getWebGLContext,glEnumToString:glEnumToString,isArrayBuffer:isArrayBuffer$1,isWebGL1:isWebGL1,isWebGL2:isWebGL2,loadTextureFromUrl:loadTextureFromUrl,programs:programs,resizeCanvasToDisplaySize:resizeCanvasToDisplaySize,resizeFramebufferInfo:resizeFramebufferInfo,resizeTexture:resizeTexture,setAttribInfoBufferFromArray:setAttribInfoBufferFromArray,setAttributeDefaults_:setDefaults$2,setAttributePrefix:setAttributePrefix,setAttributes:setAttributes,setBlockUniforms:setBlockUniforms,setBuffersAndAttributes:setBuffersAndAttributes,setDefaultTextureColor:setDefaultTextureColor,setDefaults:setDefaults,setEmptyTexture:setEmptyTexture,setSamplerParameters:setSamplerParameters,setTextureDefaults_:setDefaults$1,setTextureFilteringForSize:setTextureFilteringForSize,setTextureFromArray:setTextureFromArray,setTextureFromElement:setTextureFromElement,setTextureParameters:setTextureParameters,setUniformBlock:setUniformBlock,setUniforms:setUniforms,setUniformsAndBindTextures:setUniformsAndBindTextures,textures:textures,typedarrays:typedarrays,utils:utils,vertexArrays:vertexArrays});function earcut(e,t,r=2){const o=t&&t.length,n=o?t[0]*r:e.length;let a=linkedList(e,0,n,r,!0);const i=[];if(!a||a.next===a.prev)return i;let s,l,c;if(o&&(a=eliminateHoles(e,t,a,r)),e.length>80*r){s=e[0],l=e[1];let t=s,o=l;for(let a=r;a<n;a+=r){const r=e[a],n=e[a+1];r<s&&(s=r),n<l&&(l=n),r>t&&(t=r),n>o&&(o=n)}c=Math.max(t-s,o-l),c=0!==c?32767/c:0}return earcutLinked(a,i,r,s,l,c,0),i}function linkedList(e,t,r,o,n){let a;if(n===signedArea(e,t,r,o)>0)for(let n=t;n<r;n+=o)a=insertNode(n/o|0,e[n],e[n+1],a);else for(let n=r-o;n>=t;n-=o)a=insertNode(n/o|0,e[n],e[n+1],a);return a&&equals(a,a.next)&&(removeNode(a),a=a.next),a}function filterPoints(e,t){if(!e)return e;t||(t=e);let r,o=e;do{if(r=!1,o.steiner||!equals(o,o.next)&&0!==area(o.prev,o,o.next))o=o.next;else{if(removeNode(o),o=t=o.prev,o===o.next)break;r=!0}}while(r||o!==t);return t}function earcutLinked(e,t,r,o,n,a,i){if(!e)return;!i&&a&&indexCurve(e,o,n,a);let s=e;for(;e.prev!==e.next;){const l=e.prev,c=e.next;if(a?isEarHashed(e,o,n,a):isEar(e))t.push(l.i,e.i,c.i),removeNode(e),e=c.next,s=c.next;else if((e=c)===s){i?1===i?earcutLinked(e=cureLocalIntersections(filterPoints(e),t),t,r,o,n,a,2):2===i&&splitEarcut(e,t,r,o,n,a):earcutLinked(filterPoints(e),t,r,o,n,a,1);break}}}function isEar(e){const t=e.prev,r=e,o=e.next;if(area(t,r,o)>=0)return!1;const n=t.x,a=r.x,i=o.x,s=t.y,l=r.y,c=o.y,d=Math.min(n,a,i),u=Math.min(s,l,c),p=Math.max(n,a,i),m=Math.max(s,l,c);let f=o.next;for(;f!==t;){if(f.x>=d&&f.x<=p&&f.y>=u&&f.y<=m&&pointInTriangleExceptFirst(n,s,a,l,i,c,f.x,f.y)&&area(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function isEarHashed(e,t,r,o){const n=e.prev,a=e,i=e.next;if(area(n,a,i)>=0)return!1;const s=n.x,l=a.x,c=i.x,d=n.y,u=a.y,p=i.y,m=Math.min(s,l,c),f=Math.min(d,u,p),g=Math.max(s,l,c),y=Math.max(d,u,p),h=zOrder(m,f,t,r,o),_=zOrder(g,y,t,r,o);let x=e.prevZ,A=e.nextZ;for(;x&&x.z>=h&&A&&A.z<=_;){if(x.x>=m&&x.x<=g&&x.y>=f&&x.y<=y&&x!==n&&x!==i&&pointInTriangleExceptFirst(s,d,l,u,c,p,x.x,x.y)&&area(x.prev,x,x.next)>=0)return!1;if(x=x.prevZ,A.x>=m&&A.x<=g&&A.y>=f&&A.y<=y&&A!==n&&A!==i&&pointInTriangleExceptFirst(s,d,l,u,c,p,A.x,A.y)&&area(A.prev,A,A.next)>=0)return!1;A=A.nextZ}for(;x&&x.z>=h;){if(x.x>=m&&x.x<=g&&x.y>=f&&x.y<=y&&x!==n&&x!==i&&pointInTriangleExceptFirst(s,d,l,u,c,p,x.x,x.y)&&area(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;A&&A.z<=_;){if(A.x>=m&&A.x<=g&&A.y>=f&&A.y<=y&&A!==n&&A!==i&&pointInTriangleExceptFirst(s,d,l,u,c,p,A.x,A.y)&&area(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function cureLocalIntersections(e,t){let r=e;do{const o=r.prev,n=r.next.next;!equals(o,n)&&intersects(o,r,r.next,n)&&locallyInside(o,n)&&locallyInside(n,o)&&(t.push(o.i,r.i,n.i),removeNode(r),removeNode(r.next),r=e=n),r=r.next}while(r!==e);return filterPoints(r)}function splitEarcut(e,t,r,o,n,a){let i=e;do{let e=i.next.next;for(;e!==i.prev;){if(i.i!==e.i&&isValidDiagonal(i,e)){let s=splitPolygon(i,e);return i=filterPoints(i,i.next),s=filterPoints(s,s.next),earcutLinked(i,t,r,o,n,a,0),void earcutLinked(s,t,r,o,n,a,0)}e=e.next}i=i.next}while(i!==e)}function eliminateHoles(e,t,r,o){const n=[];for(let r=0,a=t.length;r<a;r++){const i=linkedList(e,t[r]*o,r<a-1?t[r+1]*o:e.length,o,!1);i===i.next&&(i.steiner=!0),n.push(getLeftmost(i))}n.sort(compareXYSlope);for(let e=0;e<n.length;e++)r=eliminateHole(n[e],r);return r}function compareXYSlope(e,t){let r=e.x-t.x;if(0===r&&(r=e.y-t.y,0===r)){r=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)}return r}function eliminateHole(e,t){const r=findHoleBridge(e,t);if(!r)return t;const o=splitPolygon(r,e);return filterPoints(o,o.next),filterPoints(r,r.next)}function findHoleBridge(e,t){let r=t;const o=e.x,n=e.y;let a,i=-1/0;if(equals(e,r))return r;do{if(equals(e,r.next))return r.next;if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){const e=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=o&&e>i&&(i=e,a=r.x<r.next.x?r:r.next,e===o))return a}r=r.next}while(r!==t);if(!a)return null;const s=a,l=a.x,c=a.y;let d=1/0;r=a;do{if(o>=r.x&&r.x>=l&&o!==r.x&&pointInTriangle(n<c?o:i,n,l,c,n<c?i:o,n,r.x,r.y)){const t=Math.abs(n-r.y)/(o-r.x);locallyInside(r,e)&&(t<d||t===d&&(r.x>a.x||r.x===a.x&&sectorContainsSector(a,r)))&&(a=r,d=t)}r=r.next}while(r!==s);return a}function sectorContainsSector(e,t){return area(e.prev,e,t.prev)<0&&area(t.next,e,e.next)<0}function indexCurve(e,t,r,o){let n=e;do{0===n.z&&(n.z=zOrder(n.x,n.y,t,r,o)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,sortLinked(n)}function sortLinked(e){let t,r=1;do{let o,n=e;e=null;let a=null;for(t=0;n;){t++;let i=n,s=0;for(let e=0;e<r&&(s++,i=i.nextZ,i);e++);let l=r;for(;s>0||l>0&&i;)0!==s&&(0===l||!i||n.z<=i.z)?(o=n,n=n.nextZ,s--):(o=i,i=i.nextZ,l--),a?a.nextZ=o:e=o,o.prevZ=a,a=o;n=i}a.nextZ=null,r*=2}while(t>1);return e}function zOrder(e,t,r,o,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-o)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){let t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function pointInTriangle(e,t,r,o,n,a,i,s){return(n-i)*(t-s)>=(e-i)*(a-s)&&(e-i)*(o-s)>=(r-i)*(t-s)&&(r-i)*(a-s)>=(n-i)*(o-s)}function pointInTriangleExceptFirst(e,t,r,o,n,a,i,s){return!(e===i&&t===s)&&pointInTriangle(e,t,r,o,n,a,i,s)}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area(e.prev,e,t.prev)||area(e,t.prev,t))||equals(e,t)&&area(e.prev,e,e.next)>0&&area(t.prev,t,t.next)>0)}function area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,r,o){const n=sign(area(e,t,r)),a=sign(area(e,t,o)),i=sign(area(r,o,e)),s=sign(area(r,o,t));return n!==a&&i!==s||(!(0!==n||!onSegment(e,r,t))||(!(0!==a||!onSegment(e,o,t))||(!(0!==i||!onSegment(r,e,o))||!(0!==s||!onSegment(r,t,o)))))}function onSegment(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){let r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?area(e,t,e.next)>=0&&area(e,e.prev,t)>=0:area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){let r=e,o=!1;const n=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&n<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(o=!o),r=r.next}while(r!==e);return o}function splitPolygon(e,t){const r=createNode(e.i,e.x,e.y),o=createNode(t.i,t.x,t.y),n=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=n,n.prev=r,o.next=r,r.prev=o,a.next=o,o.prev=a,o}function insertNode(e,t,r,o){const n=createNode(e,t,r);return o?(n.next=o.next,n.prev=o,o.next.prev=n,o.next=n):(n.prev=n,n.next=n),n}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function createNode(e,t,r){return{i:e,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function signedArea(e,t,r,o){let n=0;for(let a=t,i=r-o;a<r;a+=o)n+=(e[i]-e[a])*(e[a+1]+e[i+1]),i=a;return n}var earcut$1=Object.freeze({__proto__:null,default:earcut});const _handlers=[(e,t)=>{},(e,t,r,o,n,a)=>t.fillRect(r,o,n,a),(e,t,r,o,n,a)=>t.strokeRect(r,o,n,a),(e,t)=>t.beginPath(),(e,t)=>t.closePath(),(e,t,r,o)=>t.moveTo(r,o),(e,t,r,o)=>t.lineTo(r,o),(e,t)=>t.fill(),(e,t,r,o,n,a)=>t.rect(r,o,n,a),(e,t)=>t.stroke(),(e,t,r,o,n,a,i,s)=>t.arc(r,o,n,a,i,!s),(e,t,r,o,n,a)=>t.quadraticCurveTo(r,o,n,a),(e,t,r,o,n,a,i,s)=>t.bezierCurveTo(r,o,n,a,i,s),(e,t,r,o,n)=>t.fillText(r,o,n),(e,t,r,o,n)=>t.strokeText(r,o,n),null,(e,t,r)=>{t.fillStyle=r},(e,t,r)=>{t.strokeStyle=r},(e,t,r)=>{t.lineWidth=r},(e,t,r)=>{t.lineCap=r},(e,t,r)=>{t.lineJoin=r},(e,t,r)=>{t.miterLimit=r},(e,t,r)=>{t.font=r},(e,t)=>{t.save()},(e,t)=>{t.restore()},(e,t,r,o)=>{t.translate(r,o)},(e,t,r)=>{t.rotate(r)},(e,t,r,o)=>{t.scale(r,o)},(e,t)=>{t.clip()},(e,t,r)=>{t.globalAlpha=r},(e,t,r)=>{t.textAlign=r},(e,t,r)=>{t.textBaseline=r},(e,t,...r)=>{t.setLineDash(r)},(e,t,r)=>{t.lineDashOffset=r},(e,t,r,o,n,a)=>{t.clearRect(r,o,n,a)},(e,t,r,o,n,a,i)=>{t.arcTo(r,o,n,a,i)},(e,t,r,o,n,a,i)=>{t.roundRect(r,o,n,a,i)},(e,t,r,o,n,a,i,s)=>{t.transform(r,o,n,a,i,s)},(e,t,r,o,n,a,i,s)=>{t.setTransform(r,o,n,a,i,s)},(e,t)=>{t.resetTransform()},(e,t,r)=>{t.globalCompositeOperation=r},(e,t,r)=>{t.filter=r},(e,t,r)=>{t.imageSmoothingEnabled=!!r},(e,t,r)=>{t.imageSmoothingQuality=r},(e,t,r)=>{t.shadowOffsetX=r},(e,t,r)=>{t.shadowOffsetY=r},(e,t,r)=>{t.shadowBlur=r},(e,t,r)=>{t.shadowColor=r},(e,t,r,o,n,a,i,s,l)=>{e.set(l,t.createLinearGradient(r,o,n,a))},(e,t,r,o,n,a,i,s,l)=>{e.set(l,t.createRadialGradient(r,o,n,a,i,s))},(e,t,r,o,n,a,i,s,l)=>{e.set(l,t.createConicGradient(r,o,n))},(e,t,r,o,n)=>{e.get(r).addColorStop(o,n)},(e,t,r)=>{t.fillStyle=e.get(r)},(e,t,r)=>{t.strokeStyle=e.get(r)},(e,t,r,o,n,a,i)=>{if(!loadedImages.has(r))return loadImage(r);t.drawImage(loadedImages.get(r).img,o,n,a,i)}];var loadedImages=new Map;async function loadImage(e){const t={global:{stack:{}},offscreen:!0};console.warn("Requested image");const r=await interpretate(["FrontEndExecutable","'"+e+"'"],t),o=await createImageBitmap(r);r.remove(),t.img=o,loadedImages.set(e,t)}async function runOptcodes(e,t,r){let o=(t instanceof NumericArrayObject?t.buffer:t).flat(),n=0;for(let t=0,a=o.length;t<a;t+=7){const a=o[t],i=o[t+1],s=o[t+2],l=o[t+3],c=o[t+4],d=o[t+5],u=o[t+6];if(0==a)break;const p=_handlers[a],m=p(r,e,i,s,l,c,d,u,n);m&&(await m,p(r,e,i,s,l,c,d,u,n)),n++}}var canvas2d=Object.freeze({__proto__:null,runOptcodes:runOptcodes});
